<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡å­æŠ¤å«é˜Ÿï¼šå››æ–¹æˆ˜çºª | Quant Guardians</title>
    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- å¼•å…¥ Ali-OSS SDK -->
    <script src="https://gosspublic.alicdn.com/aliyun-oss-sdk-6.18.0.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        :root {
            --bg-color: #050510;
            --panel-bg: #111122;
            --text-main: #e0e0e0;
            --genbu-color: #10B981;
            --suzaku-color: #EF4444;
            --sirius-color: #8B5CF6;
            --kirin-color: #3B82F6;
            --user-gold: #FFD700;
        }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Roboto Mono', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1, .pixel-font { font-family: 'Press Start 2P', cursive; text-transform: uppercase; }
        
        /* --- Header --- */
        .header { 
            text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; 
            width: 100%; max-width: 1400px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .container { max-width: 1400px; width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 20px; }
        
        /* --- å¡ç‰‡æ ·å¼ --- */
        .guardian-card { background: var(--panel-bg); border: 2px solid #444; padding: 15px; border-radius: 4px; display: flex; flex-direction: column; transition: all 0.3s; box-shadow: 0 0 10px rgba(0,0,0,0.5); min-height: 800px; transition: all 0.3s ease; }
        .guardian-card.active { border-color: var(--glow-color); box-shadow: 0 0 20px var(--glow-color); }
        .g-genbu { --glow-color: var(--genbu-color); }
        .g-suzaku { --glow-color: var(--suzaku-color); }
        .g-sirius { --glow-color: var(--sirius-color); }
        .g-kirin { --glow-color: var(--kirin-color); }
        
        .card-header { display: flex; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        .avatar { font-size: 2.5em; margin-right: 15px; text-shadow: 0 0 10px var(--glow-color); }
        .role-info h2 { margin: 0; font-size: 1.2em; color: var(--glow-color); }
        .role-desc { font-size: 0.6em; color: #888; }
        
        .main-stat-box { background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; text-align: center; margin-bottom: 10px; }
        .stat-group { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; }
        .stat-label { font-size: 0.6em; color: #aaa; text-transform: uppercase; }
        /* å¢åŠ  text-up/text-down æ ·å¼æ”¯æŒ */
        .stat-value { font-size: 1.2em; font-weight: bold; color: #fff; }
        
        .user-stat { color: var(--user-gold); text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
        .sub-stat { font-size: 0.7em; color: #fff; margin-top: 5px; border-top: 1px dashed #333; padding-top: 5px; font-weight: bold;}
        
        /* --- åˆ—è¡¨åŒºåŸŸ --- */
        .list-header { font-size: 0.6em; color: #888; margin-top: 5px; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; }
        .holdings-list { flex-grow: 1; overflow-y: auto; border: 1px dashed #333; background: rgba(0,0,0,0.2); padding: 5px; height: 200px; margin-bottom: 10px; }
        .portfolio-list { height: 200px; border: 1px solid #444; background: #000; }

        /* --- åˆ—è¡¨é¡¹ --- */
        .holding-item { 
            display: grid; grid-template-columns: 1.4fr 0.8fr 1fr; 
            background: #1a1a2e; margin-bottom: 4px; padding: 6px; 
            border-left: 3px solid #444; cursor: pointer; transition: background 0.2s; 
            align-items: center; user-select: none; 
        }
        .holding-item:hover { background: #252540; }
        .holding-item.selected { background: #303050; border-left-color: #fff; }
        .holding-item.is-cash { border-left-color: var(--user-gold); background: #1a1a10; }

        .h-info { display: flex; flex-direction: column; justify-content: center; }
        .h-name { font-weight: bold; font-size: 0.8em; color: #ddd; display: block; margin-bottom: 2px;} 
        .h-weight-row { display: flex; align-items: center; font-size: 0.7em; }
        .h-weight { color: #aaa; margin-right: 8px; }
        .user-weight-display { color: var(--user-gold); font-weight: bold; }
        .h-price-col { text-align: right; display: flex; flex-direction: column; justify-content: center; padding-right: 5px;}
        .h-price { font-size: 0.8em; font-weight: bold; }
        .h-pct { font-size: 0.65em; }
        .text-up { color: #EF4444; }
        .text-down { color: #10B981; }
        
        .mini-chart-container { position: relative; width: 100%; height: 30px; cursor: crosshair; }
        .mini-chart-container:hover { border: 1px solid #666; }
        canvas.sparkline { width: 100%; height: 100%; }

        /* --- Commander Section --- */
        .commander-section { margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; }
        /*.cmd-row { margin-bottom: 8px; }*/
        /* --- ç»Ÿä¸€çºµå‘é—´è· --- */
        .cmd-row { 
            margin-bottom: 10px;  /* å›ºå®šçš„è¡Œé—´è·ï¼Œç¡®ä¿ Buy/Sell/ADHOC è·ç¦»ä¸€è‡´ */
        }
        .cmd-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .cmd-label { font-size: 0.6em; color: var(--glow-color); font-weight: bold; }
        .cmd-label-sell { color: var(--glow-color); }
        .calc-res { font-size: 0.6em; color: var(--user-gold); }
        
        .cmd-controls { display: flex; gap: 4px; width: 100%; align-items: center; }
        .cmd-input { background: #000; border: 1px solid #555; color: #fff; font-family: 'Roboto Mono'; padding: 4px; font-size: 0.7em; height: 26px; }
        /*.input-price { flex: 1; min-width: 0; }*/
        /* --- ä»·æ ¼/åç§°è¾“å…¥æ¡†è‡ªåŠ¨ä¼¸ç¼© --- */
        .input-price { 
            flex: 1;              /* å æ®å‰©ä½™çš„æ‰€æœ‰ç©ºé—´ */
            min-width: 0;         /* å…³é”®ï¼šé˜²æ­¢åœ¨ Flex å¸ƒå±€ä¸­æ’‘ç ´å®¹å™¨ */
        }
        /*.input-weight { width: 60px; flex: 0 0 60px; color: var(--user-gold); text-align: center; }*/
        /* --- æ¯”ä¾‹è¾“å…¥æ¡†é•¿åº¦å›ºå®š --- */
        .input-weight { 
            width: 60px; 
            flex: 0 0 60px;       /* ç¦æ­¢ç¼©æ”¾ï¼Œä¿æŒ 60px */
            color: var(--user-gold); 
            text-align: center; 
        }
        /*.cmd-btn { cursor: pointer; font-family: 'Press Start 2P'; font-size: 0.5em; padding: 0 8px; height: 26px; white-space: nowrap; flex: 0 0 auto; border: 1px solid #555; background: #222; color: #fff;}*/
        /* --- ç»Ÿä¸€æŒ‰é’®é•¿åº¦ï¼Œå¹¶å¢åŠ ç§»åŠ¨ç«¯ç¨³å®šæ€§ --- */
        .cmd-btn { 
            cursor: pointer; 
            font-family: 'Press Start 2P'; 
            font-size: 0.5em; 
            /* å…³é”®ä¿®æ”¹ï¼šé”å®šå®½åº¦ï¼Œé˜²æ­¢å› å­—ç¬¦å¤šå°‘è€Œä¼¸ç¼© */
            width: 85px !important;          
            flex: 0 0 85px !important;       
            min-width: 85px !important;
            height: 26px; 
            white-space: nowrap; 
            border: 1px solid #555; 
            background: #222; 
            color: #fff;
            padding: 0;           /* æ¸…é™¤å†…è¾¹è·ï¼Œç¡®ä¿æ–‡å­—å±…ä¸­ */
            text-align: center;
            box-sizing: border-box; /* ç¡®ä¿è¾¹æ¡†è®¡ç®—åœ¨å®½åº¦å†… */
        }
        .cmd-btn.buy-btn { border-color: var(--glow-color); color: var(--glow-color); }
        .cmd-btn.sell-btn { border-color: var(--glow-color); color: var(--glow-color); }
        .cmd-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #444; color: #666; }

        /*.cmd-msg { height: 15px; font-size: 0.6em; margin-top: 2px; color: #ffff00; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;}*/
        /* --- æ¶ˆæ¯æç¤ºæ¡†ï¼šä¸å¹²æ‰°å¸ƒå±€ --- */
        .cmd-msg { 
            height: 15px; 
            font-size: 0.6em; 
            margin-top: -5px;     /* ç¨å¾®å¾€ä¸Šé ï¼Œä¸å ä½ */
            margin-bottom: 10px;  /* ç•™å‡ºä¸‹æ–¹é—´è· */
            color: #ffff00; 
            text-align: left;
        }

        /* --- System Controls --- */
        .settlement-panel { width: 100%; max-width: 1400px; background: var(--panel-bg); border: 2px solid #555; padding: 20px; margin-bottom: 20px; display: none; /* åˆå§‹éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */ }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .system-controls { margin-top: 10px; text-align: center; width: 100%; max-width: 800px; }
        .start-btn { background: #000; color: #0f0; border: 2px solid #0f0; padding: 15px 40px; font-family: 'Press Start 2P'; font-size: 1.2em; cursor: pointer; box-shadow: 0 0 10px #0f0; margin-bottom: 10px; }
        .log-box { background: #000; border: 1px solid #333; height: 100px; overflow-y: scroll; text-align: left; padding: 10px; font-size: 0.75em; color: #0f0; }
        .log-line { border-bottom: 1px solid #111; padding: 2px 0; }
        
        .oss-btn {
            position: absolute; right: 0; top: 20px; background: #224; color: #fff; border: 1px solid #66a;
            padding: 8px 12px; cursor: pointer; font-family: 'Press Start 2P'; font-size: 10px; 
            display: flex; align-items: center; gap: 6px; border-radius: 4px;
        }
        .oss-status { width: 6px; height: 6px; border-radius: 50%; background: #666; display: inline-block;}
        .oss-status.syncing { background: #ff0; box-shadow: 0 0 5px #ff0; animation: blink 1s infinite; }
        .oss-status.done { background: #0f0; box-shadow: 0 0 5px #0f0; }
        @keyframes blink { 50% { opacity: 0.5; } }

        @media (max-width: 768px) {
            .header { position: static; padding-top: 10px; }
            .oss-btn { position: relative; right: auto; top: auto; margin-top: 15px; width: auto; }
        }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }

        /* --- [æ–°å¢] åŠ¨æ€æ›²çº¿ Modal æ ·å¼ --- */
        .modal-overlay {
            display: none; /* é»˜è®¤éšè— */
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: #111;
            border: 2px solid #fff; /* JSä¼šåŠ¨æ€ä¿®æ”¹é¢œè‰² */
            padding: 20px;
            width: 90%;
            max-width: 900px;
            height: 60vh;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .close-btn {
            background: #333;
            border: 1px solid #555;
            color: #fff;
            padding: 8px 16px;
            cursor: pointer;
            font-family: 'Roboto Mono';
            font-weight: bold;
        }
        .close-btn:hover { background: #444; }
        .detail-chart-wrapper {
            flex-grow: 1;
            position: relative;
            width: 100%;
        }

        /* --- ADHOC æœç´¢å»ºè®®æ ·å¼ --- */
        .adhoc-results-container {
            position: relative;            
            /* ä¸è¦åœ¨è¿™é‡ŒåŠ  width: 100%ï¼Œå› ä¸ºå®ƒå·²ç»åœ¨ cmd-controls é‡Œçš„ flex æµä¸­äº† */
        }
       .suggestions-list-container {
            position: absolute;
            top: calc(100% + 2px);        /* ç¨å¾®æ‹‰å¼€ä¸€ç‚¹è·ç¦»ï¼Œé¿å…ç´§è´´ */
            left: 0;
            width: 100%;                  /* è·Ÿéšè¾“å…¥æ¡†å®½åº¦ */
            z-index: 1000;                /* æé«˜å±‚çº§ï¼Œé¿å…è¢«å…¶ä»–å…ƒç´ é®æŒ¡ */
            background: #111;
            border: 1px solid #555;
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.8);
            max-height: 200px;
            overflow-y: auto;
            display: block;               /* ç¡®ä¿å¯è§ */
        }
        
        .suggestions-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .suggestions-list li {
            padding: 8px 12px;
            font-size: 0.7em;
            cursor: pointer;
            border-bottom: 1px solid #222;
            color: #e0e0e0;
        }
        
        .suggestions-list li:hover {
            background: #333;
            color: var(--user-gold);
        }
                
        /* --- åˆ é™¤æŒ‰é’®æ ·å¼ --- */
        .delete-btn {
            color: #ffff00;
            cursor: pointer;
            margin-left: 5px;
            font-size: 1.2em;
            font-weight: bold;
            line-height: 1;
            vertical-align: middle;
            display: inline-block;
            transition: transform 0.2s;
        }
        .delete-btn:hover {
            transform: scale(1.3);
            color: #FFD700;
        }
        .h-name-wrapper {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Quant Guardians</h1>
        <div class="pixel-font" style="font-size: 0.7em; color: #666; margin-top:5px;">Real-time Battle System v2.0</div>
        <button class="oss-btn" onclick="syncToCloud()">
            <span class="oss-status" id="ossStatusDot"></span> SYNC CLOUD
        </button>
    </div>

    <div class="container">
        <!-- GENBU -->
        <div class="guardian-card g-genbu" id="card-genbu">
            <div class="card-header"><div class="avatar">ğŸ›¡ï¸</div><div class="role-info"><h2 class="pixel-font">GENBU</h2><div class="role-desc">LowVol (ä½æ³¢)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-genbu">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-genbu">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-genbu">0%</span></div>
            </div>
            
            <div class="list-header">STRATEGY SUGGESTIONS</div>
            <div class="holdings-list" id="list-genbu"></div>
            
            <div class="commander-section">
                <!-- BUY -->
                <div class="cmd-row">
                    <div class="cmd-top-row"><span class="cmd-label">Buy COMMANDER:</span><span class="calc-res" id="calc-buy-genbu"></span></div>
                    <div class="cmd-controls">
                        <input type="number" class="cmd-input input-price" id="buy-price-genbu" placeholder="Price" oninput="calcQty('genbu', 'buy')">
                        <input type="number" class="cmd-input input-weight" id="buy-weight-genbu" placeholder="%" oninput="calcQty('genbu', 'buy')">
                        <button class="cmd-btn buy-btn" id="btn-buy-genbu" onclick="executeOrder('genbu', 'buy')">CONFIRM</button>
                    </div>
                </div>
                <!-- SELL -->
                <div class="cmd-row">
                    <div class="cmd-top-row"><span class="cmd-label cmd-label-sell">Sell COMMANDER:</span><span class="calc-res" id="calc-sell-genbu"></span></div>
                    <div class="cmd-controls">
                        <input type="number" class="cmd-input input-price" id="sell-price-genbu" placeholder="Price" oninput="calcQty('genbu', 'sell')">
                        <input type="number" class="cmd-input input-weight" id="sell-weight-genbu" placeholder="%" oninput="calcQty('genbu', 'sell')">
                        <button class="cmd-btn sell-btn" id="btn-sell-genbu" onclick="executeOrder('genbu', 'sell')">CONFIRM</button>
                    </div>
                </div>     
                <!-- ADHOC GENBU-->
                <div class="cmd-row">
                    <div class="cmd-top-row"><span class="cmd-label">ADHOC COMMANDER:</span></div>
                    <div class="cmd-controls adhoc-results-container">
                        <input type="text" class="cmd-input input-price" id="adhoc-search-genbu" placeholder="Name/Code">
                        <input type="number" class="cmd-input input-weight" id="adhoc-weight-genbu" placeholder="%" step="0.1">
                        <button class="cmd-btn buy-btn" onclick="addNewAdhoc('genbu')">ADHOC</button>
                        <div id="suggestions-genbu" class="suggestions-list-container"></div>
                    </div>
                </div>
                
                <div class="cmd-msg" id="msg-genbu"></div>
            </div>

            <div class="list-header">PORTFOLIO HOLDINGS</div>
            <div class="holdings-list portfolio-list" id="portfolio-genbu"></div>
        </div>

        <!-- SUZAKU -->
        <div class="guardian-card g-suzaku" id="card-suzaku">
            <div class="card-header"><div class="avatar">ğŸ”¥</div><div class="role-info"><h2 class="pixel-font">SUZAKU</h2><div class="role-desc">DaCheng (å¤§æˆ)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-suzaku">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-suzaku">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-suzaku">0%</span></div>
            </div>
            <div class="list-header">STRATEGY SUGGESTIONS</div>
            <div class="holdings-list" id="list-suzaku"></div>
            <div class="commander-section">
                <div class="cmd-row">
                    <div class="cmd-top-row"><span class="cmd-label">Buy COMMANDER:</span><span class="calc-res" id="calc-buy-suzaku"></span></div>
                    <div class="cmd-controls">
                        <input type="number" class="cmd-input input-price" id="buy-price-suzaku" placeholder="Price" oninput="calcQty('suzaku', 'buy')">
                        <input type="number" class="cmd-input input-weight" id="buy-weight-suzaku" placeholder="%" oninput="calcQty('suzaku', 'buy')">
                        <button class="cmd-btn buy-btn" id="btn-buy-suzaku" onclick="executeOrder('suzaku', 'buy')">CONFIRM</button>
                    </div>
                </div>
                <div class="cmd-row">
                    <div class="cmd-top-row"><span class="cmd-label cmd-label-sell">Sell COMMANDER:</span><span class="calc-res" id="calc-sell-suzaku"></span></div>
                    <div class="cmd-controls">
                        <input type="number" class="cmd-input input-price" id="sell-price-suzaku" placeholder="Price" oninput="calcQty('suzaku', 'sell')">
                        <input type="number" class="cmd-input input-weight" id="sell-weight-suzaku" placeholder="%" oninput="calcQty('suzaku', 'sell')">
                        <button class="cmd-btn sell-btn" id="btn-sell-suzaku" onclick="executeOrder('suzaku', 'sell')">CONFIRM</button>
                    </div>
                </div>
                <!-- ADHOC SUZAKU -->
                <div class="cmd-row">
                    <div class="cmd-top-row"><span class="cmd-label">ADHOC COMMANDER:</span></div>
                    <div class="cmd-controls adhoc-results-container">
                        <input type="text" class="cmd-input input-price" id="adhoc-search-suzaku" placeholder="Name/Code">
                        <input type="number" class="cmd-input input-weight" id="adhoc-weight-suzaku" placeholder="%" step="0.1">
                        <button class="cmd-btn buy-btn" onclick="addNewAdhoc('suzaku')">ADHOC</button>
                        <div id="suggestions-suzaku" class="suggestions-list-container"></div>
                    </div>
                </div>
                
                <div class="cmd-msg" id="msg-suzaku"></div>
            </div>
            <div class="list-header">PORTFOLIO HOLDINGS</div>
            <div class="holdings-list portfolio-list" id="portfolio-suzaku"></div>
        </div>

        <!-- SIRIUS -->
        <div class="guardian-card g-sirius" id="card-sirius">
            <div class="card-header"><div class="avatar">ğŸº</div><div class="role-info"><h2 class="pixel-font">SIRIUS</h2><div class="role-desc">Inflow (æµå…¥)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-sirius">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-sirius">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-sirius">0%</span></div>
            </div>
            <div class="list-header">STRATEGY SUGGESTIONS</div>
            <div class="holdings-list" id="list-sirius"></div>
            <div class="commander-section">
                <div class="cmd-row">
                    <div class="cmd-top-row"><span class="cmd-label">Buy COMMANDER:</span><span class="calc-res" id="calc-buy-sirius"></span></div>
                    <div class="cmd-controls">
                        <input type="number" class="cmd-input input-price" id="buy-price-sirius" placeholder="Price" oninput="calcQty('sirius', 'buy')">
                        <input type="number" class="cmd-input input-weight" id="buy-weight-sirius" placeholder="%" oninput="calcQty('sirius', 'buy')">
                        <button class="cmd-btn buy-btn" id="btn-buy-sirius" onclick="executeOrder('sirius', 'buy')">CONFIRM</button>
                    </div>
                </div>
                <div class="cmd-row">
                    <div class="cmd-top-row"><span class="cmd-label cmd-label-sell">Sell COMMANDER:</span><span class="calc-res" id="calc-sell-sirius"></span></div>
                    <div class="cmd-controls">
                        <input type="number" class="cmd-input input-price" id="sell-price-sirius" placeholder="Price" oninput="calcQty('sirius', 'sell')">
                        <input type="number" class="cmd-input input-weight" id="sell-weight-sirius" placeholder="%" oninput="calcQty('sirius', 'sell')">
                        <button class="cmd-btn sell-btn" id="btn-sell-sirius" onclick="executeOrder('sirius', 'sell')">CONFIRM</button>
                    </div>
                </div>
                
                 <!-- ADHOC SIRIUS -->
                <div class="cmd-row">
                    <div class="cmd-top-row"><span class="cmd-label">ADHOC COMMANDER:</span></div>
                    <div class="cmd-controls adhoc-results-container">
                        <input type="text" class="cmd-input input-price" id="adhoc-search-sirius" placeholder="Name/Code">
                        <input type="number" class="cmd-input input-weight" id="adhoc-weight-sirius" placeholder="%" step="0.1">
                        <button class="cmd-btn buy-btn" onclick="addNewAdhoc('sirius')">ADHOC</button>
                        <div id="suggestions-sirius" class="suggestions-list-container"></div>
                    </div>
                </div>
                
                <div class="cmd-msg" id="msg-sirius"></div>
            </div>
            <div class="list-header">PORTFOLIO HOLDINGS</div>
            <div class="holdings-list portfolio-list" id="portfolio-sirius"></div>
        </div>

        <!-- KIRIN -->
        <div class="guardian-card g-kirin" id="card-kirin">
            <div class="card-header"><div class="avatar">ğŸ¦„</div><div class="role-info"><h2 class="pixel-font">KIRIN</h2><div class="role-desc">DaZhi (å¤§æ™º)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-kirin">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-kirin">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-kirin">0%</span></div>
            </div>
            <div class="list-header">STRATEGY SUGGESTIONS</div>
            <div class="holdings-list" id="list-kirin"></div>
            <div class="commander-section">
                <div class="cmd-row">
                    <div class="cmd-top-row"><span class="cmd-label">Buy COMMANDER:</span><span class="calc-res" id="calc-buy-kirin"></span></div>
                    <div class="cmd-controls">
                        <input type="number" class="cmd-input input-price" id="buy-price-kirin" placeholder="Price" oninput="calcQty('kirin', 'buy')">
                        <input type="number" class="cmd-input input-weight" id="buy-weight-kirin" placeholder="%" oninput="calcQty('kirin', 'buy')">
                        <button class="cmd-btn buy-btn" id="btn-buy-kirin" onclick="executeOrder('kirin', 'buy')">CONFIRM</button>
                    </div>
                </div>
                <div class="cmd-row">
                    <div class="cmd-top-row"><span class="cmd-label cmd-label-sell">Sell COMMANDER:</span><span class="calc-res" id="calc-sell-kirin"></span></div>
                    <div class="cmd-controls">
                        <input type="number" class="cmd-input input-price" id="sell-price-kirin" placeholder="Price" oninput="calcQty('kirin', 'sell')">
                        <input type="number" class="cmd-input input-weight" id="sell-weight-kirin" placeholder="%" oninput="calcQty('kirin', 'sell')">
                        <button class="cmd-btn sell-btn" id="btn-sell-kirin" onclick="executeOrder('kirin', 'sell')">CONFIRM</button>
                    </div>
                </div>
                
                <!-- ADHOC KIRIN -->
                <div class="cmd-row">
                    <div class="cmd-top-row"><span class="cmd-label">ADHOC COMMANDER:</span></div>
                    <div class="cmd-controls adhoc-results-container">
                        <input type="text" class="cmd-input input-price" id="adhoc-search-kirin" placeholder="Name/Code">
                        <input type="number" class="cmd-input input-weight" id="adhoc-weight-kirin" placeholder="%" step="0.1">
                        <button class="cmd-btn buy-btn" onclick="addNewAdhoc('kirin')">ADHOC</button>
                        <div id="suggestions-kirin" class="suggestions-list-container"></div>
                    </div>
                </div>
                
                <div class="cmd-msg" id="msg-kirin"></div>
            </div>
            <div class="list-header">PORTFOLIO HOLDINGS</div>
            <div class="holdings-list portfolio-list" id="portfolio-kirin"></div>
        </div>
    </div>

    <!-- Settlement Panel: æ§åˆ¶æ˜¾ç¤ºä¸å¦ -->
    <div class="settlement-panel" id="settlementPanel">
        <h3 class="pixel-font" style="text-align:center;color:#fff;">Historical Performance</h3>
        <div class="chart-wrapper"><canvas id="performanceChart"></canvas></div>
    </div>

    <div class="system-controls">
        <button id="engageBtn" class="start-btn" onclick="initSystem()">[ ENGAGE SYSTEM ]</button>
        <div class="log-box" id="systemLog"><div class="log-line">> System Standby...</div></div>
    </div>

    <!-- [æ–°å¢] åŠ¨æ€æ›²çº¿ Modal ç»“æ„ -->
    <div id="chartModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div style="display: flex; align-items: baseline;">
                    <span id="modalTitle" class="pixel-font" style="font-size:1.2em; color:#FFD700;">STOCK</span>
                    <span id="modalCode" style="color:#888; margin-left:10px; font-family:'Roboto Mono';">(--)</span>
                    <!-- æ–°å¢ï¼šå®æ—¶æ¶¨è·Œå¹…è·³åŠ¨æ˜¾ç¤º -->
                    <span id="modalPct" style="margin-left:20px; font-weight:bold; font-size:1.4em;">0.00%</span>
                </div>
                <button class="close-btn" onclick="closeModal()">[X] CLOSE</button>
            </div>
            <div class="detail-chart-wrapper"><canvas id="detailChartCanvas"></canvas></div>
        </div>
    </div>
    <script src="adhoc-manager.js"></script>
    <script>
        // ================= CONFIG =================
        // const STS_API_URL = 'https://aiep-users.vercel.app/api/sts'; 
        const STS_API_URL = 'https://aipeinvestmentagent.pages.dev/api/sts-credentials'; 
        const OSS_BUCKET = 'aiep-users'; 
        const OSS_REGION = 'oss-cn-hangzhou'; 
        const OSS_FILE_NAME = 'AIPEQuantGuardiansPortfolio.xlsx';
        
        const GITHUB_USER = 'digital-era';
        const GITHUB_REPO = 'AIPEQModel';
        const GITHUB_BRANCH = 'main';
        const REAL_API_URL = 'https://aipeinvestmentagent.pages.dev/api/rtStockQueryProxy';

        // 1. å®šä¹‰ç”œç‚¹æ–‡ä»¶åå¸¸é‡
        const SWEET_POINT_FILE = 'SweetPoint_New.json';

        const GUARDIAN_CONFIG = {
            genbu:  { simpleName: "ä½æ³¢", flowName: "ä½æ³¢OR", file: 'ä½æ³¢ç¨³å¥æ¨¡å‹_New.json' },
            suzaku: { simpleName: "å¤§æˆ", flowName: "å¤§æˆOR", file: 'å¤§æˆæ¨¡å‹_New.json' },
            sirius: { simpleName: "æµå…¥", flowName: "æµå…¥OR", file: 'æµå…¥æ¨¡å‹_New.json' },
            kirin:  { simpleName: "å¤§æ™º", flowName: "å¤§æ™ºOR", file: 'å¤§æ™ºæ¨¡å‹_New.json' }
        };

        const HISTORY_FILES = {
            genbu: 'ä½æ³¢ç¨³å¥æ¨¡å‹ä¼˜åŒ–åè¯„ä¼°.json', suzaku: 'å¤§æˆæ¨¡å‹ä¼˜åŒ–åè¯„ä¼°.json',
            sirius: 'æµå…¥æ¨¡å‹ä¼˜åŒ–åè¯„ä¼°.json', kirin: 'å¤§æ™ºæ¨¡å‹ä¼˜åŒ–åè¯„ä¼°.json'
        };

        // ã€æ–°å¢ã€‘é¢å¤–çš„ç»¼åˆè¯„ä¼°æ–‡ä»¶å®šä¹‰
        const EXTRA_HISTORY_FILES = {
            guardians: 'QuantGuardiansç»¼åˆè¯„ä¼°.json',
            user: 'Useræ¨¡å‹ç»¼åˆè¯„ä¼°.json'
        };

        // [æ–°å¢] é¢œè‰²æ˜ å°„å’Œå…¨å±€å›¾è¡¨å˜é‡
        const GUARDIAN_COLORS = { 
            genbu: '#10B981', 
            suzaku: '#EF4444', 
            sirius: '#8B5CF6', 
            kirin: '#3B82F6' 
        };
        let detailChart = null;
        let playbackTimer = null;

        // ================= STATE =================
        let gameState = {
            active: false,
            guardians: {
                genbu: { strategy: [], portfolio: [], power: 0, selectedBuy: null, selectedSell: null, initialAssets: 0 },
                suzaku: { strategy: [], portfolio: [], power: 0, selectedBuy: null, selectedSell: null, initialAssets: 0 },
                sirius: { strategy: [], portfolio: [], power: 0, selectedBuy: null, selectedSell: null, initialAssets: 0 },
                kirin: { strategy: [], portfolio: [], power: 0, selectedBuy: null, selectedSell: null, initialAssets: 0 }
            }
        };
        let memoryFlows = []; 
        let ossClient = null;
        let perfChart = null; 
        
        let historyData = { dates: [], datasets: {} };

        // ================= UTILS =================
        function log(msg, color="#0f0") {
            const box = document.getElementById('systemLog');
            const time = new Date().toLocaleTimeString('en-US', {hour12:false});
            const div = document.createElement('div');
            div.className = 'log-line';
            div.innerHTML = `<span style="color:#666">[${time}]</span> <span style="color:${color}">${msg}</span>`;
            box.prepend(div);
        }

        function getOpTime(clamp = false) {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth()+1).padStart(2,'0');
            const d = String(now.getDate()).padStart(2,'0');
            let h = now.getHours();
            let min = now.getMinutes();
            if (clamp) {
                if (h > 16 || (h === 16 && min > 30)) { h = 16; min = 30; }
            }
            return `${y}${m}${d}${String(h).padStart(2,'0')}${String(min).padStart(2,'0')}`;
        }

		// å…¨å±€ä»£ç†å¼€å…³ï¼šè®¾ç½®ä¸º true å¼€å¯ä»£ç†ï¼Œfalse ä½¿ç”¨åŸç”Ÿé“¾æ¥
		var gitproxy = true; 
		
		// æ›¿æ¢ä¸ºä½ åˆšæ‰éƒ¨ç½²çš„ Cloudflare Worker åœ°å€ (æœ«å°¾ä¸è¦å¸¦æ–œæ )
		const PROXY_BASE_URL = "https://githubproxy.aivibeinvest.com"; 
		
		/**
		 * é€šç”¨åœ°å€ç”Ÿæˆå‡½æ•°
		 * @param {string} filename - æ–‡ä»¶å
		 * @returns {string} æœ€ç»ˆçš„è¯·æ±‚ URL
		 */
		function getResourceUrl(filename) {
		    // åŸºç¡€è·¯å¾„ç»“æ„: User/Repo/Branch/File
		    const filePath = `${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${filename}`;
		    
		    let finalUrl;
		    if (typeof gitproxy !== 'undefined' && gitproxy === true) {
		        // èµ°ä»£ç†: https://proxy.com/User/Repo/Branch/File
		        finalUrl = `${PROXY_BASE_URL}/${filePath}`;
		    } else {
		        // èµ°åŸç”Ÿ: https://raw.githubusercontent.com/User/Repo/Branch/File
		        finalUrl = `https://raw.githubusercontent.com/${filePath}`;
		    }
		    
		    // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
		    return `${finalUrl}?t=${Date.now()}`;
		}

        // ================= NEW CHART LOGIC =================
        
        // [æ–°å¢] å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('chartModal').style.display = 'none';
            if (playbackTimer) clearInterval(playbackTimer);
        }

        // [æ–°å¢] è§¦å‘å¾®å›¾ç‚¹å‡»çš„å¤„ç†å‡½æ•°
        function onSparkClick(event, key, type, idx) {
            event.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è§¦å‘é€‰è¡Œ
            let item;
            if (type === 'strategy') {
                item = gameState.guardians[key].strategy[idx];
            } else {
                item = gameState.guardians[key].portfolio[idx];
            }
            if (item) {
                const color = GUARDIAN_COLORS[key] || '#fff';
                openDetailChart(item, color);
            }
        }

        // [æ–°å¢] æ›¿æ¢åŸæ¥çš„ openDetailChart å‡½æ•°ï¼ˆæ ¸å¿ƒé€»è¾‘å¸¦æ¶¨è·Œå¹…é‡åŒ–ï¼‰
        function openDetailChart(item, color) {
            if (!item.history || item.history.length === 0) return;
            
            const refPrice = item.refPrice || item.history[0]; // åŸºå‡†ä»·ï¼ˆå¼€ç›˜ä»·ï¼‰
            const pctEl = document.getElementById('modalPct');
            
            document.getElementById('modalTitle').innerText = item.name;
            document.getElementById('modalCode').innerText = `(${item.code})`;
            document.getElementById('chartModal').style.display = 'flex';
            document.querySelector('.modal-content').style.borderColor = color;
        
            const ctx = document.getElementById('detailChartCanvas').getContext('2d');
            if (detailChart) detailChart.destroy();
            if (playbackTimer) clearInterval(playbackTimer);
        
            const gradient = ctx.createLinearGradient(0, 0, 0, 450);
            gradient.addColorStop(0, color + '55');
            gradient.addColorStop(1, color + '00');
        
            detailChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: item.history.map((_, i) => i),
                    datasets: [
                        {
                            label: 'Price',
                            data: [], // åŠ¨æ€ç”Ÿé•¿æ•°æ®
                            borderColor: color,
                            borderWidth: 3,
                            pointRadius: 0,
                            fill: true,
                            backgroundColor: gradient,
                            tension: 0.3,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const val = context.parsed.y;
                                    const chg = ((val - refPrice) / refPrice * 100).toFixed(2);
                                    return ` Price: ${val.toFixed(2)} (${chg > 0 ? '+' : ''}${chg}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: {
                            position: 'left',
                            grid: { color: '#222' },
                            ticks: { color: '#888' }
                        },
                        // ä¿®æ”¹å¤„ï¼šå³ä¾§è½´éšè—åˆ»åº¦æ•°å€¼
                        y1: {
                            position: 'right',
                            grid: { display: false },
                            ticks: { display: false } 
                        }
                    }
                }
            });
        
            let step = 0;
            const fullHistory = item.history;
            
            playbackTimer = setInterval(() => {
                step++;
                if (step > fullHistory.length + 10) step = 0;
        
                const currentSlice = fullHistory.slice(0, step);
                const lastPrice = currentSlice[currentSlice.length - 1];
        
                // æ›´æ–°å¤§å›¾æ•°æ®
                detailChart.data.datasets[0].data = currentSlice;
                detailChart.update('none');
        
                // æ›´æ–°é¡¶éƒ¨ HUD çš„ç™¾åˆ†æ¯”å’Œé¢œè‰²
                if (lastPrice) {
                    const currentChg = ((lastPrice - refPrice) / refPrice * 100).toFixed(2);
                    pctEl.innerText = (currentChg > 0 ? '+' : '') + currentChg + '%';
                    pctEl.style.color = lastPrice >= refPrice ? '#EF4444' : '#10B981';
                } else {
                    pctEl.innerText = '0.00%';
                }
            }, 30);
        }

        // ================= LOGIC =================

        async function initOSS() {
            if (ossClient) return true;
            try {
                // const res = await fetch(STS_API_URL);
                const res = await fetch(STS_API_URL, {
		                    method: 'POST',
		                    headers: {
		                        'Content-Type': 'application/json',
		                    } 
		                }); // æŒ‡å‘ä½ åˆ›å»ºçš„STSå‡­è¯é¢å‘å‡½æ•°
				
                const data = await res.json();
                ossClient = new OSS({
                    region: OSS_REGION, accessKeyId: data.AccessKeyId, accessKeySecret: data.AccessKeySecret,
                    stsToken: data.SecurityToken, bucket: OSS_BUCKET,
                    refreshSTSToken: async () => {
                        // const r = await fetch(STS_API_URL); 
                        const r = await fetch(STS_API_URL, {
		                    method: 'POST',
		                    headers: {
		                        'Content-Type': 'application/json',
		                    } 
		                }); // æŒ‡å‘ä½ åˆ›å»ºçš„STSå‡­è¯é¢å‘å‡½æ•°
                        const d = await r.json();
                        return { accessKeyId: d.AccessKeyId, accessKeySecret: d.AccessKeySecret, stsToken: d.SecurityToken };
                    }
                });
                return true;
            } catch (e) { log("OSS Init Fail", "red"); return false; }
        }

        async function loadStrategies() {
            log("Loading Strategy Models...", "cyan");
            const promises = Object.keys(GUARDIAN_CONFIG).map(async (key) => {
				 // --- ä¿®æ”¹å¼€å§‹: è°ƒç”¨é€šç”¨ä»£ç†å‡½æ•° ---
        		const url = getResourceUrl(GUARDIAN_CONFIG[key].file);
                //const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${GUARDIAN_CONFIG[key].file}?t=${Date.now()}`;				
                // --- ä¿®æ”¹ç»“æŸ ---
                try {
                    const res = await fetch(url);
                    const json = await res.json();
                    const data = json.ç»“æœ || json;
                    gameState.guardians[key].power = parseFloat(data.é£æ§å› å­ä¿¡æ¯.ç»¼åˆå»ºè®®ä»“ä½å› å­);
                    gameState.guardians[key].strategy = data.æœ€ä¼˜æŠ•èµ„ç»„åˆé…ç½®.é…ç½®è¯¦æƒ….map(p => ({
                        name: p.åç§°, 
                        code: p.ä»£ç , 
                       // ä¼˜å…ˆè¯»å–â€œæ”¶ç›˜ä»·æ ¼â€ï¼Œå¦‚æœæ²¡æœ‰åˆ™å›é€€åˆ°â€œæœ€è¿‘ä¸€æ—¥ä»·æ ¼â€
                        refPrice: parseFloat(p["æ”¶ç›˜ä»·æ ¼"] || p["æœ€è¿‘ä¸€æ—¥ä»·æ ¼"]), 
                        weight: parseFloat(p["æœ€ä¼˜æƒé‡(%)"]), 
                        currentPrice: null, 
                        history: [],
                        isSweet: false // 2. æ•°æ®ç»“æ„åˆå§‹åŒ–é»˜è®¤ä¸º false
                    }));
                    document.getElementById(`power-${key}`).innerText = (gameState.guardians[key].power * 100).toFixed(0) + "%";
                } catch (e) { log(`[${key}] Model Err`, "red"); }
            });
            await Promise.all(promises);
        }

        // 3. åŠ è½½å¹¶æ ‡è®° Sweet Points çš„æ ¸å¿ƒé€»è¾‘å‡½æ•°
        async function loadSweetPoints() {
            log("Scanning Sweet Points...", "#d8bfd8");
			// --- ä¿®æ”¹å¼€å§‹: è°ƒç”¨é€šç”¨ä»£ç†å‡½æ•° ---
			const url = getResourceUrl(SWEET_POINT_FILE);
			//const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${SWEET_POINT_FILE}?t=${Date.now()}`;
			// --- ä¿®æ”¹ç»“æŸ ---            
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("SweetPoint fetch failed");
                const json = await res.json();
                
                // åˆ›å»ºä»£ç é›†åˆç”¨äºå¿«é€ŸåŒ¹é…
                const sweetCodes = new Set(json.map(item => item.ä»£ç ));

                let count = 0;
                // éå†æ‰€æœ‰å®ˆæŠ¤è€…
                for (let key in gameState.guardians) {
                    gameState.guardians[key].strategy.forEach(stock => {
                        if (sweetCodes.has(stock.code)) {
                            stock.isSweet = true; // æ ‡è®°ä¸ºçœŸ
                            count++;
                        }
                    });
                }
                log(`Sweet Points Applied: ${count}`, "#d8bfd8");
            } catch (e) { log("SweetPoint Err: " + e.message, "orange"); }
        }

        async function loadCloudPortfolio() {
            log("Syncing Cloud Portfolio...", "#88f");
            if (!await initOSS()) return;
            try {
                const result = await ossClient.get(OSS_FILE_NAME);
                const wb = XLSX.read(result.content, { type: 'array' });
                
                for (let key in GUARDIAN_CONFIG) {
                    const sheetName = GUARDIAN_CONFIG[key].simpleName;
                    const g = gameState.guardians[key];
                    g.portfolio = []; 
        
                    if (wb.Sheets[sheetName]) {                        
                        // å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ { raw: true } è·å–åŸå§‹å•å…ƒæ ¼å€¼ï¼Œç„¶åæ‰‹åŠ¨å¤„ç†
                        const ws = wb.Sheets[sheetName];
                        const range = XLSX.utils.decode_range(ws['!ref']);
                        
                        // æ‰¾åˆ°è¡¨å¤´è¡Œ
                        const headers = {};
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const cellAddress = XLSX.utils.encode_cell({r: 0, c: C});
                            const cell = ws[cellAddress];
                            if (cell) {
                                headers[C] = cell.v;
                            }
                        }
                        
                        // æ‰‹åŠ¨è§£ææ•°æ®è¡Œï¼Œç¡®ä¿è‚¡ç¥¨ä»£ç ä¿æŒåŸå§‹å­—ç¬¦ä¸²æ ¼å¼
                        let raw = [];
                        for (let R = 1; R <= range.e.r; ++R) {
                            const row = {};
                            for (let C = range.s.c; C <= range.e.c; ++C) {
                                const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                                const cell = ws[cellAddress];
                                if (cell) {
                                    const header = headers[C];
                                    if (header === 'è‚¡ç¥¨ä»£ç ') {
                                        // å…³é”®ï¼šå¯¹äºè‚¡ç¥¨ä»£ç ï¼Œä½¿ç”¨cell.wï¼ˆæ ¼å¼åŒ–æ–‡æœ¬ï¼‰æˆ–cell.vï¼ˆåŸå§‹å€¼ï¼‰
                                        // ä¼˜å…ˆä½¿ç”¨wï¼ˆæ˜¾ç¤ºæ–‡æœ¬ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨v
                                        row[header] = cell.w !== undefined ? String(cell.w) : 
                                                      (cell.v !== undefined ? String(cell.v) : '');
                                    } else {
                                        // å…¶ä»–åˆ—æ­£å¸¸å¤„ç†
                                        row[header] = cell.w !== undefined ? cell.w : 
                                                      (cell.v !== undefined ? cell.v : '');
                                    }
                                }
                            }
                            if (Object.keys(row).length > 0) {
                                raw.push(row);
                            }
                        }
                        
                        let maxDateInt = 0;
                        raw.forEach(row => {
                            const t = String(row['ä¿®æ”¹æ—¶é—´'] || '');
                            if (t.length >= 8) {
                                const dateVal = parseInt(t.substring(0, 8));
                                if (!isNaN(dateVal) && dateVal > maxDateInt) {
                                    maxDateInt = dateVal;
                                }
                            }
                        });
        
                        let holdingsMap = {};
                        const targetPrefix = String(maxDateInt);
        
                        raw.forEach(row => {
                            const t = String(row['ä¿®æ”¹æ—¶é—´'] || '');
                            if (maxDateInt > 0 && t.startsWith(targetPrefix)) {
                                // ä¿æŒåŸå§‹è‚¡ç¥¨ä»£ç å­—ç¬¦ä¸²ï¼Œä¸åšä»»ä½•æ ¼å¼åŒ–
                                const stockCode = String(row['è‚¡ç¥¨ä»£ç '] || '');
                                holdingsMap[stockCode] = row;
                            }
                        });
        
                        Object.values(holdingsMap).forEach(row => {
                            if (parseFloat(row['é…ç½®æ¯”ä¾‹ (%)']) > 0) {
                                // ä½¿ç”¨åŸå§‹è‚¡ç¥¨ä»£ç ï¼Œä¿æŒExcelä¸­çš„æ ¼å¼
                                const code = String(row['è‚¡ç¥¨ä»£ç '] || '');
                                
                                const strategyItem = g.strategy.find(s => s.code === code);
                                const yesterdayClose = strategyItem ? strategyItem.refPrice : null;
                        
                                g.portfolio.push({
                                    code: code,
                                    name: row['è‚¡ç¥¨åç§°'],
                                    weight: parseFloat(row['é…ç½®æ¯”ä¾‹ (%)']), 
                                    currentPrice: null, 
                                    refPrice: yesterdayClose,
                                    history: []
                                });
                            }
                        });
                    }
                    updateCash(key);
                }
                log("Cloud Portfolio Loaded.", "#0f0");
            } catch (e) {
                if (e.name === 'NoSuchKeyError' || e.code === 'NoSuchKey') {
                    log("No Cloud Save. Starting Fresh.", "#888");
                    for (let k in GUARDIAN_CONFIG) updateCash(k);
                } else {
                    log("Cloud Load Error: " + e.message, "red");
                }
            }
        }

        // å»ºè®®å¢åŠ çš„å†…å­˜ç»“æ„
        let todayInitialAssets = 100000; // å‡è®¾æ¯æ—¥åˆå§‹èµ„é‡‘
        
        async function loadTodayFlows() {
            if (!ossClient) return;
            try {
                const result = await ossClient.get(OSS_FILE_NAME);
                const wb = XLSX.read(result.content, { type: 'array' });
                const todayStr = getOpTime().substring(0, 8); // è·å– YYYYMMDD
                
                memoryFlows = []; // æ¸…ç©ºå†…å­˜è®°å½•
                
                for (let key in GUARDIAN_CONFIG) {
                    const flowSheetName = GUARDIAN_CONFIG[key].flowName;
                    const sheet = wb.Sheets[flowSheetName];
                    if (sheet) {
                        const rows = XLSX.utils.sheet_to_json(sheet);
                        const todayRows = rows.filter(r => String(r["ä¿®æ”¹æ—¶é—´"]).startsWith(todayStr));
                        
                        // å°†ä»Šæ—¥å·²å­˜åœ¨çš„è®°å½•è¯»å…¥å†…å­˜
                        todayRows.forEach(r => {
                            memoryFlows.push({
                                sheet: flowSheetName,
                                data: r
                            });
                        });
                    }
                }
                log(`Loaded ${memoryFlows.length} transactions from today.`, "#0f0");
            } catch (e) { console.error("Load flows error", e); }
        }

        function calculateUserRtn(key) {
            const g = gameState.guardians[key];
            const flowName = GUARDIAN_CONFIG[key].flowName;
            const initialTotalAssets = 100000; // æ¯æ—¥åˆå§‹è™šæ‹Ÿèµ„é‡‘åŸºæ•°
            
            // 1. è·å–ä»Šæ—¥è¯¥å®ˆæŠ¤è€…çš„æ‰€æœ‰å†…å­˜æ“ä½œè®°å½•
            const todayFlows = memoryFlows.filter(f => f.sheet === flowName);
            
            let totalPnL = 0;
        
            /**
             * æ ¸å¿ƒé€»è¾‘ï¼š
             * æ”¶ç›Š = Î£(å½“å‰æŒä»“ä»·å€¼ - å½“å‰æŒä»“æ˜¨æ—¥ä»·å€¼) + Î£(ä»Šæ—¥å–å‡ºè´¡çŒ®) - Î£(ä»Šæ—¥ä¹°å…¥äº§ç”Ÿçš„æˆæœ¬åå·®)
             * 
             * ç®€å•æ¨æ¼”å…¬å¼ï¼š
             * 1. å¯¹äºå½“å‰æŒä»“ï¼šè´¡çŒ® = (ç°ä»· - ä»Šæ—¥å¼€ç›˜ä»·) * å½“å‰æ•°é‡
             * 2. å¯¹äºä»Šæ—¥ä¹°å…¥ï¼šå› ä¸ºç¬¬1æ­¥ç”¨äº†å¼€ç›˜ä»·ï¼Œæ‰€ä»¥è¦æ‰£é™¤ (ä¹°å…¥ä»· - ä»Šæ—¥å¼€ç›˜ä»·) * ä¹°å…¥æ•°é‡
             * 3. å¯¹äºä»Šæ—¥å–å‡ºï¼šè´¡çŒ® = (å–å‡ºä»· - ä»Šæ—¥å¼€ç›˜ä»·) * å–å‡ºæ•°é‡
             */
        
            // --- ç¬¬ä¸€éƒ¨åˆ†ï¼šè®¡ç®—å½“å‰ Portfolio ä¸­æ ‡çš„çš„æµ®åŠ¨ç›ˆäº (ç›¸å¯¹äºå¼€ç›˜ä»·/åŸºå‡†ä»·) ---
            g.portfolio.forEach(p => {
                if (p.isCash) return; // è·³è¿‡ç°é‡‘
                
                // ä¼˜å…ˆä» portfolio æ‰¾ç°ä»·ï¼Œæ‰¾ä¸åˆ°åˆ™è§†ä¸ºæ— æ³¢åŠ¨
                const nowPrice = p.currentPrice;
                const refPrice = p.refPrice; // è¿™é‡Œçš„ refPrice æ˜¯ä»Šæ—¥å¼€ç›˜ä»·
        
                if (nowPrice && refPrice) {
                    // è®¡ç®—å½“å‰æŒä»“åœ¨ä»Šæ—¥çš„æ³¢åŠ¨ï¼š(å½“å‰ä»· - å¼€ç›˜ä»·) * æŒä»“æ•°é‡
                    // æŒä»“æ•°é‡ = (æ€»èµ„äº§ * æƒé‡ / 100) / å½“å‰ä»·
                    const currentWeightValue = initialTotalAssets * (p.weight / 100);
                    const quantity = currentWeightValue / nowPrice;
                    totalPnL += (nowPrice - refPrice) * quantity;
                }
            });
        
            // --- ç¬¬äºŒéƒ¨åˆ†ï¼šé€šè¿‡ memoryFlows ä¿®æ­£ä¹°å…¥æˆæœ¬ï¼Œå¹¶ç´¯åŠ å–å‡ºå·²å®ç°æ”¶ç›Š ---
            todayFlows.forEach(f => {
                const code = f.data["è‚¡ç¥¨ä»£ç "];
                const tradePrice = f.data["ä»·æ ¼"];
                const tradeQty = f.data["æ ‡çš„æ•°é‡"];
                
                // å°è¯•è·å–è¯¥æ ‡çš„çš„åŸºå‡†ä»·ï¼ˆä»Šæ—¥å¼€ç›˜ä»·ï¼‰
                // é€»è¾‘ï¼šå…ˆçœ‹ strategyï¼ˆç­–ç•¥é‡Œå­˜äº† refPriceï¼‰ï¼Œå†çœ‹ portfolio
                const item = g.strategy.find(s => s.code === code) || 
                             g.portfolio.find(p => p.code === code);
                
                const refPrice = item ? item.refPrice : tradePrice;
        
                if (f.data["æ“ä½œç±»å‹"] === "Buy") {
                    /**
                     * ä¹°å…¥ä¿®æ­£ï¼š
                     * åœ¨ç¬¬ä¸€éƒ¨åˆ†è®¡ç®—ä¸­ï¼Œæˆ‘ä»¬å‡è®¾æ‰€æœ‰æŒä»“éƒ½æ˜¯ä» refPriceï¼ˆå¼€ç›˜ï¼‰å¼€å§‹æ³¢åŠ¨çš„ã€‚
                     * ä½†ä»Šæ—¥ä¹°å…¥çš„æ ‡çš„ï¼Œå…¶å®æ˜¯ä» tradePrice å¼€å§‹æ³¢åŠ¨çš„ã€‚
                     * æ‰€ä»¥è¦å‡å» (ä¹°å…¥ä»· - å¼€ç›˜ä»·) è¿™ä¸€æ®µå¤šç®—çš„/å°‘ç®—çš„å·®é¢ã€‚
                     */
                    if (tradePrice && refPrice) {
                        totalPnL -= (tradePrice - refPrice) * tradeQty;
                    }
                } 
                else if (f.data["æ“ä½œç±»å‹"] === "Sell") {
                    /**
                     * å–å‡ºè´¡çŒ®ï¼ˆæŒ‰æ‚¨è¦æ±‚çš„é€»è¾‘ï¼‰ï¼š
                     * å–å‡ºæ—¶çš„ä»·æ ¼ä¸ä»Šæ—¥å¼€ç›˜ä»·ï¼ˆrefPriceï¼‰çš„å·®é¢ä½œä¸ºä»Šæ—¥æ”¶ç›Šè´¡çŒ®ã€‚
                     * å–å‡ºåæ ‡çš„ä¸åœ¨ portfolio äº†ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†æ˜¯â€œé”å®šâ€çš„ä»Šæ—¥æ”¶ç›Šã€‚
                     */
                    if (tradePrice && refPrice) {
                        totalPnL += (tradePrice - refPrice) * tradeQty;
                    }
                }
            });
        
            // 3. è®¡ç®—æ”¶ç›Šç‡ç™¾åˆ†æ¯”
            const rtnPercentage = (totalPnL / initialTotalAssets) * 100;
            
            // è¿”å›æ•°å€¼ï¼Œå¤–å±‚è°ƒç”¨å¯ä»¥ç”¨ .toFixed(2)
            return isNaN(rtnPercentage) ? 0 : rtnPercentage;
        }

        function updateCash(key) {
            const g = gameState.guardians[key];
            g.portfolio = g.portfolio.filter(p => p.code !== '100000');
            const totalStockWeight = g.portfolio.reduce((sum, p) => sum + p.weight, 0);
            const cashWeight = Math.max(0, 100 - totalStockWeight);
            g.portfolio.push({
                code: '100000', name: 'ç°é‡‘', weight: cashWeight, 
                currentPrice: 1, history: [], isCash: true
            });
        }

        async function updateMarketData() {
            // 1. åœ¨è¯·æ±‚å¼€å§‹æ—¶æ‰“å°æç¤º
            log("Sync Price Data", "#aaa"); 
            for (let k in gameState.guardians) {
                const g = gameState.guardians[k];
                let currentAssets = 0;
                
                // 1. Update Strategy Prices and Calc System Rtn
                let systemRtn = 0; 
                for (let s of g.strategy) {
                    await fetchPrice(s);
                    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šåªæœ‰å½“æ ‡çš„å­˜åœ¨ä»·æ ¼ï¼Œä¸”ä¸æ˜¯ ADHOC ä¸´æ—¶æ ‡çš„æ—¶ï¼Œæ‰è®¡ç®—å…¥ System Rtn
                    if (s.currentPrice && s.refPrice) {
                         if (s.isAdhoc !== true) { 
                             const chg = (s.currentPrice - s.refPrice) / s.refPrice;
                             systemRtn += chg * (s.weight / 100);
                         }
                    }
                }

                // --- 2. æ›´æ–°æ•°å€¼å’Œé¢œè‰² ---
                const sysRtnElem = document.getElementById(`rtn-${k}`);
                const cardElem = document.getElementById(`card-${k}`);
                
                if (sysRtnElem) {
                    sysRtnElem.innerText = (systemRtn * 100).toFixed(2) + "%";
                    sysRtnElem.className = systemRtn >= 0 ? "stat-value text-up" : "stat-value text-down";
                }
        
                // --- 3. æ ¹æ®ç³»ç»Ÿæ”¶ç›Šç‡æ­£è´Ÿåˆ‡æ¢è¾¹æ¡†å‘å…‰çŠ¶æ€ ---
                if (systemRtn > 0) {
                    cardElem.classList.add('active'); // æ”¶ç›Šä¸ºæ­£ï¼Œæ¿€æ´»å‘å…‰
                } else {
                    cardElem.classList.remove('active'); // æ”¶ç›Šä¸ºè´Ÿæˆ–é›¶ï¼Œç§»é™¤å‘å…‰
                }              
               
                // 2. Update Portfolio Prices & Value (ç”¨æˆ·æŒä»“éƒ¨åˆ†ä¸å—å½±å“ï¼Œä¹°å…¥å³è®¡ç®—)
                for (let p of g.portfolio) {
                    if (p.isCash) {
                        currentAssets += 100000 * (p.weight / 100); 
                    } else {
                        await fetchPrice(p);
                        currentAssets += 100000 * (p.weight / 100); 
                    }
                }
                
                if (g.initialAssets === 0 && currentAssets > 0) {
                    g.initialAssets = 100000;
                }

                let portRtn = calculateUserRtn(k);         
                const userRtnElem = document.getElementById(`user-rtn-${k}`);
                userRtnElem.innerText = portRtn.toFixed(2) + "%";
                userRtnElem.className = portRtn >= 0 ? "stat-value user-stat text-up" : "stat-value user-stat text-down";
                
                renderLists(k);
            }
            // 2. åœ¨å¾ªç¯ç»“æŸåæ‰“å°å®Œæˆæç¤º
            log("Sync Price Data Finish", "#aaa"); 
        }

        async function fetchPrice(item) {
            if (!item.code) return;
            try {
                const finalCode = item.code.length === 5 ? 'HK' + item.code : item.code;                
                const url = `${REAL_API_URL}?code=${finalCode}&type=intraday`; 
                const res = await fetch(url);
                const data = await res.json();
        
                if (data && data.length > 0) {
                    item.currentPrice = parseFloat(data[data.length-1].price);
                    item.history = data.map(d => d.price);
                    
                    // --- æ ¸å¿ƒé€»è¾‘ï¼šåªæœ‰åœ¨ Excel æ²¡æä¾›ä»·æ ¼çš„æƒ…å†µä¸‹ï¼Œæ‰ç”¨åˆ†æ—¶å›¾çš„ç¬¬ä¸€ç¬”å½“å¼€ç›˜ä»· ---
                    if (item.refPrice === undefined || item.refPrice === null) {
                        item.refPrice = parseFloat(data[0].price);
                    }
                } else {
                    // å¦‚æœ API æ²¡å›æ•°æ®ï¼ˆæ— äº¤æ˜“ï¼‰ï¼Œç°ä»·å³ä¸ºæ˜¨æ”¶ï¼Œæ¶¨è·Œå¹…æ˜¾ç¤º 0%
                    if (item.refPrice !== null) {
                        item.currentPrice = item.refPrice;
                    }
                }
            } catch(e) {
                // ç½‘ç»œå¼‚å¸¸æ—¶ä¿æŒ Excel åˆå§‹ä»·æ ¼
                if (item.refPrice !== null) item.currentPrice = item.refPrice;
            }
        }
        
        function renderLists(key) {
            const g = gameState.guardians[key];
            const listEl = document.getElementById(`list-${key}`);
            listEl.innerHTML = '';
            g.strategy.forEach((s, i) => {
                const el = createRow(key, s, i, 'strategy');
                el.onclick = () => selectStrategyItem(key, i);
                if(g.selectedBuy === i) el.classList.add('selected');
                listEl.appendChild(el);
            });

            const portEl = document.getElementById(`portfolio-${key}`);
            portEl.innerHTML = '';
            g.portfolio.forEach((p, i) => {
                const el = createRow(key, p, i, 'portfolio');
                if (p.isCash) el.classList.add('is-cash');
                else el.onclick = () => selectPortfolioItem(key, i);
                
                if(g.selectedSell === i && !p.isCash) el.classList.add('selected');
                portEl.appendChild(el);
            });
        }

        function createRow(key, item, idx, type) {
            const div = document.createElement('div');
            div.className = 'holding-item';

            if (!item.isCash) {
                const stockUrl = `https://aipeinvestmentagent.pages.dev/PotScoreFundAnalytics?stock=${encodeURIComponent(item.name)}`;
                div.ondblclick = (e) => { 
                    e.stopPropagation(); 
                    window.open(stockUrl, '_blank'); 
                };
            }
            
            // 4. ç•Œé¢æ¸²æŸ“é€»è¾‘ï¼šå¦‚æœæ˜¯ç”œç‚¹ï¼Œåœ¨è‚¡ç¥¨åç§°å‰æ·»åŠ ç³–æœå›¾æ ‡ ğŸ¬
            let iconPrefix = "";
            if(item.isSweet) iconPrefix += "ğŸ¬"; 
            if(iconPrefix !== "") iconPrefix += " ";
            // --- ä¿®æ”¹ç‚¹ï¼šå¦‚æœæ˜¯ strategy ä¸”æ˜¯ adhoc ç±»å‹ï¼Œå¢åŠ å‡å· ---
            let deleteHtml = (type === 'strategy' && item.isAdhoc) ? 
                `<span class="delete-btn" onclick="removeAdhocItem(event, '${key}', ${idx})">âˆ’</span>` : '';
        
            let nameHtml = `<div class="h-name-wrapper"><span class="h-name">${iconPrefix}${item.name}</span>${deleteHtml}</div>`;
            //let nameHtml = `${iconPrefix}${item.name}`;

            let wHtml = "";
            let pHtml = "";
            
            if (item.currentPrice && item.refPrice) {
                const chg = (item.currentPrice - item.refPrice) / item.refPrice;
                const cls = chg >= 0 ? "text-up" : "text-down";
                pHtml = `<span class="h-price ${cls}">${item.currentPrice.toFixed(2)}</span>
                         <span class="h-pct ${cls}">${(chg*100).toFixed(2)}%</span>`;
            } else {
                pHtml = `<span class="h-price">${item.currentPrice ? item.currentPrice.toFixed(2) : '--'}</span>`;
            }

            if (type === 'strategy') {
                wHtml = `<span class="h-weight">[${item.weight.toFixed(2)}%]</span>`;
            } else {
                wHtml = `<span class="user-weight-display">[${item.weight.toFixed(2)}%]</span>`;
            }

            // ... åé¢çš„ innerHTML æ‹¼æ¥ä¸­ä½¿ç”¨ nameHtml ...
            div.innerHTML = `
                <div class="h-info">${nameHtml}<div class="h-weight-row">${wHtml}</div></div>
                <div class="h-price-col">${pHtml}</div>
                <div class="mini-chart-container" onclick="onSparkClick(event, '${key}', '${type}', ${idx})">
                    <canvas id="chart-${key}-${type}-${idx}" class="sparkline"></canvas>
                </div>
            `;
            
            setTimeout(() => {
                if(item.history && item.history.length > 1) {
                    drawSpark(`chart-${key}-${type}-${idx}`, item.history, item.refPrice, (item.currentPrice>=item.refPrice?'#EF4444':'#10B981'));
                }
            }, 0);
            return div;
        }

        function drawSpark(id, data, base, color) {
            const cvs = document.getElementById(id);
            if(!cvs) return;
            const ctx = cvs.getContext('2d');
            const w = ctx.canvas.width = cvs.offsetWidth;
            const h = ctx.canvas.height = cvs.offsetHeight;
            const min = Math.min(...data, base), max = Math.max(...data, base);
            const range = max - min || 1;
            ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
            data.forEach((p, i) => {
                const x = (i / (data.length - 1)) * w;
                const y = h - ((p - min) / range) * h;
                i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
            });
            ctx.stroke();
        }

        function selectStrategyItem(key, idx) {
            gameState.guardians[key].selectedBuy = idx;
            const item = gameState.guardians[key].strategy[idx];
            const price = item.currentPrice || item.refPrice;
            document.getElementById(`buy-price-${key}`).value = price ? price.toFixed(2) : ""; // ä¿®æ”¹ç‚¹
            document.getElementById(`buy-weight-${key}`).value = item.weight.toFixed(2);
            renderLists(key);
            calcQty(key, 'buy');
        }

        function selectPortfolioItem(key, idx) {
            const p = gameState.guardians[key].portfolio[idx];
            if (p.isCash) return;
            gameState.guardians[key].selectedSell = idx;
            const price = p.currentPrice || p.refPrice;
            document.getElementById(`sell-price-${key}`).value = price ? price.toFixed(2) : ""; // ä¿®æ”¹ç‚¹
            document.getElementById(`sell-weight-${key}`).value = p.weight.toFixed(2);
            renderLists(key);
            calcQty(key, 'sell');
        }

        function calcQty(key, type) {
            const g = gameState.guardians[key];
            const price = parseFloat(document.getElementById(`${type}-price-${key}`).value);
            const weight = parseFloat(document.getElementById(`${type}-weight-${key}`).value);
            const resEl = document.getElementById(`calc-${type}-${key}`);
            
            if (price > 0 && weight > 0) {
                const totalAssets = 100000; 
                let actualWeight = weight;
                if (type === 'buy') actualWeight = weight * g.power; 
                const val = totalAssets * (actualWeight / 100);
                const qty = Math.floor(val / price);
                resEl.innerText = `Qty: ${qty}`;
            } else {
                resEl.innerText = "";
            }
        }

        function executeOrder(key, type) {
            const g = gameState.guardians[key];
            const msgEl = document.getElementById(`msg-${key}`);
            const price = parseFloat(document.getElementById(`${type}-price-${key}`).value);
            const weight = parseFloat(document.getElementById(`${type}-weight-${key}`).value);
            
            if (!price || !weight) return;

            if (type === 'buy') {
                if (g.selectedBuy === null) return;
                const item = g.strategy[g.selectedBuy];
                const increment = weight * g.power;
                const currentSum = g.portfolio.reduce((s, p) => p.isCash ? s : s + p.weight, 0);
                if (currentSum + increment > 100.1) { 
                    msgEl.innerText = `ERR: Limit Exceeded (Max 100%)`; msgEl.style.color="red"; return;
                }
                let existing = g.portfolio.find(p => p.code === item.code);
                if (existing) {
                    existing.weight += increment;
                    existing.currentPrice = price; 
                } else {
                    g.portfolio.unshift({ 
                        code: item.code, name: item.name, weight: increment,
                        currentPrice: price, refPrice: item.refPrice, history: item.history
                    });
                }
                recordFlow(key, 'Buy', item.code, item.name, weight, price);
                msgEl.innerText = `BOUGHT ${item.name}`;

            } else if (type === 'sell') {
                if (g.selectedSell === null) return;
                const item = g.portfolio[g.selectedSell];
                if (weight > item.weight + 0.01) {
                    msgEl.innerText = `ERR: Insufficient Holdings`; msgEl.style.color="red"; return;
                }
                item.weight -= weight;
                if (item.weight < 0.01) {
                    g.portfolio.splice(g.selectedSell, 1);
                    g.selectedSell = null;
                }
                recordFlow(key, 'Sell', item.code, item.name, weight, price);
                msgEl.innerText = `SOLD ${item.name}`;
            }

            msgEl.style.color = "#FFD700";
            updateCash(key);
            // ã€æ–°å¢ã€‘ï¼šæ“ä½œå®Œåç«‹å³åˆ·æ–°ä¸€æ¬¡æ”¶ç›Šç‡æ˜¾ç¤º
            const portRtn = calculateUserRtn(key);
            const userRtnElem = document.getElementById(`user-rtn-${key}`);
            userRtnElem.innerText = portRtn.toFixed(2) + "%";
            renderLists(key);
        }

        function recordFlow(key, opType, code, name, inputWeight, price) {
            const g = gameState.guardians[key];
            const totalAssets = 100000;
            let actualWeight = (opType === 'Buy') ? inputWeight * g.power : inputWeight;
            const val = totalAssets * (actualWeight / 100);
            const qty = Math.floor(val / price);
            const value = (qty * price).toFixed(2);
            
            memoryFlows.push({
                sheet: GUARDIAN_CONFIG[key].flowName,
                data: {
                    "ç»„åˆåç§°": GUARDIAN_CONFIG[key].simpleName,
                    "è‚¡ç¥¨ä»£ç ": code,
                    "è‚¡ç¥¨åç§°": name,
                    "é…ç½®æ¯”ä¾‹ (%)": actualWeight.toFixed(2), 
                    "æ ‡çš„æ•°é‡": qty,
                    "ä»·æ ¼": price,
                    "ä»·å€¼": value,
                    "æ“ä½œç±»å‹": opType,
                    "ä¿®æ”¹æ—¶é—´": getOpTime(true)
                }
            });
        }
        
        async function loadAdhocFromCloud() {
            log("Loading ADHOC Suggestions...", "#da70d6");
            if (!ossClient) return;
            try {
                const result = await ossClient.get(OSS_FILE_NAME);
                const wb = XLSX.read(result.content, { type: 'array' });
                const sheet = wb.Sheets["ADHOC"];
                
                if (sheet) {
                    const raw = XLSX.utils.sheet_to_json(sheet, { raw: false });
                    raw.forEach(row => {
                        const simpleName = row["ç»„åˆåç§°"];
                        const key = Object.keys(GUARDIAN_CONFIG).find(k => GUARDIAN_CONFIG[k].simpleName === simpleName);
                        
                        if (key) {
                            const g = gameState.guardians[key];
                            if (!g.strategy.some(s => s.code === String(row["è‚¡ç¥¨ä»£ç "]))) {
                                // --- ä¿®æ”¹ï¼šè¯»å–æ”¶ç›˜ä»·æ ¼ä½œä¸ºåŸºå‡†ä»· ---
                                const excelClosePrice = row["æ”¶ç›˜ä»·æ ¼"] ? parseFloat(row["æ”¶ç›˜ä»·æ ¼"]) : null;
                                
                                g.strategy.push({
                                    name: row["è‚¡ç¥¨åç§°"],
                                    code: String(row["è‚¡ç¥¨ä»£ç "]),
                                    weight: parseFloat(row["å»ºè®®æ¯”ä¾‹ (%)"]),
                                    refPrice: excelClosePrice, // è¿™é‡Œçš„ refPrice å°±æ˜¯ä½ è¦æ±‚çš„â€œå¥‡ç‚¹ä»·æ ¼â€
                                    currentPrice: excelClosePrice, // åˆå§‹ç°ä»·ä¹Ÿè®¾ä¸ºå®ƒï¼Œé˜²æ­¢æ²¡ä¹°å–æ—¶æ˜¾ç¤ºé”™è¯¯
                                    history: [],
                                    isSweet: false,
                                    isAdhoc: true 
                                });
                            }
                        }
                    });
                    log("ADHOC Suggestions Imported.", "#0f0");
                }
            } catch (e) {
                log("No ADHOC data found.", "#888");
            }
        }

        async function syncToCloud() {
            if (!await initOSS()) return;
            const dot = document.getElementById('ossStatusDot');
            dot.className = "oss-status syncing";
            
            try {
                let wb;
                try {
                    const r = await ossClient.get(OSS_FILE_NAME);
                    wb = XLSX.read(r.content, { type: 'array' });
                } catch { wb = XLSX.utils.book_new(); }

                const timeStr = getOpTime(true);
                const todayPrefix = timeStr.substring(0, 8); // æå–å¦‚ "20231027"

                for (let key in GUARDIAN_CONFIG) {
                    const cfg = GUARDIAN_CONFIG[key];
                    const g = gameState.guardians[key];
                    hasNewData = false;

                    let snapData = [];
                    if (wb.Sheets[cfg.simpleName]) {
                        // 1. å…ˆæŠŠ Sheet é‡Œçš„æ—§æ•°æ®å…¨è¯»å‡ºæ¥
                        const oldSnapData = XLSX.utils.sheet_to_json(wb.Sheets[cfg.simpleName]);
                        
                        // 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¿‡æ»¤æ‰â€œä¿®æ”¹æ—¶é—´â€å‰8ä½ç­‰äºä»Šå¤©çš„æ•°æ®
                        snapData = oldSnapData.filter(row => {
                            const rowTime = String(row["ä¿®æ”¹æ—¶é—´"] || "");
                            return rowTime.substring(0, 8) !== todayPrefix; 
                        });
                    }
                    g.portfolio.forEach(p => {
                        snapData.push({
                            "ç»„åˆåç§°": cfg.simpleName,
                            "è‚¡ç¥¨ä»£ç ": p.code,
                            "è‚¡ç¥¨åç§°": p.name,
                            "æ¥æº": "QuantGuardians",
                            "é…ç½®æ¯”ä¾‹ (%)": p.weight.toFixed(2),
                            "ä¿®æ”¹æ—¶é—´": timeStr
                        });
                    });
                    const newSnapWs = XLSX.utils.json_to_sheet(snapData, { header: ["ç»„åˆåç§°","è‚¡ç¥¨ä»£ç ","è‚¡ç¥¨åç§°","æ¥æº","é…ç½®æ¯”ä¾‹ (%)","ä¿®æ”¹æ—¶é—´"] });
                    if(wb.Sheets[cfg.simpleName]) wb.Sheets[cfg.simpleName] = newSnapWs;
                    else XLSX.utils.book_append_sheet(wb, newSnapWs, cfg.simpleName);

                    // åœ¨ syncToCloud å†…éƒ¨å¤„ç† flowName Sheet çš„é€»è¾‘
                    let flowData = [];
                    if (wb.Sheets[cfg.flowName]) {
                        flowData = XLSX.utils.sheet_to_json(wb.Sheets[cfg.flowName]);
                    }
                    
                    const pending = memoryFlows.filter(f => f.sheet === cfg.flowName);
                    
                    pending.forEach(newItem => {
                        // ä¸¥æ ¼åŒ¹é…é€»è¾‘ï¼šå°†å¯¹è±¡è½¬ä¸º JSON å­—ç¬¦ä¸²è¿›è¡Œæ¯”å¯¹
                        const isDuplicate = flowData.some(existingItem => {
                            return existingItem["è‚¡ç¥¨ä»£ç "] === newItem.data["è‚¡ç¥¨ä»£ç "] &&
                                   existingItem["ä¿®æ”¹æ—¶é—´"] === newItem.data["ä¿®æ”¹æ—¶é—´"] &&
                                   existingItem["æ“ä½œç±»å‹"] === newItem.data["æ“ä½œç±»å‹"] &&
                                   parseFloat(existingItem["ä»·æ ¼"]) === parseFloat(newItem.data["ä»·æ ¼"]) &&
                                   parseFloat(existingItem["æ ‡çš„æ•°é‡"]) === parseFloat(newItem.data["æ ‡çš„æ•°é‡"]);
                        });
                    
                        if (!isDuplicate) {
                            flowData.push(newItem.data);
                             hasNewData = true; // ã€æ–°å¢ã€‘åªæœ‰çœŸæ­£æ’å…¥æ•°æ®æ—¶æ‰æ ‡è®°ä¸º true
                        }
                    });

                    // ã€æ ¸å¿ƒä¿æŠ¤ã€‘åªæœ‰å½“ç¡®å®æœ‰æ–°æ•°æ®å†™å…¥ï¼Œæˆ–è€…åŸæœ¬æ²¡æœ‰è¿™ä¸ª Sheet (åˆå§‹åŒ–) æ—¶ï¼Œæ‰æ‰§è¡Œå†™å…¥
                    // å¦‚æœ flowData ä¸ä¸ºç©ºä¸”æ²¡æœ‰ Sheetï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œä¹Ÿè¦å†™å…¥
                    const sheetExists = !!wb.Sheets[cfg.flowName];
                    
                    if (hasNewData || (!sheetExists && flowData.length > 0)) {
                        const headers = [
                            "ç»„åˆåç§°",
                            "è‚¡ç¥¨ä»£ç ",
                            "è‚¡ç¥¨åç§°",
                            "é…ç½®æ¯”ä¾‹ (%)",
                            "æ ‡çš„æ•°é‡",
                            "ä»·æ ¼",
                            "ä»·å€¼",
                            "æ“ä½œç±»å‹",
                            "ä¿®æ”¹æ—¶é—´"
                        ];
                        
                        const newFlowWs = XLSX.utils.json_to_sheet(flowData, {
                            header: headers,
                            skipHeader: false
                        });;
                    
                        if (sheetExists) {
                            wb.Sheets[cfg.flowName] = newFlowWs;
                        } else {
                            XLSX.utils.book_append_sheet(wb, newFlowWs, cfg.flowName);
                        }
                        console.log(`[${cfg.flowName}] æ›´æ–°å®Œæˆï¼Œæ–°å¢ ${pending.length} æ¡è®°å½•`);
                    } else {
                        // æ²¡å˜åŒ–æ—¶ä»€ä¹ˆéƒ½ä¸åšï¼Œwb ä¸­ä¿ç•™åŸæœ‰çš„ Sheet å¯¹è±¡ï¼Œæœ€å¤§ç¨‹åº¦ä¿ç•™åŸæ ¼å¼
                        console.log(`[${cfg.flowName}] æ— æ–°å¢è®°å½•ï¼Œè·³è¿‡å†™å…¥`);
                    }

                }

                // æ”¶é›†æ‰€æœ‰å®ˆæŠ¤è€…çš„ ADHOC æ ‡çš„
                let adhocData = [];
                const adhocTimeStr = getOpTime(true);
                
                for (let key in GUARDIAN_CONFIG) {
                    const cfg = GUARDIAN_CONFIG[key];
                    const g = gameState.guardians[key];
                    const adhocItems = g.strategy.filter(s => s.isAdhoc === true);
                    
                    adhocItems.forEach(item => {
                        adhocData.push({
                            "ç»„åˆåç§°": GUARDIAN_CONFIG[key].simpleName,
                            "è‚¡ç¥¨ä»£ç ": item.code,
                            "è‚¡ç¥¨åç§°": item.name,
                            "æ¥æº": "QuantGuardians",
                            "å»ºè®®æ¯”ä¾‹ (%)": item.weight.toFixed(2),
                            "ä¿®æ”¹æ—¶é—´": adhocTimeStr,
                            "æ”¶ç›˜ä»·æ ¼": item.refPrice // --- ä¿å­˜å½“å‰è®°å½•çš„åŸºå‡†ä»·åˆ° Excel ---
                        });
                    });   
               
                }
                
                // å°†æ”¶é›†åˆ°çš„ ADHOC æ•°æ®å†™å…¥ Sheet (å…¨é‡è¦†ç›–)
                const adhocWs = XLSX.utils.json_to_sheet(adhocData, { 
                    header: ["ç»„åˆåç§°", "è‚¡ç¥¨ä»£ç ", "è‚¡ç¥¨åç§°", "æ¥æº", "å»ºè®®æ¯”ä¾‹ (%)", "ä¿®æ”¹æ—¶é—´"] 
                });
                
                if (wb.Sheets["ADHOC"]) {
                    wb.Sheets["ADHOC"] = adhocWs;
                } else {
                    XLSX.utils.book_append_sheet(wb, adhocWs, "ADHOC");
                }

                const wopts = { bookType:'xlsx', bookSST:false, type:'array' };
                const wbout = XLSX.write(wb, wopts);
                const blob = new Blob([wbout], {type:"application/octet-stream"});
                await ossClient.put(OSS_FILE_NAME, blob);
                
                dot.className = "oss-status done";
                log("Cloud Sync Success.", "#0f0");
                memoryFlows = []; 
            } catch (e) {
                dot.className = "oss-status";
                log("Sync Error: " + e.message, "red");
            }
        }

		async function loadHistoryData() {
            log("Loading Historical Data...", "#88f");
            // 1. åˆå¹¶åŸæœ‰å››å¤§ç¥å…½æ–‡ä»¶ + æ–°å¢çš„ Guardians/User æ–‡ä»¶
            const allFiles = { ...HISTORY_FILES, ...EXTRA_HISTORY_FILES };
            const keys = Object.keys(allFiles);
            
            const requests = keys.map(key => {
                // --- ä¿®æ”¹å¼€å§‹: è°ƒç”¨é€šç”¨ä»£ç†å‡½æ•° ---
	            const url = getResourceUrl(allFiles[key]);
				//const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${allFiles[key]}?t=${Date.now()}`;
	            // --- ä¿®æ”¹ç»“æŸ --- 				
                 return fetch(url).then(res => res.json()).catch(e => null);
            });
            const results = await Promise.all(requests);
            
            let allDatesSet = new Set();
            results.forEach(json => { 
                if(json && json.æ¯æ—¥è¯„ä¼°æ•°æ®) {
                    json.æ¯æ—¥è¯„ä¼°æ•°æ®.forEach(item => allDatesSet.add(item.æ—¥æœŸ)); 
                }
            });
            
            historyData.dates = Array.from(allDatesSet).sort();
            
            results.forEach((json, index) => {
                const key = keys[index];
                if (json && json.æ¯æ—¥è¯„ä¼°æ•°æ®) {
                    const returnMap = new Map();
                    
                    // 1. å¤„ç†æ¯æ—¥è¯„ä¼°æ•°æ® (ä»…å¤„ç†ç´¯è®¡æ”¶ç›Šç‡)
                    json.æ¯æ—¥è¯„ä¼°æ•°æ®.forEach(d => {
                        returnMap.set(d.æ—¥æœŸ, d.ç´¯è®¡æ”¶ç›Šç‡ * 100);
                    });
                    
                    // 2. ä» JSON å¤–å±‚è·å–å›ºå®šçš„æ ‡æ™®500æ”¶ç›Šç‡
                    let sp500FixedValue = null;
                    if (json["æ ‡æ™®500æ”¶ç›Šç‡"] !== undefined) {
                        sp500FixedValue = json["æ ‡æ™®500æ”¶ç›Šç‡"] * 100;
                    }

                    // 3. ä¿å­˜ä¸»è¦æ›²çº¿æ•°æ® (ç­–ç•¥æ”¶ç›Šç‡)
                    historyData.datasets[key] = historyData.dates.map(date => returnMap.has(date) ? returnMap.get(date) : null);
                    
                    // 4. å¦‚æœæ˜¯ guardians æ–‡ä»¶ï¼Œé¢å¤–ç”Ÿæˆ sp500 æ•°æ®
                    // é€»è¾‘ï¼šåˆ›å»ºä¸€ä¸ªä¸æ—¥æœŸæ•°ç»„ç­‰é•¿çš„æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æ˜¯é‚£ä¸ªå›ºå®šçš„ sp500FixedValue
                    if (key === 'guardians') {
                        historyData.datasets['sp500'] = historyData.dates.map(() => sp500FixedValue);
                    }
                } else {
                    historyData.datasets[key] = [];
                    if (key === 'guardians') historyData.datasets['sp500'] = [];
                }
            });
            
            renderHistoryChart();
        }

        function renderHistoryChart() {
            document.getElementById('settlementPanel').style.display = 'block';
            
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (perfChart) perfChart.destroy();
            
            const createDataset = (label, color, dataKey, extraOptions = {}) => ({
                label: label, borderColor: color, backgroundColor: color + '1A',
                data: historyData.datasets[dataKey] || [], tension: 0.3, pointRadius: 0, borderWidth: 2, spanGaps: true,
                ...extraOptions
            });
            
            perfChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historyData.dates,
                    datasets: [
                        // æ–°å¢ï¼šGuardians (æ€»æŠ¤å«é˜Ÿ)
                        createDataset('Guardians', '#FFD700', 'guardians', { borderWidth: 3, order: 1 }),
                        // æ–°å¢ï¼šUser (ç”¨æˆ·)
                        createDataset('User', '#00FFFF', 'user', { borderWidth: 2, order: 2 }),
                        // æ–°å¢ï¼šS&P 500 (ä½œä¸ºåŸºå‡†çº¿ï¼Œè™šçº¿)
                        createDataset('S&P 500', '#666666', 'sp500', { borderDash: [5, 5], borderWidth: 1, order: 99 }),                        
                        // åŸæœ‰å››å¤§ç¥å…½
                        createDataset('GENBU', '#10B981', 'genbu', { hidden: false }), // é»˜è®¤æ˜¾ç¤ºï¼Œå¯ç‚¹å‡»å›¾ä¾‹éšè—
                        createDataset('SUZAKU', '#EF4444', 'suzaku', { hidden: false }),
                        createDataset('SIRIUS', '#8B5CF6', 'sirius', { hidden: false }),
                        createDataset('KIRIN', '#3B82F6', 'kirin', { hidden: false })
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#ccc' } } },
                    scales: { 
                        y: { ticks: { color: '#666' }, grid: { color: '#333' } }, 
                        x: { ticks: { color: '#666', maxTicksLimit: 8 }, grid: { color: '#333' } } 
                    }
                }
            });
        }

        async function initSystem() {
            if (gameState.active) return;
            const btn = document.getElementById('engageBtn');
            btn.innerText = "INITIALIZING...";
            
            await initOSS();
            
            // åŠ è½½ç­–ç•¥å’Œå†å²æ•°æ®
            await Promise.all([
                loadStrategies(),
                loadHistoryData()
            ]);

            // 5. åœ¨ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹ä¸­ï¼Œç­–ç•¥åŠ è½½åç«‹å³è°ƒç”¨åŠ è½½å‡½æ•°
            await loadSweetPoints(); 

            //  ã€æ–°å¢ã€‘ä»äº‘ç«¯å¯¼å…¥ ADHOC æ ‡çš„åˆ° Strategy Suggestions
            await loadAdhocFromCloud();
            
            await loadCloudPortfolio();
            
            updateMarketData();
            setInterval(updateMarketData, 300000); 

            await fetchAllStocksData(); // æ–°å¢ï¼šè·å–å…¨é‡æœç´¢æ•°æ®
            setupAllAdhocAutoCompletes(); // æ–°å¢ï¼šè®¾ç½®è‡ªåŠ¨è¡¥å…¨
            
            
            gameState.active = true;
            btn.innerText = "SYSTEM ONLINE";
            btn.style.boxShadow = "0 0 20px #0f0";
        }
    </script>
</body>
</html>
