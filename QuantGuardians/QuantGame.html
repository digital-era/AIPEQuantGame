<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡å­æŠ¤å«é˜Ÿï¼šå››æ–¹æˆ˜çºª | Quant Guardians</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #050510;
            --panel-bg: #111122;
            --text-main: #e0e0e0;
            
            /* è§’è‰²è‰²è°ƒ */
            --genbu-color: #10B981;  /* Green */
            --suzaku-color: #EF4444; /* Red */
            --sirius-color: #8B5CF6; /* Purple */
            --kirin-color: #3B82F6;  /* Blue */
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Roboto Mono', monospace;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1, .pixel-font {
            font-family: 'Press Start 2P', cursive;
            text-transform: uppercase;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(255,255,255,0.2);
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            width: 100%;
            max-width: 1400px;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* --- æŠ¤å«é˜Ÿå¡ç‰‡ --- */
        .guardian-card {
            background: var(--panel-bg);
            border: 2px solid #444;
            padding: 15px;
            border-radius: 4px;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            min-height: 600px;
        }

        .g-genbu { --glow-color: var(--genbu-color); }
        .g-suzaku { --glow-color: var(--suzaku-color); }
        .g-sirius { --glow-color: var(--sirius-color); }
        .g-kirin { --glow-color: var(--kirin-color); }

        .guardian-card.active {
            border-color: var(--glow-color);
            box-shadow: 0 0 20px var(--glow-color);
        }

        .card-header {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .avatar { font-size: 2.5em; margin-right: 15px; text-shadow: 0 0 10px var(--glow-color); }
        .role-info h2 { margin: 0; font-size: 1.2em; color: var(--glow-color); }
        .role-desc { font-size: 0.6em; color: #888; }

        .main-stat-box {
            background: rgba(0,0,0,0.3);
            border: 1px solid #333;
            padding: 10px;
            text-align: center;
            margin-bottom: 10px;
        }

        .stat-label { font-size: 0.7em; color: #aaa; text-transform: uppercase; }
        .stat-value { font-size: 1.8em; font-weight: bold; color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.3); }
        .sub-stat { font-size: 0.8em; color: #666; margin-top: 5px; }

        .holdings-list {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px dashed #333;
            background: rgba(0,0,0,0.2);
            padding: 5px;
            height: 250px;
        }

        .holding-item {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr 1fr;
            background: #1a1a2e;
            margin-bottom: 4px;
            padding: 6px;
            border-left: 3px solid #444;
            cursor: pointer;
            transition: background 0.2s;
        }
        .holding-item:hover { background: #252540; }
        .holding-item.selected { background: #303050; border-left-color: #fff; box-shadow: inset 0 0 10px rgba(255,255,255,0.1); }

        .h-name { font-weight: bold; font-size: 0.85em; color: #ddd; }
        .h-meta { font-size: 0.7em; color: #666; }
        .h-price-col { text-align: right; display: flex; flex-direction: column; justify-content: center; }
        .h-price { font-size: 0.85em; font-weight: bold; }
        .h-pct { font-size: 0.7em; }
        
        .text-up { color: #EF4444; }
        .text-down { color: #10B981; }

        .mini-chart-container { position: relative; width: 100%; height: 35px; }
        canvas.sparkline { width: 100%; height: 100%; }

        .commander-section { margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; }
        .cmd-label { font-size: 0.7em; color: var(--glow-color); margin-bottom: 5px; display: block; }
        .cmd-controls { display: flex; gap: 5px; }
        .cmd-input { background: #000; border: 1px solid #555; color: #fff; font-family: 'Roboto Mono'; padding: 5px; flex-grow: 1; font-size: 0.8em; }
        .cmd-btn { background: #222; color: var(--glow-color); border: 1px solid var(--glow-color); cursor: pointer; font-family: 'Press Start 2P'; font-size: 0.6em; padding: 5px 10px; }
        .cmd-msg { height: 20px; font-size: 0.7em; margin-top: 5px; color: #ffff00; }

        /* --- å†å²æˆ˜ç»©é¢æ¿ (æ¢å¤å†…å®¹) --- */
        .settlement-panel {
            width: 100%;
            max-width: 1400px;
            background: var(--panel-bg);
            border: 2px solid #555;
            padding: 20px;
            margin-bottom: 20px;
            display: none; /* åˆå§‹éšè— */
        }
        .settlement-header {
            text-align: center; 
            border-bottom: 1px solid #333; 
            padding-bottom: 10px; 
            margin-bottom: 10px; 
            color: #fff;
        }

        /* åº•éƒ¨æ§åˆ¶å° */
        .system-controls { margin-top: 10px; text-align: center; width: 100%; max-width: 800px; }
        .start-btn { background: #000; color: #0f0; border: 2px solid #0f0; padding: 15px 40px; font-family: 'Press Start 2P'; font-size: 1.2em; cursor: pointer; box-shadow: 0 0 10px #0f0; margin-bottom: 10px; }
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        .log-box { background: #000; border: 1px solid #333; height: 100px; overflow-y: scroll; text-align: left; padding: 10px; font-size: 0.75em; color: #0f0; }
        .log-line { border-bottom: 1px solid #111; padding: 2px 0; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    </style>
</head>
<body>

    <div class="header">
        <h1>Quant Guardians</h1>
        <div class="pixel-font" style="font-size: 0.7em; color: #666; margin-top:5px;">Real-time Battle System // å››æ–¹æˆ˜çºªå®ç›˜</div>
    </div>

    <div class="container">
        <!-- 01. ç„æ­¦ -->
        <div class="guardian-card g-genbu" id="card-genbu">
            <div class="card-header"><div class="avatar">ğŸ›¡ï¸</div><div class="role-info"><h2 class="pixel-font">GENBU</h2><div class="role-desc">LowVol (ä½æ³¢)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-label">System Rtn</div><div class="stat-value" id="rtn-genbu">--.--%</div><div class="sub-stat">Power: <span id="power-genbu">0%</span></div>
            </div>
            <div class="holdings-list" id="list-genbu"></div>
            <div class="commander-section">
                <span class="cmd-label">COMMANDER:</span>
                <div class="cmd-controls"><input type="number" class="cmd-input" id="input-genbu" placeholder="Guess Price"><button class="cmd-btn" onclick="commanderAction('genbu')">CONFIRM</button></div>
                <div class="cmd-msg" id="msg-genbu"></div>
            </div>
        </div>

        <!-- 02. æœ±é›€ -->
        <div class="guardian-card g-suzaku" id="card-suzaku">
            <div class="card-header"><div class="avatar">ğŸ”¥</div><div class="role-info"><h2 class="pixel-font">SUZAKU</h2><div class="role-desc">DaCheng (å¤§æˆ)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-label">System Rtn</div><div class="stat-value" id="rtn-suzaku">--.--%</div><div class="sub-stat">Power: <span id="power-suzaku">0%</span></div>
            </div>
            <div class="holdings-list" id="list-suzaku"></div>
            <div class="commander-section">
                <span class="cmd-label">COMMANDER:</span>
                <div class="cmd-controls"><input type="number" class="cmd-input" id="input-suzaku" placeholder="Guess Price"><button class="cmd-btn" onclick="commanderAction('suzaku')">CONFIRM</button></div>
                <div class="cmd-msg" id="msg-suzaku"></div>
            </div>
        </div>

        <!-- 03. å¤©ç‹¼ -->
        <div class="guardian-card g-sirius" id="card-sirius">
            <div class="card-header"><div class="avatar">ğŸº</div><div class="role-info"><h2 class="pixel-font">SIRIUS</h2><div class="role-desc">Inflow (æµå…¥)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-label">System Rtn</div><div class="stat-value" id="rtn-sirius">--.--%</div><div class="sub-stat">Power: <span id="power-sirius">0%</span></div>
            </div>
            <div class="holdings-list" id="list-sirius"></div>
            <div class="commander-section">
                <span class="cmd-label">COMMANDER:</span>
                <div class="cmd-controls"><input type="number" class="cmd-input" id="input-sirius" placeholder="Guess Price"><button class="cmd-btn" onclick="commanderAction('sirius')">CONFIRM</button></div>
                <div class="cmd-msg" id="msg-sirius"></div>
            </div>
        </div>

        <!-- 04. éº’éºŸ -->
        <div class="guardian-card g-kirin" id="card-kirin">
            <div class="card-header"><div class="avatar">ğŸ¦„</div><div class="role-info"><h2 class="pixel-font">KIRIN</h2><div class="role-desc">DaZhi (å¤§æ™º)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-label">System Rtn</div><div class="stat-value" id="rtn-kirin">--.--%</div><div class="sub-stat">Power: <span id="power-kirin">0%</span></div>
            </div>
            <div class="holdings-list" id="list-kirin"></div>
            <div class="commander-section">
                <span class="cmd-label">COMMANDER:</span>
                <div class="cmd-controls"><input type="number" class="cmd-input" id="input-kirin" placeholder="Guess Price"><button class="cmd-btn" onclick="commanderAction('kirin')">CONFIRM</button></div>
                <div class="cmd-msg" id="msg-kirin"></div>
            </div>
        </div>
    </div>

    <!-- æ¢å¤çš„ç»“ç®—å›¾è¡¨åŒºåŸŸ -->
    <div class="settlement-panel" id="settlementPanel">
        <h3 class="settlement-header pixel-font">Historical Battle Records (Backtest)</h3>
        <canvas id="performanceChart" style="width:100%; height:300px;"></canvas>
    </div>

    <!-- ç³»ç»Ÿæ§åˆ¶å° -->
    <div class="system-controls">
        <button id="engageBtn" class="start-btn" onclick="initSystem()">[ ENGAGE SYSTEM ]</button>
        <div class="log-box" id="systemLog">
            <div class="log-line">> System Standby... Waiting for user command.</div>
        </div>
        <div style="color:#444; font-size:0.6em; margin-top:5px;">DATA REFRESH: 5 MIN INTERVAL</div>
    </div>

    <script>
        // --- 1. é…ç½® ---
        const GITHUB_USER = 'digital-era';
        const GITHUB_REPO = 'AIPEQModel';
        const GITHUB_BRANCH = 'main';
        const REAL_API_URL = 'https://aipeinvestmentagent.pages.dev/api/rtStockQueryProxy';
        const PROXY_WRAPPER = 'https://api.allorigins.win/raw?url=';
        
        // ç­–ç•¥æŒä»“æ–‡ä»¶
        const GUARDIAN_FILES = {
            genbu: 'ä½æ³¢ç¨³å¥æ¨¡å‹_New.json',
            suzaku: 'å¤§æˆæ¨¡å‹_New.json', 
            sirius: 'æµå…¥æ¨¡å‹_New.json',
            kirin: 'å¤§æ™ºæ¨¡å‹_New.json'
        };

        // å†å²å›æµ‹æ–‡ä»¶ (æ¢å¤)
        const HISTORY_FILES = {
            genbu: 'ä½æ³¢ç¨³å¥æ¨¡å‹ä¼˜åŒ–åè¯„ä¼°.json',
            suzaku: 'å¤§æˆæ¨¡å‹ä¼˜åŒ–åè¯„ä¼°.json',
            sirius: 'æµå…¥æ¨¡å‹ä¼˜åŒ–åè¯„ä¼°.json',
            kirin: 'å¤§æ™ºæ¨¡å‹ä¼˜åŒ–åè¯„ä¼°.json'
        };

        let gameState = {
            active: false,
            guardians: {
                genbu: { name: 'ç„æ­¦', holdings: [], power: 0, selectedIdx: -1 },
                suzaku: { name: 'æœ±é›€', holdings: [], power: 0, selectedIdx: -1 },
                sirius: { name: 'å¤©ç‹¼', holdings: [], power: 0, selectedIdx: -1 },
                kirin: { name: 'éº’éºŸ', holdings: [], power: 0, selectedIdx: -1 }
            }
        };

        // å†å²æ•°æ®å­˜å‚¨
        let historyData = { dates: [], datasets: {} };

        function log(msg, color="#0f0") {
            const box = document.getElementById('systemLog');
            const time = new Date().toLocaleTimeString('en-US', {hour12:false});
            const div = document.createElement('div');
            div.className = 'log-line';
            div.innerHTML = `<span style="color:#666">[${time}]</span> <span style="color:${color}">${msg}</span>`;
            box.prepend(div);
        }

        // --- 2. åŠ è½½ç­–ç•¥ä¸å®æ—¶æ•°æ®é€»è¾‘ (ä¿æŒä¸å˜) ---
        async function loadStrategies() {
            log("Loading Tactical Configurations...", "cyan");
            const promises = Object.keys(GUARDIAN_FILES).map(async (key) => {
                const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${GUARDIAN_FILES[key]}?t=${Date.now()}`;
                try {
                    const res = await fetch(url);
                    if(!res.ok) throw new Error("Net Err");
                    const json = await res.json();
                    const data = json.ç»“æœ || json;
                    
                    const portfolio = data.æœ€ä¼˜æŠ•èµ„ç»„åˆé…ç½®.é…ç½®è¯¦æƒ…;
                    const factor = parseFloat(data.é£æ§å› å­ä¿¡æ¯.ç»¼åˆå»ºè®®ä»“ä½å› å­);
                    gameState.guardians[key].power = factor;
                    gameState.guardians[key].holdings = portfolio.map(p => {
                        let w = parseFloat(p["æœ€ä¼˜æƒé‡(%)"]);
                        if (w > 1) w = w / 100;
                        return {
                            name: p.åç§°, code: p.ä»£ç ,
                            refPrice: parseFloat(p.æœ€è¿‘ä¸€æ—¥ä»·æ ¼),
                            weight: w,
                            currentPrice: null, history: [], changePct: 0
                        };
                    });
                    document.getElementById(`power-${key}`).innerText = (factor * 100).toFixed(0) + "%";
                    renderList(key);
                } catch (e) { log(`[${key}] Init Failed: ${e.message}`, "red"); }
            });
            await Promise.all(promises);
        }

        // --- 3. æ¢å¤å†å²æ•°æ®åŠ è½½ä¸ç»˜å›¾ ---
        async function loadHistoryData() {
            log("Downloading Historical Combat Records...", "#888");
            const keys = Object.keys(HISTORY_FILES);
            const requests = keys.map(key => {
                 const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${HISTORY_FILES[key]}?t=${Date.now()}`;
                 return fetch(url).then(res => res.json()).catch(e => null);
            });

            const results = await Promise.all(requests);
            let allDatesSet = new Set();
            
            // æ”¶é›†æ—¥æœŸ
            results.forEach(json => {
                if(json && json.æ¯æ—¥è¯„ä¼°æ•°æ®) {
                    json.æ¯æ—¥è¯„ä¼°æ•°æ®.forEach(item => allDatesSet.add(item.æ—¥æœŸ));
                }
            });
            
            historyData.dates = Array.from(allDatesSet).sort();

            // å¯¹é½æ•°æ®
            results.forEach((json, index) => {
                const key = keys[index];
                if (json && json.æ¯æ—¥è¯„ä¼°æ•°æ®) {
                    const dataMap = new Map();
                    json.æ¯æ—¥è¯„ä¼°æ•°æ®.forEach(d => dataMap.set(d.æ—¥æœŸ, d.ç´¯è®¡æ”¶ç›Šç‡ * 100));
                    historyData.datasets[key] = historyData.dates.map(date => dataMap.has(date) ? dataMap.get(date) : null);
                }
            });

            log("Historical Database Synced.", "lime");
            renderHistoryChart();
        }

        function renderHistoryChart() {
            const panel = document.getElementById('settlementPanel');
            panel.style.display = 'block'; // æ˜¾ç¤ºé¢æ¿

            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            const createDataset = (label, color, dataKey) => ({
                label: label,
                borderColor: color,
                backgroundColor: color + '1A',
                data: historyData.datasets[dataKey] || [],
                tension: 0.2, pointRadius: 0, borderWidth: 2, spanGaps: true
            });

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historyData.dates,
                    datasets: [
                        createDataset('GENBU', '#10B981', 'genbu'),
                        createDataset('SUZAKU', '#EF4444', 'suzaku'),
                        createDataset('SIRIUS', '#8B5CF6', 'sirius'),
                        createDataset('KIRIN', '#3B82F6', 'kirin')
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#ccc', font: {family: 'Roboto Mono'} } } },
                    scales: {
                        y: { ticks: { color: '#666' }, grid: { color: '#333' } },
                        x: { ticks: { color: '#666', maxTicksLimit: 10 }, grid: { color: '#333' } }
                    }
                }
            });
        }

        // --- 4. å®æ—¶äº¤äº’éƒ¨åˆ† (åˆ—è¡¨ã€APIã€ç”»å›¾) ---
        function renderList(key) {
            const listEl = document.getElementById(`list-${key}`);
            listEl.innerHTML = '';
            const g = gameState.guardians[key];
            g.holdings.forEach((stock, idx) => {
                const div = document.createElement('div');
                div.className = 'holding-item';
                div.id = `item-${key}-${idx}`;
                div.onclick = () => selectStock(key, idx);
                div.innerHTML = `
                    <div><div class="h-name">${stock.name}</div><div class="h-meta">W:${(stock.weight*100).toFixed(1)}%</div></div>
                    <div class="h-price-col" id="price-box-${key}-${idx}"><span class="h-price">--</span></div>
                    <div class="mini-chart-container"><canvas id="chart-${key}-${idx}" class="sparkline"></canvas></div>
                `;
                listEl.appendChild(div);
            });
        }

        function selectStock(key, idx) {
            const g = gameState.guardians[key];
            g.selectedIdx = idx;
            const listEl = document.getElementById(`list-${key}`);
            Array.from(listEl.children).forEach((child, i) => {
                if (i === idx) child.classList.add('selected');
                else child.classList.remove('selected');
            });
            const input = document.getElementById(`input-${key}`);
            input.placeholder = `Guess: ${g.holdings[idx].name}`;
            input.value = '';
            document.getElementById(`msg-${key}`).innerText = "";
        }

        function commanderAction(key) {
            const g = gameState.guardians[key];
            const msgEl = document.getElementById(`msg-${key}`);
            if (g.selectedIdx === -1) { msgEl.innerText = "Select Target First"; msgEl.style.color = "red"; return; }
            
            const stock = g.holdings[g.selectedIdx];
            const guess = parseFloat(document.getElementById(`input-${key}`).value);
            if (!guess || !stock.currentPrice) return;

            const diff = Math.abs(guess - stock.currentPrice) / stock.currentPrice;
            if (diff < 0.01) {
                msgEl.innerText = `>> PERFECT SYNC!`;
                msgEl.style.color = "#0f0";
                document.getElementById(`card-${key}`).style.boxShadow = "0 0 30px #fff";
                setTimeout(() => document.getElementById(`card-${key}`).style.boxShadow = "", 500);
            } else {
                msgEl.innerText = guess > stock.currentPrice ? `Too High (${stock.currentPrice})` : `Too Low (${stock.currentPrice})`;
                msgEl.style.color = guess > stock.currentPrice ? "#f55" : "#5af";
            }
        }

        async function updateMarketData() {
            log("Scanning Market Frequencies...", "#888");
            for (let key in gameState.guardians) {
                const g = gameState.guardians[key];
                let totalRtn = 0, valid = 0;
                
                const promises = g.holdings.map(async (stock, idx) => {
                    if (!stock.code) return;
                    try {
                        const target = `${REAL_API_URL}?code=${stock.code}&type=intraday`;
                        const res = await fetch(PROXY_WRAPPER + encodeURIComponent(target));
                        const data = await res.json();
                        if (Array.isArray(data) && data.length > 0) {
                            const last = data[data.length - 1];
                            const price = parseFloat(parseFloat(last.price).toFixed(2));
                            stock.currentPrice = price;
                            stock.history = data.map(d => parseFloat(d.price));
                            
                            let base = parseFloat(data[0].price);
                            if (!base) base = stock.refPrice;
                            
                            const change = (price - base) / base;
                            stock.changePct = change;
                            totalRtn += change * stock.weight;
                            valid++;
                            updateRowUI(key, idx, stock, change, base);
                        }
                    } catch (e) { console.error(e); }
                });
                await Promise.all(promises);

                if (valid > 0) {
                    const finalRtn = totalRtn * g.power;
                    const el = document.getElementById(`rtn-${key}`);
                    el.innerText = (finalRtn > 0 ? "+" : "") + (finalRtn * 100).toFixed(2) + "%";
                    el.style.color = finalRtn > 0 ? "#EF4444" : "#10B981";
                    if(finalRtn > 0) document.getElementById(`card-${key}`).classList.add('active');
                }
            }
            log("Data Stream Synced.", "#0f0");
        }

        function updateRowUI(key, idx, stock, change, base) {
            const el = document.getElementById(`price-box-${key}-${idx}`);
            const row = document.getElementById(`item-${key}-${idx}`);
            const cls = change >= 0 ? 'text-up' : 'text-down';
            el.innerHTML = `<span class="h-price ${cls}">${stock.currentPrice.toFixed(2)}</span><span class="h-pct ${cls}">${change>0?'+':''}${(change*100).toFixed(2)}%</span>`;
            row.style.borderLeftColor = change >= 0 ? '#EF4444' : '#10B981';
            drawSpark(`chart-${key}-${idx}`, stock.history, base, change >= 0 ? '#EF4444' : '#10B981');
        }

        function drawSpark(id, data, base, color) {
            const ctx = document.getElementById(id).getContext('2d');
            const w = ctx.canvas.width = ctx.canvas.parentElement.offsetWidth;
            const h = ctx.canvas.height = ctx.canvas.parentElement.offsetHeight;
            if (data.length < 2) return;
            
            const min = Math.min(...data, base), max = Math.max(...data, base);
            const range = (max - min) || 0.01;
            const pad = range * 0.1, effMin = min - pad, effRange = range + 2*pad;

            ctx.clearRect(0,0,w,h);
            
            const yBase = h - ((base - effMin) / effRange) * h;
            ctx.beginPath(); ctx.setLineDash([2,2]); ctx.strokeStyle="#444"; 
            ctx.moveTo(0, yBase); ctx.lineTo(w, yBase); ctx.stroke();

            ctx.beginPath(); ctx.setLineDash([]); ctx.strokeStyle=color; ctx.lineWidth=2;
            const step = w / (data.length - 1);
            data.forEach((p,i) => ctx[i?'lineTo':'moveTo'](i*step, h - ((p - effMin) / effRange) * h));
            ctx.stroke();
        }

        // --- 5. å¯åŠ¨ ---
        async function initSystem() {
            if (gameState.active) return;
            const btn = document.getElementById('engageBtn');
            btn.innerText = "INITIALIZING..."; btn.disabled = true;
            
            // å¹¶è¡ŒåŠ è½½ç­–ç•¥é…ç½®å’Œå†å²æ•°æ®
            await Promise.all([loadStrategies(), loadHistoryData()]);
            
            await updateMarketData();
            setInterval(updateMarketData, 300000);
            
            gameState.active = true;
            btn.innerText = "SYSTEM ONLINE";
            btn.style.boxShadow = "0 0 20px #0f0";
        }
    </script>
</body>
</html>
