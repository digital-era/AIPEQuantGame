<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡å­æŠ¤å«é˜Ÿï¼šå››æ–¹æˆ˜çºª | Quant Guardians</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ä¿æŒåŸæœ‰åŸºç¡€æ ·å¼ --- */
        :root {
            --bg-color: #050510;
            --panel-bg: #111122;
            --text-main: #e0e0e0;
            --genbu-color: #10B981;
            --suzaku-color: #EF4444;
            --sirius-color: #8B5CF6;
            --kirin-color: #3B82F6;
            --user-gold: #FFD700;
        }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Roboto Mono', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1, .pixel-font { font-family: 'Press Start 2P', cursive; text-transform: uppercase; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; width: 100%; max-width: 1400px; }
        .container { max-width: 1400px; width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .guardian-card { background: var(--panel-bg); border: 2px solid #444; padding: 15px; border-radius: 4px; display: flex; flex-direction: column; transition: all 0.3s; box-shadow: 0 0 10px rgba(0,0,0,0.5); min-height: 600px; }
        .guardian-card.active { border-color: var(--glow-color); box-shadow: 0 0 20px var(--glow-color); }
        .g-genbu { --glow-color: var(--genbu-color); }
        .g-suzaku { --glow-color: var(--suzaku-color); }
        .g-sirius { --glow-color: var(--sirius-color); }
        .g-kirin { --glow-color: var(--kirin-color); }
        .card-header { display: flex; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        .avatar { font-size: 2.5em; margin-right: 15px; text-shadow: 0 0 10px var(--glow-color); }
        .role-info h2 { margin: 0; font-size: 1.2em; color: var(--glow-color); }
        .role-desc { font-size: 0.6em; color: #888; }
        .main-stat-box { background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; text-align: center; margin-bottom: 10px; }
        .stat-group { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; }
        .stat-label { font-size: 0.6em; color: #aaa; text-transform: uppercase; }
        .stat-value { font-size: 1.2em; font-weight: bold; color: #fff; }
        .user-stat { color: var(--user-gold); text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
        .sub-stat { font-size: 0.7em; color: #666; margin-top: 5px; border-top: 1px dashed #333; padding-top: 5px;}
        .holdings-list { flex-grow: 1; overflow-y: auto; border: 1px dashed #333; background: rgba(0,0,0,0.2); padding: 5px; height: 250px; }
        .holding-item { display: grid; grid-template-columns: 1.4fr 0.8fr 1fr; background: #1a1a2e; margin-bottom: 4px; padding: 8px 6px; border-left: 3px solid #444; cursor: pointer; transition: background 0.2s; align-items: center; }
        .holding-item:hover { background: #252540; }
        .holding-item.selected { background: #303050; border-left-color: #fff; }
        .holding-item.locked { border-left-color: var(--user-gold); background: #2a2a10; opacity: 1; } 
        .holding-item.locked .h-name { color: var(--user-gold); }
        .h-info { display: flex; flex-direction: column; }
        .h-name { font-weight: bold; font-size: 0.9em; color: #ddd; }
        .h-weight { font-size: 0.75em; color: #aaa; margin-top: 2px; }
        
        /* ä¿®æ”¹ç‚¹1ï¼šè°ƒæ•´ç”¨æˆ·æƒé‡æ˜¾ç¤ºçš„æ ·å¼ï¼Œä¿æŒé»„è‰² */
        .user-weight-display { color: var(--user-gold); font-size: 0.9em; margin-left: 5px; font-weight: bold; }
        
        .h-price-col { text-align: right; display: flex; flex-direction: column; justify-content: center; padding-right: 5px;}
        .h-price { font-size: 0.85em; font-weight: bold; }
        .h-pct { font-size: 0.7em; }
        .text-up { color: #EF4444; }
        .text-down { color: #10B981; }
        .mini-chart-container { position: relative; width: 100%; height: 35px; }
        canvas.sparkline { width: 100%; height: 100%; }
        
        /* --- Commander åŒºåŸŸæ ·å¼ä¼˜åŒ– --- */
        .commander-section { margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; }
        .cmd-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .cmd-label { font-size: 0.7em; color: var(--glow-color); display: block; }
        .calc-res { font-size: 0.7em; color: var(--user-gold); font-weight: bold; text-shadow: 0 0 5px rgba(255,215,0,0.5); }
        
        /* ä¿®æ”¹ç‚¹2ï¼šä¼˜åŒ– Input ç»„å¸ƒå±€ */
        .cmd-controls { 
            display: flex; 
            gap: 4px; /* é—´è·ç¼©å°ä¸€ç‚¹ */
            width: 100%;
            align-items: center;
        }
        
        .cmd-input { 
            background: #000; 
            border: 1px solid #555; 
            color: #fff; 
            font-family: 'Roboto Mono'; 
            padding: 5px; 
            font-size: 0.8em; 
            height: 30px; /* ç»Ÿä¸€é«˜åº¦ */
        }

        /* ä»·æ ¼è¾“å…¥æ¡†ï¼šè‡ªé€‚åº”å®½åº¦ï¼Œä½†å…è®¸ç¼©å°ï¼Œä¸æŒ¤å‹æŒ‰é’® */
        .input-price { 
            flex: 1;        /* å æ®å‰©ä½™ç©ºé—´ */
            min-width: 0;   /* å…³é”®ï¼šå…è®¸ Flex å­é¡¹ç¼©å°åˆ°å†…å®¹ä»¥ä¸‹ï¼Œé˜²æ­¢æ’‘ç ´å®¹å™¨ */
        }

        /* æƒé‡è¾“å…¥æ¡†ï¼šå›ºå®šå®½åº¦ï¼Œå¤Ÿå†™ç™¾åˆ†æ¯”å³å¯ */
        .input-weight { 
            width: 50px; 
            flex: 0 0 50px; /* ä¸ä¼¸ç¼©ï¼Œå›ºå®šå®½åº¦ */
            color: var(--user-gold); 
            border-color: #554400; 
            text-align: center;
        }

        .cmd-input:disabled { background: #222; color: #888; border-color: #444; cursor: not-allowed; }
        .cmd-input.locked-input { color: #ffd700; border-color: #ffd700; font-weight: bold; }

        /* æŒ‰é’®ï¼šä¸æ¢è¡Œï¼Œå›ºå®šå¤§å° */
        .cmd-btn { 
            background: #222; 
            color: var(--glow-color); 
            border: 1px solid var(--glow-color); 
            cursor: pointer; 
            font-family: 'Press Start 2P'; 
            font-size: 0.6em; 
            padding: 0 8px; /* å‡å°‘å†…è¾¹è· */
            height: 30px;   /* ç»Ÿä¸€é«˜åº¦ */
            white-space: nowrap; /* å…³é”®ï¼šé˜²æ­¢æ–‡å­—æ¢è¡Œ */
            flex: 0 0 auto; /* å…³é”®ï¼šé˜²æ­¢æŒ‰é’®è¢«æŒ¤å‹å˜å½¢ */
        }
        .cmd-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .cmd-msg { height: 20px; font-size: 0.7em; margin-top: 5px; color: #ffff00; }
        
        .settlement-panel { width: 100%; max-width: 1400px; background: var(--panel-bg); border: 2px solid #555; padding: 20px; margin-bottom: 20px; display: none; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .settlement-header { text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; color: #fff; }
        .chart-wrapper { position: relative; height: 400px; width: 100%; }
        .system-controls { margin-top: 10px; text-align: center; width: 100%; max-width: 800px; }
        .start-btn { background: #000; color: #0f0; border: 2px solid #0f0; padding: 15px 40px; font-family: 'Press Start 2P'; font-size: 1.2em; cursor: pointer; box-shadow: 0 0 10px #0f0; margin-bottom: 10px; }
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        .log-box { background: #000; border: 1px solid #333; height: 100px; overflow-y: scroll; text-align: left; padding: 10px; font-size: 0.75em; color: #0f0; }
        .log-line { border-bottom: 1px solid #111; padding: 2px 0; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Quant Guardians</h1>
        <div class="pixel-font" style="font-size: 0.7em; color: #666; margin-top:5px;">Real-time Battle System</div>
    </div>
    <div class="container">
        <!-- GENBU -->
        <div class="guardian-card g-genbu" id="card-genbu">
            <div class="card-header"><div class="avatar">ğŸ›¡ï¸</div><div class="role-info"><h2 class="pixel-font">GENBU</h2><div class="role-desc">LowVol (ä½æ³¢)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-genbu">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-genbu">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-genbu">0%</span></div>
            </div>
            <div class="holdings-list" id="list-genbu"></div>
            <div class="commander-section">
                <div class="cmd-top-row">
                    <span class="cmd-label">COMMANDER:</span>
                    <span class="calc-res" id="calc-res-genbu"></span>
                </div>
                <div class="cmd-controls">
                    <input type="number" class="cmd-input input-price" id="input-price-genbu" placeholder="Price">
                    <input type="number" class="cmd-input input-weight" id="input-weight-genbu" placeholder="%">
                    <button class="cmd-btn" id="btn-genbu" onclick="commanderAction('genbu')">CONFIRM</button>
                </div>
                <div class="cmd-msg" id="msg-genbu"></div>
            </div>
        </div>
        
        <!-- SUZAKU -->
        <div class="guardian-card g-suzaku" id="card-suzaku">
            <div class="card-header"><div class="avatar">ğŸ”¥</div><div class="role-info"><h2 class="pixel-font">SUZAKU</h2><div class="role-desc">DaCheng (å¤§æˆ)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-suzaku">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-suzaku">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-suzaku">0%</span></div>
            </div>
            <div class="holdings-list" id="list-suzaku"></div>
            <div class="commander-section">
                <div class="cmd-top-row">
                    <span class="cmd-label">COMMANDER:</span>
                    <span class="calc-res" id="calc-res-suzaku"></span>
                </div>
                <div class="cmd-controls">
                    <input type="number" class="cmd-input input-price" id="input-price-suzaku" placeholder="Price">
                    <input type="number" class="cmd-input input-weight" id="input-weight-suzaku" placeholder="%">
                    <button class="cmd-btn" id="btn-suzaku" onclick="commanderAction('suzaku')">CONFIRM</button>
                </div>
                <div class="cmd-msg" id="msg-suzaku"></div>
            </div>
        </div>

        <!-- SIRIUS -->
        <div class="guardian-card g-sirius" id="card-sirius">
            <div class="card-header"><div class="avatar">ğŸº</div><div class="role-info"><h2 class="pixel-font">SIRIUS</h2><div class="role-desc">Inflow (æµå…¥)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-sirius">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-sirius">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-sirius">0%</span></div>
            </div>
            <div class="holdings-list" id="list-sirius"></div>
            <div class="commander-section">
                <div class="cmd-top-row">
                    <span class="cmd-label">COMMANDER:</span>
                    <span class="calc-res" id="calc-res-sirius"></span>
                </div>
                <div class="cmd-controls">
                    <input type="number" class="cmd-input input-price" id="input-price-sirius" placeholder="Price">
                    <input type="number" class="cmd-input input-weight" id="input-weight-sirius" placeholder="%">
                    <button class="cmd-btn" id="btn-sirius" onclick="commanderAction('sirius')">CONFIRM</button>
                </div>
                <div class="cmd-msg" id="msg-sirius"></div>
            </div>
        </div>

        <!-- KIRIN -->
        <div class="guardian-card g-kirin" id="card-kirin">
            <div class="card-header"><div class="avatar">ğŸ¦„</div><div class="role-info"><h2 class="pixel-font">KIRIN</h2><div class="role-desc">DaZhi (å¤§æ™º)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-kirin">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-kirin">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-kirin">0%</span></div>
            </div>
            <div class="holdings-list" id="list-kirin"></div>
            <div class="commander-section">
                <div class="cmd-top-row">
                    <span class="cmd-label">COMMANDER:</span>
                    <span class="calc-res" id="calc-res-kirin"></span>
                </div>
                <div class="cmd-controls">
                    <input type="number" class="cmd-input input-price" id="input-price-kirin" placeholder="Price">
                    <input type="number" class="cmd-input input-weight" id="input-weight-kirin" placeholder="%">
                    <button class="cmd-btn" id="btn-kirin" onclick="commanderAction('kirin')">CONFIRM</button>
                </div>
                <div class="cmd-msg" id="msg-kirin"></div>
            </div>
        </div>
    </div>

    <div class="settlement-panel" id="settlementPanel">
        <h3 class="settlement-header pixel-font">Historical Performance</h3>
        <div class="chart-wrapper"><canvas id="performanceChart"></canvas></div>
    </div>

    <div class="system-controls">
        <button id="engageBtn" class="start-btn" onclick="initSystem()">[ ENGAGE SYSTEM ]</button>
        <div class="log-box" id="systemLog"><div class="log-line">> System Standby...</div></div>
        <div style="color:#444; font-size:0.6em; margin-top:5px;">REFRESH: 5 MIN</div>
    </div>

    <script>
        const GITHUB_USER = 'digital-era';
        const GITHUB_REPO = 'AIPEQModel';
        const GITHUB_BRANCH = 'main';
        const REAL_API_URL = 'https://aipeinvestmentagent.pages.dev/api/rtStockQueryProxy';
        
        const GUARDIAN_FILES = {
            genbu: 'ä½æ³¢ç¨³å¥æ¨¡å‹_New.json', suzaku: 'å¤§æˆæ¨¡å‹_New.json', 
            sirius: 'æµå…¥æ¨¡å‹_New.json', kirin: 'å¤§æ™ºæ¨¡å‹_New.json'
        };
        const HISTORY_FILES = {
            genbu: 'ä½æ³¢ç¨³å¥æ¨¡å‹ä¼˜åŒ–åè¯„ä¼°.json', suzaku: 'å¤§æˆæ¨¡å‹ä¼˜åŒ–åè¯„ä¼°.json',
            sirius: 'æµå…¥æ¨¡å‹ä¼˜åŒ–åè¯„ä¼°.json', kirin: 'å¤§æ™ºæ¨¡å‹ä¼˜åŒ–åè¯„ä¼°.json'
        };

        let gameState = {
            active: false,
            guardians: {
                genbu: { holdings: [], power: 0, selectedIdx: -1 },
                suzaku: { holdings: [], power: 0, selectedIdx: -1 },
                sirius: { holdings: [], power: 0, selectedIdx: -1 },
                kirin: { holdings: [], power: 0, selectedIdx: -1 }
            }
        };
        let historyData = { dates: [], datasets: {} };
        let myChart = null;

        function log(msg, color="#0f0") {
            const box = document.getElementById('systemLog');
            const time = new Date().toLocaleTimeString('en-US', {hour12:false});
            const div = document.createElement('div');
            div.className = 'log-line';
            div.innerHTML = `<span style="color:#666">[${time}]</span> <span style="color:${color}">${msg}</span>`;
            box.prepend(div);
        }

        async function loadStrategies() {
            log("Loading Configs...", "cyan");
            const promises = Object.keys(GUARDIAN_FILES).map(async (key) => {
                const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${GUARDIAN_FILES[key]}?t=${Date.now()}`;
                try {
                    const res = await fetch(url);
                    if(!res.ok) throw new Error("Net Err");
                    const json = await res.json();
                    const data = json.ç»“æœ || json;
                    const portfolio = data.æœ€ä¼˜æŠ•èµ„ç»„åˆé…ç½®.é…ç½®è¯¦æƒ…;
                    const factor = parseFloat(data.é£æ§å› å­ä¿¡æ¯.ç»¼åˆå»ºè®®ä»“ä½å› å­);
                    
                    gameState.guardians[key].power = factor;
                    gameState.guardians[key].holdings = portfolio.map(p => {
                        let w = parseFloat(p["æœ€ä¼˜æƒé‡(%)"]);
                        if (w > 1) w = w / 100;
                        return {
                            name: p.åç§°, code: p.ä»£ç ,
                            refPrice: parseFloat(p.æœ€è¿‘ä¸€æ—¥ä»·æ ¼),
                            weight: w,
                            currentPrice: null, history: [], changePct: 0,
                            isLocked: false, userPrice: null,
                            userWeight: 0
                        };
                    });
                    document.getElementById(`power-${key}`).innerText = (factor * 100).toFixed(0) + "%";
                    renderList(key);
                } catch (e) { log(`[${key}] Err: ${e.message}`, "red"); }
            });
            await Promise.all(promises);
        }

        async function loadHistoryData() {
            const keys = Object.keys(HISTORY_FILES);
            const requests = keys.map(key => {
                 const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${HISTORY_FILES[key]}?t=${Date.now()}`;
                 return fetch(url).then(res => res.json()).catch(e => null);
            });
            const results = await Promise.all(requests);
            let allDatesSet = new Set();
            results.forEach(json => { if(json && json.æ¯æ—¥è¯„ä¼°æ•°æ®) json.æ¯æ—¥è¯„ä¼°æ•°æ®.forEach(item => allDatesSet.add(item.æ—¥æœŸ)); });
            historyData.dates = Array.from(allDatesSet).sort();
            results.forEach((json, index) => {
                const key = keys[index];
                if (json && json.æ¯æ—¥è¯„ä¼°æ•°æ®) {
                    const dataMap = new Map();
                    json.æ¯æ—¥è¯„ä¼°æ•°æ®.forEach(d => dataMap.set(d.æ—¥æœŸ, d.ç´¯è®¡æ”¶ç›Šç‡ * 100));
                    historyData.datasets[key] = historyData.dates.map(date => dataMap.has(date) ? dataMap.get(date) : null);
                } else historyData.datasets[key] = [];
            });
            renderHistoryChart();
        }

        function renderHistoryChart() {
            document.getElementById('settlementPanel').style.display = 'block';
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (myChart) myChart.destroy();
            const createDataset = (label, color, dataKey) => ({
                label: label, borderColor: color, backgroundColor: color + '1A',
                data: historyData.datasets[dataKey] || [], tension: 0.3, pointRadius: 0, borderWidth: 2, spanGaps: true
            });
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historyData.dates,
                    datasets: [
                        createDataset('GENBU', '#10B981', 'genbu'),
                        createDataset('SUZAKU', '#EF4444', 'suzaku'),
                        createDataset('SIRIUS', '#8B5CF6', 'sirius'),
                        createDataset('KIRIN', '#3B82F6', 'kirin')
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#ccc' } } },
                    scales: { y: { ticks: { color: '#666' }, grid: { color: '#333' } }, x: { ticks: { color: '#666', maxTicksLimit: 8 }, grid: { color: '#333' } } }
                }
            });
        }

        function renderList(key) {
            const listEl = document.getElementById(`list-${key}`);
            listEl.innerHTML = '';
            const g = gameState.guardians[key];
            g.holdings.forEach((stock, idx) => {
                const div = document.createElement('div');
                div.className = 'holding-item';
                if(stock.isLocked) div.classList.add('locked');
                div.id = `item-${key}-${idx}`;
                div.onclick = () => selectStock(key, idx);
                
                let nameHtml = stock.name;
                if(stock.isLocked) nameHtml = `ğŸ”’ ${stock.name}`; 

                // ä¿®æ”¹ç‚¹1ï¼šæ›´æ”¹æ˜¾ç¤ºæ ¼å¼ä¸º [x%]
                const userWeightHtml = `<span class="user-weight-display">[${stock.userWeight}%]</span>`;

                div.innerHTML = `
                    <div class="h-info">
                        <div class="h-name">${nameHtml} <span class="h-weight">[${(stock.weight*100).toFixed(1)}%]</span>${userWeightHtml}</div>
                    </div>
                    <div class="h-price-col" id="price-box-${key}-${idx}"><span class="h-price">--</span></div>
                    <div class="mini-chart-container"><canvas id="chart-${key}-${idx}" class="sparkline"></canvas></div>
                `;
                listEl.appendChild(div);
            });
        }

        function selectStock(key, idx) {
            const g = gameState.guardians[key];
            g.selectedIdx = idx;
            const listEl = document.getElementById(`list-${key}`);
            Array.from(listEl.children).forEach((child, i) => {
                if (i === idx) child.classList.add('selected');
                else child.classList.remove('selected');
            });

            const stock = g.holdings[idx];
            const inputPrice = document.getElementById(`input-price-${key}`);
            const inputWeight = document.getElementById(`input-weight-${key}`);
            const btn = document.getElementById(`btn-${key}`);
            const msgEl = document.getElementById(`msg-${key}`);

            msgEl.innerText = "";
            document.getElementById(`calc-res-${key}`).innerText = "";

            if (stock.isLocked) {
                inputPrice.value = stock.userPrice;
                inputPrice.disabled = true;
                inputPrice.classList.add('locked-input');
                inputWeight.disabled = false;
                
                const suggestedWgt = stock.weight * 100;
                const remaining = Math.max(0, suggestedWgt - stock.userWeight);
                inputWeight.value = remaining.toFixed(1);

                btn.disabled = false;
                msgEl.innerText = "Target Locked. Add Wgt?";
                msgEl.style.color = "#FFD700";

            } else {
                inputPrice.value = '';
                inputPrice.disabled = false;
                inputPrice.classList.remove('locked-input');
                inputPrice.placeholder = `Price`;
                
                inputWeight.disabled = false;
                
                const suggestedWgt = stock.weight * 100;
                const remaining = Math.max(0, suggestedWgt - stock.userWeight);
                inputWeight.value = remaining.toFixed(1);

                btn.disabled = false;
                msgEl.innerText = "";
            }
        }

        function commanderAction(key) {
            const g = gameState.guardians[key];
            const msgEl = document.getElementById(`msg-${key}`);
            const resEl = document.getElementById(`calc-res-${key}`);
            
            if (g.selectedIdx === -1) { msgEl.innerText = "Select Target"; msgEl.style.color = "red"; return; }
            
            const stock = g.holdings[g.selectedIdx];
            const inputPrice = document.getElementById(`input-price-${key}`);
            const inputWeight = document.getElementById(`input-weight-${key}`);
            
            const guessPrice = parseFloat(inputPrice.value);
            const guessWeight = parseFloat(inputWeight.value);

            if (!guessPrice || !stock.currentPrice) { msgEl.innerText = "Waiting Data/Input..."; return; }

            const current = stock.currentPrice;

            let priceConfirmed = false;
            
            if (stock.isLocked) {
                priceConfirmed = true;
            } else {
                if (guessPrice < current) {
                    msgEl.innerText = `Too Low (Curr: ${current})`;
                    msgEl.style.color = "#5af";
                    return;
                } else {
                    const diff = (guessPrice - current) / current;
                    if (diff < 0.01) {
                        priceConfirmed = true;
                    } else {
                        msgEl.innerText = `Too High (Curr: ${current})`;
                        msgEl.style.color = "#f55";
                        return;
                    }
                }
            }

            if (priceConfirmed) {
                if (!stock.isLocked) {
                    stock.isLocked = true;
                    stock.userPrice = guessPrice;
                    msgEl.innerText = `>> LOCKED & LOADED!`;
                } else {
                    msgEl.innerText = `>> WEIGHT UPDATED!`;
                }
                msgEl.style.color = "#FFD700";

                if (!isNaN(guessWeight) && guessWeight > 0) {
                    stock.userWeight = parseFloat((stock.userWeight + guessWeight).toFixed(2));
                    
                    const totalCapital = 100000;
                    const w_pct = guessWeight / 100;
                    const power = g.power;
                    
                    const calculatedVol = (totalCapital / stock.userPrice) * w_pct * power;
                    
                    resEl.innerText = `VOL: ${calculatedVol.toFixed(0)}`;
                } else {
                    resEl.innerText = "VOL: 0";
                }

                calculateUserRtn(key); 
                renderList(key); 
                selectStock(key, g.selectedIdx); 
                restoreGroupUI(key); 

                const card = document.getElementById(`card-${key}`);
                card.style.boxShadow = "0 0 30px #FFD700";
                setTimeout(() => card.style.boxShadow = "", 800);
            }
        }

        function restoreGroupUI(key) {
            const g = gameState.guardians[key];
            g.holdings.forEach((stock, idx) => {
                if (stock.currentPrice !== null) {
                    const basePrice = parseFloat(stock.refPrice.toFixed(2));
                    updateRowUI(key, idx, stock, stock.changePct, basePrice);
                }
            });
        }

        function calculateUserRtn(key) {
            const g = gameState.guardians[key];
            let userTotalRtn = 0;
            g.holdings.forEach(stock => {
                if (stock.isLocked && stock.userPrice) {
                    const basePrice = parseFloat(stock.refPrice.toFixed(2));
                    const userReturn = (stock.userPrice - basePrice) / basePrice;
                    userTotalRtn += userReturn * (stock.userWeight / 100);
                }
            });
            const finalUserRtn = userTotalRtn * g.power;
            const el = document.getElementById(`user-rtn-${key}`);
            const sign = finalUserRtn > 0 ? "+" : "";
            el.innerText = sign + (finalUserRtn * 100).toFixed(2) + "%";
        }

        async function updateMarketData() {
            log("Scanning Market...", "#888");
            for (let key in gameState.guardians) {
                const g = gameState.guardians[key];
                let totalRtn = 0, valid = 0;
                
                const promises = g.holdings.map(async (stock, idx) => {
                    if (!stock.code) return;
                    try {
                        const target = `${REAL_API_URL}?code=${stock.code}&type=intraday&_t=${Date.now()}`;
                        const res = await fetch(target);
                        const data = await res.json();
                        
                        if (Array.isArray(data) && data.length > 0) {
                            const last = data[data.length - 1];
                            const price = parseFloat(parseFloat(last.price).toFixed(2));
                            stock.currentPrice = price;
                            stock.history = data.map(d => parseFloat(d.price));
                            
                            const base = parseFloat(stock.refPrice.toFixed(2));
                            const change = (price - base) / base;
                            stock.changePct = change;
                            totalRtn += change * stock.weight;
                            valid++;
                            updateRowUI(key, idx, stock, change, base);
                        }
                    } catch (e) { console.error(e); }
                });
                await Promise.all(promises);

                if (valid > 0) {
                    const finalRtn = totalRtn * g.power;
                    const el = document.getElementById(`rtn-${key}`);
                    el.innerText = (finalRtn > 0 ? "+" : "") + (finalRtn * 100).toFixed(2) + "%";
                    el.style.color = finalRtn >= 0 ? "#EF4444" : "#10B981";
                    
                    if(finalRtn > 0) document.getElementById(`card-${key}`).classList.add('active');
                    else document.getElementById(`card-${key}`).classList.remove('active');
                }
            }
            log("Data Stream Synced.", "#0f0");
        }

        function updateRowUI(key, idx, stock, change, base) {
            const el = document.getElementById(`price-box-${key}-${idx}`);
            const row = document.getElementById(`item-${key}-${idx}`);
            
            if (stock.isLocked) {
                row.style.borderLeftColor = 'var(--user-gold)';
            } else {
                row.style.borderLeftColor = change >= 0 ? '#EF4444' : '#10B981';
            }
            
            const cls = change >= 0 ? 'text-up' : 'text-down';
            el.innerHTML = `<span class="h-price ${cls}">${stock.currentPrice.toFixed(2)}</span><span class="h-pct ${cls}">${change>0?'+':''}${(change*100).toFixed(2)}%</span>`;
            
            drawSpark(`chart-${key}-${idx}`, stock.history, base, change >= 0 ? '#EF4444' : '#10B981');
        }

        function drawSpark(id, data, base, color) {
            const ctx = document.getElementById(id).getContext('2d');
            const w = ctx.canvas.width = ctx.canvas.parentElement.offsetWidth;
            const h = ctx.canvas.height = ctx.canvas.parentElement.offsetHeight;
            if (data.length < 2) return;
            const min = Math.min(...data, base), max = Math.max(...data, base);
            const range = (max - min) || 0.01;
            const pad = range * 0.2;
            const effMin = min - pad, effRange = range + 2*pad;

            ctx.clearRect(0,0,w,h);
            const yBase = h - ((base - effMin) / effRange) * h;
            ctx.beginPath(); ctx.setLineDash([2,2]); ctx.strokeStyle="#444"; 
            ctx.moveTo(0, yBase); ctx.lineTo(w, yBase); ctx.stroke();
            ctx.beginPath(); ctx.setLineDash([]); ctx.strokeStyle=color; ctx.lineWidth=2;
            const step = w / (data.length - 1);
            data.forEach((p,i) => ctx[i?'lineTo':'moveTo'](i*step, h - ((p - effMin) / effRange) * h));
            ctx.stroke();
        }

        async function initSystem() {
            if (gameState.active) return;
            const btn = document.getElementById('engageBtn');
            btn.innerText = "INITIALIZING..."; btn.disabled = true;
            await Promise.all([loadStrategies(), loadHistoryData()]);
            await updateMarketData();
            setInterval(updateMarketData, 300000);
            gameState.active = true;
            btn.innerText = "SYSTEM ONLINE";
            btn.style.boxShadow = "0 0 20px #0f0";
        }
    </script>
</body>
</html>
