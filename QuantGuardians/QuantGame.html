<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈáèÂ≠êÊä§Âç´ÈòüÔºöÂõõÊñπÊàòÁ∫™ | Quant Guardians</title>
    <!-- ÂºïÂÖ• Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ÂºïÂÖ• SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- ÂºïÂÖ• Ali-OSS SDK -->
    <script src="https://gosspublic.alicdn.com/aliyun-oss-sdk-6.18.0.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Âü∫Á°ÄÊ†∑Âºè --- */
        :root {
            --bg-color: #050510;
            --panel-bg: #111122;
            --text-main: #e0e0e0;
            --genbu-color: #10B981;
            --suzaku-color: #EF4444;
            --sirius-color: #8B5CF6;
            --kirin-color: #3B82F6;
            --user-gold: #FFD700;
        }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Roboto Mono', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1, .pixel-font { font-family: 'Press Start 2P', cursive; text-transform: uppercase; }
        
        /* --- Header --- */
        .header { 
            text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; 
            width: 100%; max-width: 1400px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .container { max-width: 1400px; width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 20px; }
        
        /* --- Âç°ÁâáÊ†∑Âºè --- */
        .guardian-card { background: var(--panel-bg); border: 2px solid #444; padding: 15px; border-radius: 4px; display: flex; flex-direction: column; transition: all 0.3s; box-shadow: 0 0 10px rgba(0,0,0,0.5); min-height: 800px; }
        .guardian-card.active { border-color: var(--glow-color); box-shadow: 0 0 20px var(--glow-color); }
        .g-genbu { --glow-color: var(--genbu-color); }
        .g-suzaku { --glow-color: var(--suzaku-color); }
        .g-sirius { --glow-color: var(--sirius-color); }
        .g-kirin { --glow-color: var(--kirin-color); }
        
        .card-header { display: flex; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        .avatar { font-size: 2.5em; margin-right: 15px; text-shadow: 0 0 10px var(--glow-color); }
        .role-info h2 { margin: 0; font-size: 1.2em; color: var(--glow-color); }
        .role-desc { font-size: 0.6em; color: #888; }
        
        .main-stat-box { background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; text-align: center; margin-bottom: 10px; }
        .stat-group { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; }
        .stat-label { font-size: 0.6em; color: #aaa; text-transform: uppercase; }
        .stat-value { font-size: 1.2em; font-weight: bold; color: #fff; }
        
        .user-stat { color: var(--user-gold); text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
        .sub-stat { font-size: 0.7em; color: #fff; margin-top: 5px; border-top: 1px dashed #333; padding-top: 5px; font-weight: bold;}
        
        /* --- ÂàóË°®Âå∫Âüü --- */
        .list-header { font-size: 0.6em; color: #888; margin-top: 5px; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; }
        .holdings-list { flex-grow: 1; overflow-y: auto; border: 1px dashed #333; background: rgba(0,0,0,0.2); padding: 5px; height: 200px; margin-bottom: 10px; }
        .portfolio-list { height: 200px; border: 1px solid #444; background: #000; }

        /* --- ÂàóË°®È°π --- */
        .holding-item { 
            display: grid; grid-template-columns: 1.4fr 0.8fr 1fr; 
            background: #1a1a2e; margin-bottom: 4px; padding: 6px; 
            border-left: 3px solid #444; cursor: pointer; transition: background 0.2s; 
            align-items: center; user-select: none; 
        }
        .holding-item:hover { background: #252540; }
        .holding-item.selected { background: #303050; border-left-color: #fff; }
        .holding-item.is-cash { border-left-color: var(--user-gold); background: #1a1a10; }

        .h-info { display: flex; flex-direction: column; justify-content: center; }
        .h-name { font-weight: bold; font-size: 0.8em; color: #ddd; display: block; margin-bottom: 2px;} 
        .h-weight-row { display: flex; align-items: center; font-size: 0.7em; }
        .h-weight { color: #aaa; margin-right: 8px; }
        .user-weight-display { color: var(--user-gold); font-weight: bold; }
        .h-price-col { text-align: right; display: flex; flex-direction: column; justify-content: center; padding-right: 5px;}
        .h-price { font-size: 0.8em; font-weight: bold; }
        .h-pct { font-size: 0.65em; }
        .text-up { color: #EF4444; }
        .text-down { color: #10B981; }
        
        .mini-chart-container { position: relative; width: 100%; height: 30px; cursor: crosshair; }
        .mini-chart-container:hover { background: rgba(255,255,255,0.08); box-shadow: 0 0 5px rgba(255,255,255,0.2); }
        canvas.sparkline { width: 100%; height: 100%; }

        /* --- Âä®ÊÄÅËØ¶ÊÉÖÂºπÁ™óÊ†∑Âºè --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 9999; justify-content: center; align-items: center;
            backdrop-filter: blur(12px);
        }
        .modal-content {
            background: #0a0a1a; border: 2px solid #444; width: 92%; max-width: 1100px;
            padding: 30px; border-radius: 12px; position: relative;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .close-btn { background: #222; border: 1px solid #555; color: #fff; font-family: 'Press Start 2P'; font-size: 10px; padding: 8px 15px; cursor: pointer; border-radius: 4px; }
        .close-btn:hover { border-color: #f00; color: #f00; background: #300; }
        .detail-chart-wrapper { height: 450px; width: 100%; position: relative; }

        /* --- ÂÖ∂‰ªñÊ®°ÂùóÊ†∑Âºè‰øùÊåÅ‰∏çÂèò --- */
        .commander-section { margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; }
        .cmd-row { margin-bottom: 8px; }
        .cmd-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .cmd-label { font-size: 0.6em; color: var(--glow-color); font-weight: bold; }
        .cmd-label-sell { color: var(--glow-color); }
        .calc-res { font-size: 0.6em; color: var(--user-gold); }
        .cmd-controls { display: flex; gap: 4px; width: 100%; align-items: center; }
        .cmd-input { background: #000; border: 1px solid #555; color: #fff; font-family: 'Roboto Mono'; padding: 4px; font-size: 0.7em; height: 26px; }
        .input-price { flex: 1; min-width: 0; }
        .input-weight { width: 60px; flex: 0 0 60px; color: var(--user-gold); text-align: center; }
        .cmd-btn { cursor: pointer; font-family: 'Press Start 2P'; font-size: 0.5em; padding: 0 8px; height: 26px; white-space: nowrap; flex: 0 0 auto; border: 1px solid #555; background: #222; color: #fff;}
        .cmd-btn.buy-btn { border-color: var(--glow-color); color: var(--glow-color); }
        .cmd-btn.sell-btn { border-color: var(--glow-color); color: var(--glow-color); }
        .cmd-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #444; color: #666; }
        .cmd-msg { height: 15px; font-size: 0.6em; margin-top: 2px; color: #ffff00; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;}
        .settlement-panel { width: 100%; max-width: 1400px; background: var(--panel-bg); border: 2px solid #555; padding: 20px; margin-bottom: 20px; display: none; }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .system-controls { margin-top: 10px; text-align: center; width: 100%; max-width: 800px; }
        .start-btn { background: #000; color: #0f0; border: 2px solid #0f0; padding: 15px 40px; font-family: 'Press Start 2P'; font-size: 1.2em; cursor: pointer; box-shadow: 0 0 10px #0f0; margin-bottom: 10px; }
        .log-box { background: #000; border: 1px solid #333; height: 100px; overflow-y: scroll; text-align: left; padding: 10px; font-size: 0.75em; color: #0f0; }
        .log-line { border-bottom: 1px solid #111; padding: 2px 0; }
        .oss-btn { position: absolute; right: 0; top: 20px; background: #224; color: #fff; border: 1px solid #66a; padding: 8px 12px; cursor: pointer; font-family: 'Press Start 2P'; font-size: 10px; display: flex; align-items: center; gap: 6px; border-radius: 4px; }
        .oss-status { width: 6px; height: 6px; border-radius: 50%; background: #666; display: inline-block;}
        .oss-status.syncing { background: #ff0; box-shadow: 0 0 5px #ff0; animation: blink 1s infinite; }
        .oss-status.done { background: #0f0; box-shadow: 0 0 5px #0f0; }
        @keyframes blink { 50% { opacity: 0.5; } }
        @media (max-width: 768px) { .header { position: static; padding-top: 10px; } .oss-btn { position: relative; right: auto; top: auto; margin-top: 15px; width: auto; } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Quant Guardians</h1>
        <div class="pixel-font" style="font-size: 0.7em; color: #666; margin-top:5px;">Real-time Battle System v2.0</div>
        <button class="oss-btn" onclick="syncToCloud()">
            <span class="oss-status" id="ossStatusDot"></span> SYNC CLOUD
        </button>
    </div>

    <!-- ÂÖ®Â±èÂä®ÊÄÅËØ¶ÊÉÖÂºπÁ™ó -->
    <div id="chartModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <span id="modalTitle" class="pixel-font" style="font-size:1.2em; color:var(--user-gold);">STOCK</span>
                    <span id="modalCode" style="color:#888; margin-left:10px; font-family:'Roboto Mono';">(--)</span>
                </div>
                <button class="close-btn" onclick="closeModal()">[X] CLOSE SYSTEM</button>
            </div>
            <div class="detail-chart-wrapper">
                <canvas id="detailChartCanvas"></canvas>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ÂõõÊñπÂÆàÊä§Á•ûÂç°Áâá -->
        <div class="guardian-card g-genbu" id="card-genbu">
            <div class="card-header"><div class="avatar">üõ°Ô∏è</div><div class="role-info"><h2 class="pixel-font">GENBU</h2><div class="role-desc">LowVol (‰ΩéÊ≥¢)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-genbu">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-genbu">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-genbu">0%</span></div>
            </div>
            <div class="list-header">STRATEGY SUGGESTIONS</div>
            <div class="holdings-list" id="list-genbu"></div>
            <div class="commander-section">
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label">Buy:</span><span class="calc-res" id="calc-buy-genbu"></span></div><div class="cmd-controls"><input type="number" class="cmd-input input-price" id="buy-price-genbu" oninput="calcQty('genbu', 'buy')"><input type="number" class="cmd-input input-weight" id="buy-weight-genbu" oninput="calcQty('genbu', 'buy')"><button class="cmd-btn buy-btn" onclick="executeOrder('genbu', 'buy')">CONFIRM</button></div></div>
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label cmd-label-sell">Sell:</span><span class="calc-res" id="calc-sell-genbu"></span></div><div class="cmd-controls"><input type="number" class="cmd-input input-price" id="sell-price-genbu" oninput="calcQty('genbu', 'sell')"><input type="number" class="cmd-input input-weight" id="sell-weight-genbu" oninput="calcQty('genbu', 'sell')"><button class="cmd-btn sell-btn" onclick="executeOrder('genbu', 'sell')">CONFIRM</button></div></div>
                <div class="cmd-msg" id="msg-genbu"></div>
            </div>
            <div class="list-header">PORTFOLIO</div>
            <div class="holdings-list portfolio-list" id="portfolio-genbu"></div>
        </div>

        <div class="guardian-card g-suzaku" id="card-suzaku">
            <div class="card-header"><div class="avatar">üî•</div><div class="role-info"><h2 class="pixel-font">SUZAKU</h2><div class="role-desc">DaCheng (Â§ßÊàê)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-suzaku">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-suzaku">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-suzaku">0%</span></div>
            </div>
            <div class="list-header">STRATEGY SUGGESTIONS</div>
            <div class="holdings-list" id="list-suzaku"></div>
            <div class="commander-section">
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label">Buy:</span><span class="calc-res" id="calc-buy-suzaku"></span></div><div class="cmd-controls"><input type="number" class="cmd-input input-price" id="buy-price-suzaku" oninput="calcQty('suzaku', 'buy')"><input type="number" class="cmd-input input-weight" id="buy-weight-suzaku" oninput="calcQty('suzaku', 'buy')"><button class="cmd-btn buy-btn" onclick="executeOrder('suzaku', 'buy')">CONFIRM</button></div></div>
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label cmd-label-sell">Sell:</span><span class="calc-res" id="calc-sell-suzaku"></span></div><div class="cmd-controls"><input type="number" class="cmd-input input-price" id="sell-price-suzaku" oninput="calcQty('suzaku', 'sell')"><input type="number" class="cmd-input input-weight" id="sell-weight-suzaku" oninput="calcQty('suzaku', 'sell')"><button class="cmd-btn sell-btn" onclick="executeOrder('suzaku', 'sell')">CONFIRM</button></div></div>
                <div class="cmd-msg" id="msg-suzaku"></div>
            </div>
            <div class="list-header">PORTFOLIO</div>
            <div class="holdings-list portfolio-list" id="portfolio-suzaku"></div>
        </div>

        <div class="guardian-card g-sirius" id="card-sirius">
            <div class="card-header"><div class="avatar">üê∫</div><div class="role-info"><h2 class="pixel-font">SIRIUS</h2><div class="role-desc">Inflow (ÊµÅÂÖ•)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-sirius">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-sirius">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-sirius">0%</span></div>
            </div>
            <div class="list-header">STRATEGY SUGGESTIONS</div>
            <div class="holdings-list" id="list-sirius"></div>
            <div class="commander-section">
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label">Buy:</span><span class="calc-res" id="calc-buy-sirius"></span></div><div class="cmd-controls"><input type="number" class="cmd-input input-price" id="buy-price-sirius" oninput="calcQty('sirius', 'buy')"><input type="number" class="cmd-input input-weight" id="buy-weight-sirius" oninput="calcQty('sirius', 'buy')"><button class="cmd-btn buy-btn" onclick="executeOrder('sirius', 'buy')">CONFIRM</button></div></div>
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label cmd-label-sell">Sell:</span><span class="calc-res" id="calc-sell-sirius"></span></div><div class="cmd-controls"><input type="number" class="cmd-input input-price" id="sell-price-sirius" oninput="calcQty('sirius', 'sell')"><input type="number" class="cmd-input input-weight" id="sell-weight-sirius" oninput="calcQty('sirius', 'sell')"><button class="cmd-btn sell-btn" onclick="executeOrder('sirius', 'sell')">CONFIRM</button></div></div>
                <div class="cmd-msg" id="msg-sirius"></div>
            </div>
            <div class="list-header">PORTFOLIO</div>
            <div class="holdings-list portfolio-list" id="portfolio-sirius"></div>
        </div>

        <div class="guardian-card g-kirin" id="card-kirin">
            <div class="card-header"><div class="avatar">ü¶Ñ</div><div class="role-info"><h2 class="pixel-font">KIRIN</h2><div class="role-desc">DaZhi (Â§ßÊô∫)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-kirin">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-kirin">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-kirin">0%</span></div>
            </div>
            <div class="list-header">STRATEGY SUGGESTIONS</div>
            <div class="holdings-list" id="list-kirin"></div>
            <div class="commander-section">
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label">Buy:</span><span class="calc-res" id="calc-buy-kirin"></span></div><div class="cmd-controls"><input type="number" class="cmd-input input-price" id="buy-price-kirin" oninput="calcQty('kirin', 'buy')"><input type="number" class="cmd-input input-weight" id="buy-weight-kirin" oninput="calcQty('kirin', 'buy')"><button class="cmd-btn buy-btn" onclick="executeOrder('kirin', 'buy')">CONFIRM</button></div></div>
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label cmd-label-sell">Sell:</span><span class="calc-res" id="calc-sell-kirin"></span></div><div class="cmd-controls"><input type="number" class="cmd-input input-price" id="sell-price-kirin" oninput="calcQty('kirin', 'sell')"><input type="number" class="cmd-input input-weight" id="sell-weight-kirin" oninput="calcQty('kirin', 'sell')"><button class="cmd-btn sell-btn" onclick="executeOrder('kirin', 'sell')">CONFIRM</button></div></div>
                <div class="cmd-msg" id="msg-kirin"></div>
            </div>
            <div class="list-header">PORTFOLIO</div>
            <div class="holdings-list portfolio-list" id="portfolio-kirin"></div>
        </div>
    </div>

    <div class="settlement-panel" id="settlementPanel"><div class="chart-wrapper"><canvas id="performanceChart"></canvas></div></div>
    <div class="system-controls"><button id="engageBtn" class="start-btn" onclick="initSystem()">[ ENGAGE SYSTEM ]</button><div class="log-box" id="systemLog"></div></div>

    <script>
        // ================= CONFIG & STATE =================
        const STS_API_URL = 'https://aiep-users.vercel.app/api/sts'; 
        const OSS_BUCKET = 'aiep-users'; 
        const OSS_REGION = 'oss-cn-hangzhou'; 
        const OSS_FILE_NAME = 'AIPEQuantGuardiansPortfolio.xlsx';
        const GITHUB_USER = 'digital-era';
        const GITHUB_REPO = 'AIPEQModel';
        const GITHUB_BRANCH = 'main';
        const REAL_API_URL = 'https://aipeinvestmentagent.pages.dev/api/rtStockQueryProxy';
        const SWEET_POINT_FILE = 'SweetPoint_New.json';

        const GUARDIAN_CONFIG = {
            genbu: { simpleName: "‰ΩéÊ≥¢", flowName: "‰ΩéÊ≥¢OR", file: '‰ΩéÊ≥¢Á®≥ÂÅ•Ê®°Âûã_New.json' },
            suzaku: { simpleName: "Â§ßÊàê", flowName: "Â§ßÊàêOR", file: 'Â§ßÊàêÊ®°Âûã_New.json' },
            sirius: { simpleName: "ÊµÅÂÖ•", flowName: "ÊµÅÂÖ•OR", file: 'ÊµÅÂÖ•Ê®°Âûã_New.json' },
            kirin: { simpleName: "Â§ßÊô∫", flowName: "Â§ßÊô∫OR", file: 'Â§ßÊô∫Ê®°Âûã_New.json' }
        };
        const HISTORY_FILES = {
            genbu: '‰ΩéÊ≥¢Á®≥ÂÅ•Ê®°Âûã‰ºòÂåñÂêéËØÑ‰º∞.json', suzaku: 'Â§ßÊàêÊ®°Âûã‰ºòÂåñÂêéËØÑ‰º∞.json',
            sirius: 'ÊµÅÂÖ•Ê®°Âûã‰ºòÂåñÂêéËØÑ‰º∞.json', kirin: 'Â§ßÊô∫Ê®°Âûã‰ºòÂåñÂêéËØÑ‰º∞.json'
        };

        let gameState = { active: false, guardians: { genbu: { strategy: [], portfolio: [], todayFlows: [], power: 0 }, suzaku: { strategy: [], portfolio: [], todayFlows: [], power: 0 }, sirius: { strategy: [], portfolio: [], todayFlows: [], power: 0 }, kirin: { strategy: [], portfolio: [], todayFlows: [], power: 0 } } };
        let memoryFlows = [], ossClient = null, perfChart = null, detailChart = null, playbackTimer = null, historyData = { dates: [], datasets: {} }, priceCache = {};

        // ================= LOGIC =================
        function log(msg, color="#0f0") { const box = document.getElementById('systemLog'); const div = document.createElement('div'); div.className = 'log-line'; div.innerHTML = `<span style="color:${color}">${msg}</span>`; box.prepend(div); }
        function getOpTime(c=false) { const n = new Date(); let h = n.getHours(), m = n.getMinutes(); if(c && (h>16||(h==16&&m>30))){ h=16; m=30; } return `${n.getFullYear()}${String(n.getMonth()+1).padStart(2,'0')}${String(n.getDate()).padStart(2,'0')}${String(h).padStart(2,'0')}${String(m).padStart(2,'0')}`; }

        // [Êñ∞Â¢û] ÂºπÂá∫ËØ¶ÊÉÖÂ§ßÂõæÈÄªËæë - Â∏¶È¢úËâ≤ÂêåÊ≠•‰∏éÂæ™ÁéØÊí≠Êîæ
        function openDetailChart(item, color) {
            if (!item.history || item.history.length === 0) return;
            document.getElementById('modalTitle').innerText = item.name;
            document.getElementById('modalCode').innerText = `(${item.code})`;
            document.getElementById('chartModal').style.display = 'flex';
            document.getElementById('chartModal').style.borderColor = color;

            const ctx = document.getElementById('detailChartCanvas').getContext('2d');
            if (detailChart) detailChart.destroy();
            if (playbackTimer) clearInterval(playbackTimer);

            // ÂàõÂª∫Ê∏êÂèòÂ°´ÂÖÖ
            const gradient = ctx.createLinearGradient(0, 0, 0, 450);
            gradient.addColorStop(0, color + '66');
            gradient.addColorStop(1, color + '00');

            // ÂàùÂßãÂåñÁ©∫ÁôΩÂõæË°®
            detailChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: color, borderWidth: 3, pointRadius: 0, fill: true, backgroundColor: gradient, tension: 0.3 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    animation: false, // Êàë‰ª¨ÊâãÂä®ÊéßÂà∂Êí≠Êîæ
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                    scales: { 
                        x: { display: false }, 
                        y: { grid: { color: '#222' }, ticks: { color: '#888', font: { family: 'Roboto Mono' } } } 
                    }
                }
            });

            // Âæ™ÁéØÊí≠ÊîæÈÄªËæë
            let step = 0;
            const fullData = item.history;
            const totalSteps = fullData.length;

            playbackTimer = setInterval(() => {
                step++;
                if (step > totalSteps + 20) { // Êí≠ÊîæÂÆåÊàêÂêéÂÅúÈ°ø20Â∏ßÂÜçÈáçÊù•
                    step = 0;
                }
                
                const currentData = fullData.slice(0, step);
                detailChart.data.labels = currentData.map((_, i) => i);
                detailChart.data.datasets[0].data = currentData;
                detailChart.update('none'); // ‰ΩøÁî® 'none' Ê®°ÂºèÂÆûÁé∞ÊûÅÈÄüÊ∏≤Êüì
            }, 30); // Á∫¶33FPS
        }

        function closeModal() {
            document.getElementById('chartModal').style.display = 'none';
            if (playbackTimer) clearInterval(playbackTimer);
        }

        async function initOSS() { if (ossClient) return true; try { const res = await fetch(STS_API_URL); const d = await res.json(); ossClient = new OSS({ region: OSS_REGION, accessKeyId: d.AccessKeyId, accessKeySecret: d.AccessKeySecret, stsToken: d.SecurityToken, bucket: OSS_BUCKET }); return true; } catch (e) { return false; } }

        async function loadStrategies() {
            const promises = Object.keys(GUARDIAN_CONFIG).map(async (key) => {
                const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${GUARDIAN_CONFIG[key].file}?t=${Date.now()}`;
                try {
                    const res = await fetch(url); const json = await res.json(); const data = json.ÁªìÊûú || json;
                    gameState.guardians[key].power = parseFloat(data.È£éÊéßÂõ†Â≠ê‰ø°ÊÅØ.ÁªºÂêàÂª∫ËÆÆ‰ªì‰ΩçÂõ†Â≠ê);
                    gameState.guardians[key].strategy = data.ÊúÄ‰ºòÊäïËµÑÁªÑÂêàÈÖçÁΩÆ.ÈÖçÁΩÆËØ¶ÊÉÖ.map(p => ({
                        name: p.ÂêçÁß∞, code: p.‰ª£Á†Å, refPrice: parseFloat(p.ÊúÄËøë‰∏ÄÊó•‰ª∑Ê†º),
                        weight: parseFloat(p["ÊúÄ‰ºòÊùÉÈáç(%)"]), currentPrice: null, history: [], isSweet: false
                    }));
                    document.getElementById(`power-${key}`).innerText = (gameState.guardians[key].power * 100).toFixed(0) + "%";
                } catch (e) { log(`${key} Err`, "red"); }
            });
            await Promise.all(promises);
        }

        async function loadSweetPoints() {
            try {
                const res = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${SWEET_POINT_FILE}?t=${Date.now()}`);
                const json = await res.json(); const sweetCodes = new Set(json.map(item => item.‰ª£Á†Å));
                for (let key in gameState.guardians) {
                    gameState.guardians[key].strategy.forEach(s => { if (sweetCodes.has(s.code)) s.isSweet = true; });
                }
            } catch (e) {}
        }

        async function loadCloudPortfolio() {
            if (!await initOSS()) return;
            try {
                const result = await ossClient.get(OSS_FILE_NAME); const wb = XLSX.read(result.content, { type: 'array' });
                const todayStr = getOpTime().substring(0, 8);
                for (let key in GUARDIAN_CONFIG) {
                    const cfg = GUARDIAN_CONFIG[key], g = gameState.guardians[key];
                    g.portfolio = []; g.todayFlows = [];
                    if (wb.Sheets[cfg.simpleName]) {
                        const raw = XLSX.utils.sheet_to_json(wb.Sheets[cfg.simpleName]);
                        let maxD = 0; raw.forEach(r => { const t = String(r['‰øÆÊîπÊó∂Èó¥']||''); if(t.length>=8) maxD = Math.max(maxD, parseInt(t.substring(0,8))); });
                        raw.forEach(r => { if(String(r['‰øÆÊîπÊó∂Èó¥']||'').startsWith(String(maxD)) && parseFloat(r['ÈÖçÁΩÆÊØî‰æã (%)'])>0) g.portfolio.push({ code: String(r['ËÇ°Á•®‰ª£Á†Å']), name: r['ËÇ°Á•®ÂêçÁß∞'], weight: parseFloat(r['ÈÖçÁΩÆÊØî‰æã (%)']), currentPrice: null, history: [] }); });
                    }
                    if (wb.Sheets[cfg.flowName]) {
                        XLSX.utils.sheet_to_json(wb.Sheets[cfg.flowName]).forEach(r => { if(String(r['‰øÆÊîπÊó∂Èó¥']||'').startsWith(todayStr)) g.todayFlows.push({ code: String(r['ËÇ°Á•®‰ª£Á†Å']), type: r['Êìç‰ΩúÁ±ªÂûã'], qty: parseFloat(r['Ê†áÁöÑÊï∞Èáè']), price: parseFloat(r['‰ª∑Ê†º']) }); });
                    }
                    updateCash(key);
                }
            } catch (e) {}
        }

        function updateCash(key) { const g = gameState.guardians[key]; g.portfolio = g.portfolio.filter(p => p.code !== '100000'); const sum = g.portfolio.reduce((s, p) => s + p.weight, 0); g.portfolio.push({ code: '100000', name: 'Áé∞Èáë', weight: Math.max(0, 100-sum), currentPrice: 1, history: [], isCash: true }); }

        async function updateMarketData() {
            for (let k in gameState.guardians) {
                const g = gameState.guardians[k]; let sysRtn = 0;
                for (let s of g.strategy) { await fetchPrice(s.code, s); if(s.currentPrice && s.refPrice) sysRtn += ((s.currentPrice-s.refPrice)/s.refPrice)*(s.weight/100); }
                document.getElementById(`rtn-${k}`).innerText = (sysRtn*100).toFixed(2) + "%";
                document.getElementById(`rtn-${k}`).className = sysRtn >= 0 ? "stat-value text-up" : "stat-value text-down";
                for (let p of g.portfolio) { if(!p.isCash) await fetchPrice(p.code, p); }
                const userRtn = calculateUserRtn(k); document.getElementById(`user-rtn-${k}`).innerText = userRtn.toFixed(2) + "%";
                document.getElementById(`user-rtn-${k}`).className = userRtn >= 0 ? "stat-value user-stat text-up" : "stat-value user-stat text-down";
                renderLists(k);
            }
        }

        function calculateUserRtn(k) {
            const g = gameState.guardians[k]; let pnl = 0;
            g.portfolio.forEach(p => { if(!p.isCash){ const cur = p.currentPrice||p.refPrice, ref = p.refPrice||cur; pnl += (Math.floor((100000*(p.weight/100))/cur)) * (cur-ref); } });
            const flows = [...g.todayFlows]; memoryFlows.forEach(m => { if(m.sheet === GUARDIAN_CONFIG[k].flowName) flows.push({ code: m.data['ËÇ°Á•®‰ª£Á†Å'], type: m.data['Êìç‰ΩúÁ±ªÂûã'], qty: parseFloat(m.data['Ê†áÁöÑÊï∞Èáè']), price: parseFloat(m.data['‰ª∑Ê†º']) }); });
            flows.forEach(f => { let ref = 0, ex = g.portfolio.find(p=>p.code===f.code); if(ex) ref=ex.refPrice; else if(priceCache[f.code]) ref=priceCache[f.code].refPrice; if(ref>0){ if(f.type==='Buy') pnl -= f.qty*(f.price-ref); else pnl += f.qty*(f.price-ref); } });
            return (pnl/100000)*100;
        }

        async function fetchPrice(c, o) { if(!c||c==='100000') return; try { const res = await fetch(`${REAL_API_URL}?code=${c}&type=intraday`); const d = await res.json(); if(d && d.length>0){ const cur = parseFloat(d[d.length-1].price), ref = parseFloat(d[0].price); if(o){ o.currentPrice = cur; o.history = d.map(x=>x.price); if(!o.refPrice) o.refPrice = ref; } priceCache[c] = { currentPrice: cur, refPrice: ref }; } } catch(e){} }

        function renderLists(key) {
            const g = gameState.guardians[key];
            [['list', g.strategy], ['portfolio', g.portfolio]].forEach(([id, data]) => {
                const el = document.getElementById(`${id}-${key}`); el.innerHTML = '';
                data.forEach((item, i) => {
                    const row = createRow(key, item, i, id);
                    if(id==='list'){ row.onclick=()=>selectStrategyItem(key,i); if(g.selectedBuy===i) row.classList.add('selected'); }
                    else { if(item.isCash) row.classList.add('is-cash'); else { row.onclick=()=>selectPortfolioItem(key,i); if(g.selectedSell===i) row.classList.add('selected'); } }
                    el.appendChild(row);
                });
            });
        }

        function createRow(key, item, idx, type) {
            const div = document.createElement('div'); div.className = 'holding-item';
            
            // [Êï¥ÂêàÂèåÂáªË∑≥ËΩ¨ÂäüËÉΩ]
            if (!item.isCash) {
                const stockUrl = `https://aipeinvestmentagent.pages.dev/PotScoreFundAnalytics?stock=${encodeURIComponent(item.name)}`;
                div.ondblclick = (e) => { e.stopPropagation(); window.open(stockUrl, '_blank'); };
            }

            const activeColor = item.currentPrice >= item.refPrice ? '#EF4444' : '#10B981';
            const nameHtml = (item.isSweet ? "üç¨ " : "") + item.name;
            const pHtml = item.currentPrice ? `<span class="h-price" style="color:${activeColor}">${item.currentPrice.toFixed(2)}</span><span class="h-pct" style="color:${activeColor}">${(((item.currentPrice-item.refPrice)/item.refPrice)*100).toFixed(2)}%</span>` : '--';
            const wHtml = `<span class="${type==='list'?'h-weight':'user-weight-display'}">[${item.weight.toFixed(2)}%]</span>`;

            div.innerHTML = `<div class="h-info"><span class="h-name">${nameHtml}</span><div class="h-weight-row">${wHtml}</div></div><div class="h-price-col">${pHtml}</div><div class="mini-chart-container" id="chart-cont-${key}-${type}-${idx}"><canvas id="cvs-${key}-${type}-${idx}" class="sparkline"></canvas></div>`;
            
            setTimeout(() => {
                const cont = document.getElementById(`chart-cont-${key}-${type}-${idx}`);
                if (cont) cont.onclick = (e) => { e.stopPropagation(); openDetailChart(item, activeColor); };
                if (item.history.length > 1) drawSpark(`cvs-${key}-${type}-${idx}`, item.history, item.refPrice, activeColor);
            }, 0);
            return div;
        }

        function drawSpark(id, data, base, color) { const cvs = document.getElementById(id); if(!cvs) return; const ctx = cvs.getContext('2d'), w = ctx.canvas.width = cvs.offsetWidth, h = ctx.canvas.height = cvs.offsetHeight; const min = Math.min(...data, base), max = Math.max(...data, base), r = max-min||1; ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath(); data.forEach((p, i) => { const x = (i/(data.length-1))*w, y = h-((p-min)/r)*h; i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y); }); ctx.stroke(); }

        function selectStrategyItem(k, i) { gameState.guardians[k].selectedBuy = i; const item = gameState.guardians[k].strategy[i]; document.getElementById(`buy-price-${k}`).value = item.currentPrice||item.refPrice; document.getElementById(`buy-weight-${k}`).value = item.weight.toFixed(2); renderLists(k); calcQty(k,'buy'); }
        function selectPortfolioItem(k, i) { const p = gameState.guardians[k].portfolio[i]; if(p.isCash) return; gameState.guardians[k].selectedSell = i; document.getElementById(`sell-price-${k}`).value = p.currentPrice||p.refPrice; document.getElementById(`sell-weight-${k}`).value = p.weight.toFixed(2); renderLists(k); calcQty(k,'sell'); }
        function calcQty(k, t) { const g = gameState.guardians[k], p = parseFloat(document.getElementById(`${t}-price-${k}`).value), w = parseFloat(document.getElementById(`${t}-weight-${k}`).value); if(p>0&&w>0) document.getElementById(`calc-${t}-${k}`).innerText = `Qty: ${Math.floor((100000*((t==='buy'?w*g.power:w)/100))/p)}`; else document.getElementById(`calc-${t}-${k}`).innerText = ''; }

        function executeOrder(k, t) {
            const g = gameState.guardians[k], p = parseFloat(document.getElementById(`${t}-price-${k}`).value), w = parseFloat(document.getElementById(`${t}-weight-${k}`).value);
            if(!p||!w) return;
            if(t==='buy'){
                const item = g.strategy[g.selectedBuy], inc = w*g.power;
                if(g.portfolio.reduce((s,x)=>s+x.weight,0)+inc > 100.1) return;
                let ex = g.portfolio.find(x=>x.code===item.code);
                if(ex){ ex.weight+=inc; ex.currentPrice=p; } else g.portfolio.unshift({ ...item, weight:inc, currentPrice:p });
                recordFlow(k,'Buy',item.code,item.name,w,p);
            } else {
                const item = g.portfolio[g.selectedSell]; if(w>item.weight+0.01) return;
                item.weight -= w; recordFlow(k,'Sell',item.code,item.name,w,p);
                if(item.weight<0.01) g.portfolio.splice(g.selectedSell,1);
            }
            updateCash(k); renderLists(k);
        }

        function recordFlow(k, op, c, n, w, p) { const actW = op==='Buy'?w*gameState.guardians[k].power:w, qty = Math.floor((100000*(actW/100))/p); memoryFlows.push({ sheet: GUARDIAN_CONFIG[k].flowName, data: { "ÁªÑÂêàÂêçÁß∞": GUARDIAN_CONFIG[k].simpleName, "ËÇ°Á•®‰ª£Á†Å": c, "ËÇ°Á•®ÂêçÁß∞": n, "ÈÖçÁΩÆÊØî‰æã (%)": actW.toFixed(2), "Ê†áÁöÑÊï∞Èáè": qty, "‰ª∑Ê†º": p, "‰ª∑ÂÄº": (qty*p).toFixed(2), "Êìç‰ΩúÁ±ªÂûã": op, "‰øÆÊîπÊó∂Èó¥": getOpTime(true) } }); }

        async function syncToCloud() {
            if(!await initOSS()) return; const dot = document.getElementById('ossStatusDot'); dot.className="oss-status syncing";
            try {
                let wb; try { const r = await ossClient.get(OSS_FILE_NAME); wb = XLSX.read(r.content,{type:'array'}); } catch(e){ wb = XLSX.utils.book_new(); }
                for (let k in GUARDIAN_CONFIG) {
                    const cfg = GUARDIAN_CONFIG[k], g = gameState.guardians[k];
                    let sD = []; if(wb.Sheets[cfg.simpleName]) sD = XLSX.utils.sheet_to_json(wb.Sheets[cfg.simpleName]);
                    g.portfolio.forEach(p => sD.push({ "ÁªÑÂêàÂêçÁß∞": cfg.simpleName, "ËÇ°Á•®‰ª£Á†Å": p.code, "ËÇ°Á•®ÂêçÁß∞": p.name, "Êù•Ê∫ê": "QuantGuardians", "ÈÖçÁΩÆÊØî‰æã (%)": p.weight.toFixed(2), "‰øÆÊîπÊó∂Èó¥": getOpTime(true) }));
                    wb.Sheets[cfg.simpleName] = XLSX.utils.json_to_sheet(sD);
                    let fD = []; if(wb.Sheets[cfg.flowName]) fD = XLSX.utils.sheet_to_json(wb.Sheets[cfg.flowName]);
                    memoryFlows.filter(f=>f.sheet===cfg.flowName).forEach(f=>fD.push(f.data));
                    wb.Sheets[cfg.flowName] = XLSX.utils.json_to_sheet(fD);
                }
                const out = XLSX.write(wb,{bookType:'xlsx',type:'array'}); await ossClient.put(OSS_FILE_NAME, new Blob([out]));
                dot.className="oss-status done"; memoryFlows=[]; await loadCloudPortfolio(); updateMarketData();
            } catch(e){ dot.className="oss-status"; }
        }

        async function initSystem() { if(gameState.active) return; const btn = document.getElementById('engageBtn'); btn.innerText = "INITIALIZING..."; await initOSS(); await Promise.all([loadStrategies(), loadSweetPoints()]); await loadCloudPortfolio(); await updateMarketData(); setInterval(updateMarketData, 60000); gameState.active=true; btn.innerText="SYSTEM ONLINE"; btn.style.boxShadow="0 0 20px #0f0"; }
    </script>
</body>
</html>
