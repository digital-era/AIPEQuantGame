<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈáèÂ≠êÊä§Âç´ÈòüÔºöÂõõÊñπÊàòÁ∫™ | Quant Guardians</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ‰øùÊåÅÂéüÊúâÊ†∑Âºè‰∏çÂèò --- */
        :root {
            --bg-color: #050510;
            --panel-bg: #111122;
            --text-main: #e0e0e0;
            --genbu-color: #10B981;
            --suzaku-color: #EF4444;
            --sirius-color: #8B5CF6;
            --kirin-color: #3B82F6;
            --user-gold: #FFD700;
        }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Roboto Mono', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1, .pixel-font { font-family: 'Press Start 2P', cursive; text-transform: uppercase; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; width: 100%; max-width: 1400px; }
        .container { max-width: 1400px; width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .guardian-card { background: var(--panel-bg); border: 2px solid #444; padding: 15px; border-radius: 4px; display: flex; flex-direction: column; transition: all 0.3s; box-shadow: 0 0 10px rgba(0,0,0,0.5); min-height: 600px; }
        .guardian-card.active { border-color: var(--glow-color); box-shadow: 0 0 20px var(--glow-color); }
        .g-genbu { --glow-color: var(--genbu-color); }
        .g-suzaku { --glow-color: var(--suzaku-color); }
        .g-sirius { --glow-color: var(--sirius-color); }
        .g-kirin { --glow-color: var(--kirin-color); }
        .card-header { display: flex; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        .avatar { font-size: 2.5em; margin-right: 15px; text-shadow: 0 0 10px var(--glow-color); }
        .role-info h2 { margin: 0; font-size: 1.2em; color: var(--glow-color); }
        .role-desc { font-size: 0.6em; color: #888; }
        .main-stat-box { background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; text-align: center; margin-bottom: 10px; }
        .stat-group { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; }
        .stat-label { font-size: 0.6em; color: #aaa; text-transform: uppercase; }
        .stat-value { font-size: 1.2em; font-weight: bold; color: #fff; }
        .user-stat { color: var(--user-gold); text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
        .sub-stat { font-size: 0.7em; color: #666; margin-top: 5px; border-top: 1px dashed #333; padding-top: 5px;}
        .holdings-list { flex-grow: 1; overflow-y: auto; border: 1px dashed #333; background: rgba(0,0,0,0.2); padding: 5px; height: 250px; }
        .holding-item { display: grid; grid-template-columns: 1.4fr 0.8fr 1fr; background: #1a1a2e; margin-bottom: 4px; padding: 8px 6px; border-left: 3px solid #444; cursor: pointer; transition: background 0.2s; align-items: center; }
        .holding-item:hover { background: #252540; }
        .holding-item.selected { background: #303050; border-left-color: #fff; }
        .holding-item.locked { border-left-color: var(--user-gold); background: #2a2a10; opacity: 1; /* Á°Æ‰øù‰∏çÈÄèÊòéÔºåÁúãÊ∏ÖÊï∞ÊçÆ */ } 
        .holding-item.locked .h-name { color: var(--user-gold); }
        .h-info { display: flex; flex-direction: column; }
        .h-name { font-weight: bold; font-size: 0.9em; color: #ddd; }
        .h-weight { font-size: 0.75em; color: #aaa; margin-top: 2px; }
        .h-price-col { text-align: right; display: flex; flex-direction: column; justify-content: center; padding-right: 5px;}
        .h-price { font-size: 0.85em; font-weight: bold; }
        .h-pct { font-size: 0.7em; }
        .text-up { color: #EF4444; }
        .text-down { color: #10B981; }
        .mini-chart-container { position: relative; width: 100%; height: 35px; }
        canvas.sparkline { width: 100%; height: 100%; }
        .commander-section { margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; }
        .cmd-label { font-size: 0.7em; color: var(--glow-color); margin-bottom: 5px; display: block; }
        .cmd-controls { display: flex; gap: 5px; }
        .cmd-input { background: #000; border: 1px solid #555; color: #fff; font-family: 'Roboto Mono'; padding: 5px; flex-grow: 1; font-size: 0.8em; }
        .cmd-input:disabled { background: #222; color: #ffd700; border-color: #ffd700; cursor: not-allowed; font-weight:bold;}
        .cmd-btn { background: #222; color: var(--glow-color); border: 1px solid var(--glow-color); cursor: pointer; font-family: 'Press Start 2P'; font-size: 0.6em; padding: 5px 10px; }
        .cmd-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .cmd-msg { height: 20px; font-size: 0.7em; margin-top: 5px; color: #ffff00; }
        .settlement-panel { width: 100%; max-width: 1400px; background: var(--panel-bg); border: 2px solid #555; padding: 20px; margin-bottom: 20px; display: none; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .settlement-header { text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; color: #fff; }
        .chart-wrapper { position: relative; height: 400px; width: 100%; }
        .system-controls { margin-top: 10px; text-align: center; width: 100%; max-width: 800px; }
        .start-btn { background: #000; color: #0f0; border: 2px solid #0f0; padding: 15px 40px; font-family: 'Press Start 2P'; font-size: 1.2em; cursor: pointer; box-shadow: 0 0 10px #0f0; margin-bottom: 10px; }
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        .log-box { background: #000; border: 1px solid #333; height: 100px; overflow-y: scroll; text-align: left; padding: 10px; font-size: 0.75em; color: #0f0; }
        .log-line { border-bottom: 1px solid #111; padding: 2px 0; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>
    <!-- HTML ÁªìÊûÑ‰øùÊåÅ‰∏çÂèò -->
    <div class="header">
        <h1>Quant Guardians</h1>
        <div class="pixel-font" style="font-size: 0.7em; color: #666; margin-top:5px;">Real-time Battle System // ÂõõÊñπÊàòÁ∫™ÂÆûÁõò</div>
    </div>
    <div class="container">
        <!-- 4Âº†Âç°ÁâáÁªìÊûÑÔºåID‰øùÊåÅ‰∏çÂèò -->
        <div class="guardian-card g-genbu" id="card-genbu">
            <div class="card-header"><div class="avatar">üõ°Ô∏è</div><div class="role-info"><h2 class="pixel-font">GENBU</h2><div class="role-desc">LowVol (‰ΩéÊ≥¢)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-genbu">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-genbu">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-genbu">0%</span></div>
            </div>
            <div class="holdings-list" id="list-genbu"></div>
            <div class="commander-section">
                <span class="cmd-label">COMMANDER:</span>
                <div class="cmd-controls"><input type="number" class="cmd-input" id="input-genbu" placeholder="Select Target"><button class="cmd-btn" id="btn-genbu" onclick="commanderAction('genbu')">CONFIRM</button></div>
                <div class="cmd-msg" id="msg-genbu"></div>
            </div>
        </div>
        <div class="guardian-card g-suzaku" id="card-suzaku">
            <div class="card-header"><div class="avatar">üî•</div><div class="role-info"><h2 class="pixel-font">SUZAKU</h2><div class="role-desc">DaCheng (Â§ßÊàê)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-suzaku">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-suzaku">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-suzaku">0%</span></div>
            </div>
            <div class="holdings-list" id="list-suzaku"></div>
            <div class="commander-section">
                <span class="cmd-label">COMMANDER:</span>
                <div class="cmd-controls"><input type="number" class="cmd-input" id="input-suzaku" placeholder="Select Target"><button class="cmd-btn" id="btn-suzaku" onclick="commanderAction('suzaku')">CONFIRM</button></div>
                <div class="cmd-msg" id="msg-suzaku"></div>
            </div>
        </div>
        <div class="guardian-card g-sirius" id="card-sirius">
            <div class="card-header"><div class="avatar">üê∫</div><div class="role-info"><h2 class="pixel-font">SIRIUS</h2><div class="role-desc">Inflow (ÊµÅÂÖ•)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-sirius">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-sirius">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-sirius">0%</span></div>
            </div>
            <div class="holdings-list" id="list-sirius"></div>
            <div class="commander-section">
                <span class="cmd-label">COMMANDER:</span>
                <div class="cmd-controls"><input type="number" class="cmd-input" id="input-sirius" placeholder="Select Target"><button class="cmd-btn" id="btn-sirius" onclick="commanderAction('sirius')">CONFIRM</button></div>
                <div class="cmd-msg" id="msg-sirius"></div>
            </div>
        </div>
        <div class="guardian-card g-kirin" id="card-kirin">
            <div class="card-header"><div class="avatar">ü¶Ñ</div><div class="role-info"><h2 class="pixel-font">KIRIN</h2><div class="role-desc">DaZhi (Â§ßÊô∫)</div></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-kirin">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-kirin">0.00%</span></div>
                <div class="sub-stat">Power: <span id="power-kirin">0%</span></div>
            </div>
            <div class="holdings-list" id="list-kirin"></div>
            <div class="commander-section">
                <span class="cmd-label">COMMANDER:</span>
                <div class="cmd-controls"><input type="number" class="cmd-input" id="input-kirin" placeholder="Select Target"><button class="cmd-btn" id="btn-kirin" onclick="commanderAction('kirin')">CONFIRM</button></div>
                <div class="cmd-msg" id="msg-kirin"></div>
            </div>
        </div>
    </div>

    <div class="settlement-panel" id="settlementPanel">
        <h3 class="settlement-header pixel-font">Historical Performance</h3>
        <div class="chart-wrapper"><canvas id="performanceChart"></canvas></div>
    </div>

    <div class="system-controls">
        <button id="engageBtn" class="start-btn" onclick="initSystem()">[ ENGAGE SYSTEM ]</button>
        <div class="log-box" id="systemLog"><div class="log-line">> System Standby...</div></div>
        <div style="color:#444; font-size:0.6em; margin-top:5px;">REFRESH: 5 MIN</div>
    </div>

    <script>
        const GITHUB_USER = 'digital-era';
        const GITHUB_REPO = 'AIPEQModel';
        const GITHUB_BRANCH = 'main';
        const REAL_API_URL = 'https://aipeinvestmentagent.pages.dev/api/rtStockQueryProxy';
        
        const GUARDIAN_FILES = {
            genbu: '‰ΩéÊ≥¢Á®≥ÂÅ•Ê®°Âûã_New.json', suzaku: 'Â§ßÊàêÊ®°Âûã_New.json', 
            sirius: 'ÊµÅÂÖ•Ê®°Âûã_New.json', kirin: 'Â§ßÊô∫Ê®°Âûã_New.json'
        };
        const HISTORY_FILES = {
            genbu: '‰ΩéÊ≥¢Á®≥ÂÅ•Ê®°Âûã‰ºòÂåñÂêéËØÑ‰º∞.json', suzaku: 'Â§ßÊàêÊ®°Âûã‰ºòÂåñÂêéËØÑ‰º∞.json',
            sirius: 'ÊµÅÂÖ•Ê®°Âûã‰ºòÂåñÂêéËØÑ‰º∞.json', kirin: 'Â§ßÊô∫Ê®°Âûã‰ºòÂåñÂêéËØÑ‰º∞.json'
        };

        let gameState = {
            active: false,
            guardians: {
                genbu: { holdings: [], power: 0, selectedIdx: -1 },
                suzaku: { holdings: [], power: 0, selectedIdx: -1 },
                sirius: { holdings: [], power: 0, selectedIdx: -1 },
                kirin: { holdings: [], power: 0, selectedIdx: -1 }
            }
        };
        let historyData = { dates: [], datasets: {} };
        let myChart = null;

        function log(msg, color="#0f0") {
            const box = document.getElementById('systemLog');
            const time = new Date().toLocaleTimeString('en-US', {hour12:false});
            const div = document.createElement('div');
            div.className = 'log-line';
            div.innerHTML = `<span style="color:#666">[${time}]</span> <span style="color:${color}">${msg}</span>`;
            box.prepend(div);
        }

        async function loadStrategies() {
            log("Loading Configs...", "cyan");
            const promises = Object.keys(GUARDIAN_FILES).map(async (key) => {
                const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${GUARDIAN_FILES[key]}?t=${Date.now()}`;
                try {
                    const res = await fetch(url);
                    if(!res.ok) throw new Error("Net Err");
                    const json = await res.json();
                    const data = json.ÁªìÊûú || json;
                    const portfolio = data.ÊúÄ‰ºòÊäïËµÑÁªÑÂêàÈÖçÁΩÆ.ÈÖçÁΩÆËØ¶ÊÉÖ;
                    const factor = parseFloat(data.È£éÊéßÂõ†Â≠ê‰ø°ÊÅØ.ÁªºÂêàÂª∫ËÆÆ‰ªì‰ΩçÂõ†Â≠ê);
                    
                    gameState.guardians[key].power = factor;
                    gameState.guardians[key].holdings = portfolio.map(p => {
                        let w = parseFloat(p["ÊúÄ‰ºòÊùÉÈáç(%)"]);
                        if (w > 1) w = w / 100;
                        return {
                            name: p.ÂêçÁß∞, code: p.‰ª£Á†Å,
                            refPrice: parseFloat(p.ÊúÄËøë‰∏ÄÊó•‰ª∑Ê†º),
                            weight: w,
                            currentPrice: null, history: [], changePct: 0,
                            isLocked: false, userPrice: null
                        };
                    });
                    document.getElementById(`power-${key}`).innerText = (factor * 100).toFixed(0) + "%";
                    renderList(key);
                } catch (e) { log(`[${key}] Err: ${e.message}`, "red"); }
            });
            await Promise.all(promises);
        }

        async function loadHistoryData() {
            const keys = Object.keys(HISTORY_FILES);
            const requests = keys.map(key => {
                 const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${HISTORY_FILES[key]}?t=${Date.now()}`;
                 return fetch(url).then(res => res.json()).catch(e => null);
            });
            const results = await Promise.all(requests);
            let allDatesSet = new Set();
            results.forEach(json => { if(json && json.ÊØèÊó•ËØÑ‰º∞Êï∞ÊçÆ) json.ÊØèÊó•ËØÑ‰º∞Êï∞ÊçÆ.forEach(item => allDatesSet.add(item.Êó•Êúü)); });
            historyData.dates = Array.from(allDatesSet).sort();
            results.forEach((json, index) => {
                const key = keys[index];
                if (json && json.ÊØèÊó•ËØÑ‰º∞Êï∞ÊçÆ) {
                    const dataMap = new Map();
                    json.ÊØèÊó•ËØÑ‰º∞Êï∞ÊçÆ.forEach(d => dataMap.set(d.Êó•Êúü, d.Á¥ØËÆ°Êî∂ÁõäÁéá * 100));
                    historyData.datasets[key] = historyData.dates.map(date => dataMap.has(date) ? dataMap.get(date) : null);
                } else historyData.datasets[key] = [];
            });
            renderHistoryChart();
        }

        function renderHistoryChart() {
            document.getElementById('settlementPanel').style.display = 'block';
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (myChart) myChart.destroy();
            const createDataset = (label, color, dataKey) => ({
                label: label, borderColor: color, backgroundColor: color + '1A',
                data: historyData.datasets[dataKey] || [], tension: 0.3, pointRadius: 0, borderWidth: 2, spanGaps: true
            });
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historyData.dates,
                    datasets: [
                        createDataset('GENBU', '#10B981', 'genbu'),
                        createDataset('SUZAKU', '#EF4444', 'suzaku'),
                        createDataset('SIRIUS', '#8B5CF6', 'sirius'),
                        createDataset('KIRIN', '#3B82F6', 'kirin')
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#ccc' } } },
                    scales: { y: { ticks: { color: '#666' }, grid: { color: '#333' } }, x: { ticks: { color: '#666', maxTicksLimit: 8 }, grid: { color: '#333' } } }
                }
            });
        }

        function renderList(key) {
            const listEl = document.getElementById(`list-${key}`);
            listEl.innerHTML = '';
            const g = gameState.guardians[key];
            g.holdings.forEach((stock, idx) => {
                const div = document.createElement('div');
                div.className = 'holding-item';
                if(stock.isLocked) div.classList.add('locked');
                div.id = `item-${key}-${idx}`;
                div.onclick = () => selectStock(key, idx);
                
                let nameHtml = stock.name;
                if(stock.isLocked) nameHtml = `üîí ${stock.name}`; 

                div.innerHTML = `
                    <div class="h-info">
                        <div class="h-name">${nameHtml} <span class="h-weight">[${(stock.weight*100).toFixed(1)}%]</span></div>
                    </div>
                    <div class="h-price-col" id="price-box-${key}-${idx}"><span class="h-price">--</span></div>
                    <div class="mini-chart-container"><canvas id="chart-${key}-${idx}" class="sparkline"></canvas></div>
                `;
                listEl.appendChild(div);
            });
        }

        function selectStock(key, idx) {
            const g = gameState.guardians[key];
            g.selectedIdx = idx;
            const listEl = document.getElementById(`list-${key}`);
            Array.from(listEl.children).forEach((child, i) => {
                if (i === idx) child.classList.add('selected');
                else child.classList.remove('selected');
            });

            const stock = g.holdings[idx];
            const input = document.getElementById(`input-${key}`);
            const btn = document.getElementById(`btn-${key}`);
            const msgEl = document.getElementById(`msg-${key}`);

            if (stock.isLocked) {
                input.value = stock.userPrice;
                input.disabled = true;
                btn.disabled = true;
                msgEl.innerText = "LOCKED: Sync Complete";
                msgEl.style.color = "#FFD700";
            } else {
                input.value = '';
                input.disabled = false;
                btn.disabled = false;
                input.placeholder = `Guess: ${stock.name}`;
                msgEl.innerText = "";
            }
        }

        function commanderAction(key) {
            const g = gameState.guardians[key];
            const msgEl = document.getElementById(`msg-${key}`);
            if (g.selectedIdx === -1) { msgEl.innerText = "Select Target"; msgEl.style.color = "red"; return; }
            
            const stock = g.holdings[g.selectedIdx];
            if (stock.isLocked) return; 

            const inputEl = document.getElementById(`input-${key}`);
            const guess = parseFloat(inputEl.value);
            if (!guess || !stock.currentPrice) { msgEl.innerText = "Waiting Data..."; return; }

            const current = stock.currentPrice;

            if (guess < current) {
                msgEl.innerText = `Too Low (Curr: ${current})`;
                msgEl.style.color = "#5af";
            } else {
                const diff = (guess - current) / current;
                if (diff < 0.01) {
                    msgEl.innerText = `>> PERFECT SYNC! LOCKED!`;
                    msgEl.style.color = "#FFD700";
                    
                    // 1. ÈîÅÂÆöÊ†áÁöÑ
                    stock.isLocked = true;
                    stock.userPrice = guess;

                    // 2. Êõ¥Êñ∞ User Rtn (ÂæóÂàÜÂõ∫ÂÆö)
                    calculateUserRtn(key);

                    // 3. UI ÈîÅÂÆöÂèçÈ¶à (ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂÖàÈáçÁΩÆDOMÔºåÁÑ∂ÂêéÁ´ãÂàªÊÅ¢Â§çÊï∞ÊçÆÊòæÁ§∫)
                    renderList(key); 
                    selectStock(key, g.selectedIdx); 
                    
                    // *‰øÆÂ§çÂÖ≥ÈîÆ*ÔºöÂõ†‰∏∫ renderList ÂàöÊâçÊ∏ÖÁ©∫‰∫Ü DOMÔºå
                    // Êàë‰ª¨ÂøÖÈ°ªÁ´ãÂàªÊääÂÜÖÂ≠òÈáåÁöÑ‰ª∑Ê†ºÂíåÂõæË°®ÁîªÂõûÂéªÔºåÂê¶Âàô‰ºöÊòæÁ§∫Á©∫ÁôΩÁõ¥Âà∞‰∏ã‰∏ÄÊ¨°APIÂà∑Êñ∞
                    restoreGroupUI(key);

                    // 4. ÁâπÊïà
                    const card = document.getElementById(`card-${key}`);
                    card.style.boxShadow = "0 0 30px #FFD700";
                    setTimeout(() => card.style.boxShadow = "", 800);

                } else {
                    msgEl.innerText = `Too High (Curr: ${current})`;
                    msgEl.style.color = "#f55";
                }
            }
        }

        // Êñ∞Â¢ûÔºöËæÖÂä©ÂáΩÊï∞ÔºåÁî®‰∫é renderList ÈáçÁΩÆ DOM ÂêéÁ´ãÂàªÊÅ¢Â§çÊï∞ÊçÆ
        function restoreGroupUI(key) {
            const g = gameState.guardians[key];
            g.holdings.forEach((stock, idx) => {
                if (stock.currentPrice !== null) {
                    const basePrice = parseFloat(stock.refPrice.toFixed(2));
                    updateRowUI(key, idx, stock, stock.changePct, basePrice);
                }
            });
        }

        function calculateUserRtn(key) {
            const g = gameState.guardians[key];
            let userTotalRtn = 0;
            g.holdings.forEach(stock => {
                if (stock.isLocked && stock.userPrice) {
                    const basePrice = parseFloat(stock.refPrice.toFixed(2));
                    const userReturn = (stock.userPrice - basePrice) / basePrice;
                    userTotalRtn += userReturn * stock.weight;
                }
            });
            const finalUserRtn = userTotalRtn * g.power;
            const el = document.getElementById(`user-rtn-${key}`);
            const sign = finalUserRtn > 0 ? "+" : "";
            el.innerText = sign + (finalUserRtn * 100).toFixed(2) + "%";
        }

        async function updateMarketData() {
            log("Scanning Market...", "#888");
            for (let key in gameState.guardians) {
                const g = gameState.guardians[key];
                let totalRtn = 0, valid = 0;
                
                const promises = g.holdings.map(async (stock, idx) => {
                    if (!stock.code) return;
                    try {
                        const target = `${REAL_API_URL}?code=${stock.code}&type=intraday&_t=${Date.now()}`;
                        const res = await fetch(target);
                        const data = await res.json();
                        
                        if (Array.isArray(data) && data.length > 0) {
                            const last = data[data.length - 1];
                            const price = parseFloat(parseFloat(last.price).toFixed(2));
                            stock.currentPrice = price;
                            stock.history = data.map(d => parseFloat(d.price));
                            
                            const base = parseFloat(stock.refPrice.toFixed(2));
                            const change = (price - base) / base;
                            stock.changePct = change;
                            totalRtn += change * stock.weight;
                            valid++;
                            updateRowUI(key, idx, stock, change, base);
                        }
                    } catch (e) { console.error(e); }
                });
                await Promise.all(promises);

                if (valid > 0) {
                    const finalRtn = totalRtn * g.power;
                    const el = document.getElementById(`rtn-${key}`);
                    el.innerText = (finalRtn > 0 ? "+" : "") + (finalRtn * 100).toFixed(2) + "%";
                    el.style.color = finalRtn >= 0 ? "#EF4444" : "#10B981";
                    
                    // Â¶ÇÊûúÊúâÊî∂Áõä‰∏îÊú™ÈîÅÂÆöÔºåÂàôÂèëÂÖâÔºõÈîÅÂÆöÂêé‰πüÂèØ‰ª•ÂèëÂÖâÔºåÊàñËÄÖÁî®ÈáëËâ≤Âå∫ÂàÜ
                    if(finalRtn > 0) document.getElementById(`card-${key}`).classList.add('active');
                    else document.getElementById(`card-${key}`).classList.remove('active');
                }
            }
            log("Data Stream Synced.", "#0f0");
        }

        function updateRowUI(key, idx, stock, change, base) {
            const el = document.getElementById(`price-box-${key}-${idx}`);
            const row = document.getElementById(`item-${key}-${idx}`);
            
            // ÈîÅÂÆöÁä∂ÊÄÅ‰∏ãÔºåËæπÊ°Ü‰øùÊåÅÈáëËâ≤Ôºå‰∏çÂÜçÈöèÊ∂®Ë∑åÂèòËâ≤
            if (stock.isLocked) {
                row.style.borderLeftColor = 'var(--user-gold)';
            } else {
                row.style.borderLeftColor = change >= 0 ? '#EF4444' : '#10B981';
            }
            
            const cls = change >= 0 ? 'text-up' : 'text-down';
            el.innerHTML = `<span class="h-price ${cls}">${stock.currentPrice.toFixed(2)}</span><span class="h-pct ${cls}">${change>0?'+':''}${(change*100).toFixed(2)}%</span>`;
            
            drawSpark(`chart-${key}-${idx}`, stock.history, base, change >= 0 ? '#EF4444' : '#10B981');
        }

        function drawSpark(id, data, base, color) {
            const ctx = document.getElementById(id).getContext('2d');
            const w = ctx.canvas.width = ctx.canvas.parentElement.offsetWidth;
            const h = ctx.canvas.height = ctx.canvas.parentElement.offsetHeight;
            if (data.length < 2) return;
            const min = Math.min(...data, base), max = Math.max(...data, base);
            const range = (max - min) || 0.01;
            const pad = range * 0.2;
            const effMin = min - pad, effRange = range + 2*pad;

            ctx.clearRect(0,0,w,h);
            const yBase = h - ((base - effMin) / effRange) * h;
            ctx.beginPath(); ctx.setLineDash([2,2]); ctx.strokeStyle="#444"; 
            ctx.moveTo(0, yBase); ctx.lineTo(w, yBase); ctx.stroke();
            ctx.beginPath(); ctx.setLineDash([]); ctx.strokeStyle=color; ctx.lineWidth=2;
            const step = w / (data.length - 1);
            data.forEach((p,i) => ctx[i?'lineTo':'moveTo'](i*step, h - ((p - effMin) / effRange) * h));
            ctx.stroke();
        }

        async function initSystem() {
            if (gameState.active) return;
            const btn = document.getElementById('engageBtn');
            btn.innerText = "INITIALIZING..."; btn.disabled = true;
            await Promise.all([loadStrategies(), loadHistoryData()]);
            await updateMarketData();
            setInterval(updateMarketData, 300000);
            gameState.active = true;
            btn.innerText = "SYSTEM ONLINE";
            btn.style.boxShadow = "0 0 20px #0f0";
        }
    </script>
</body>
</html>
