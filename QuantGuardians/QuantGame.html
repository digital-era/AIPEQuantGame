<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡å­æŠ¤å«é˜Ÿï¼šå®ç›˜ç›‘æ§ | Quant Guardians Live</title>
    <!-- å¼•å…¥ Chart.js (ç”¨äºå¤§å›¾) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥åƒç´ å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #050510;
            --panel-bg: #111122;
            --text-main: #e0e0e0;
            --terminal-green: #0f0;
            
            /* è§’è‰²è‰²è°ƒ */
            --genbu-color: #10B981;
            --suzaku-color: #EF4444;
            --sirius-color: #8B5CF6;
            --kirin-color: #3B82F6;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Roboto Mono', monospace;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2, h3, .pixel-font {
            font-family: 'Press Start 2P', cursive;
            text-transform: uppercase;
        }

        /* --- UI ç»„ä»¶ --- */
        .container {
            max-width: 1400px; /* åŠ å®½ä»¥å®¹çº³æ›´å¤šä¿¡æ¯ */
            width: 100%;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .header {
            text-align: center;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        /* --- æŠ¤å«é˜Ÿå¡ç‰‡ --- */
        .guardians-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* å¡ç‰‡å˜å®½ */
            gap: 15px;
        }

        .guardian-card {
            background: var(--panel-bg);
            border: 2px solid #444;
            padding: 15px;
            border-radius: 4px;
            position: relative;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 500px; /* å¢åŠ é«˜åº¦ */
        }

        .guardian-card.active {
            box-shadow: 0 0 15px var(--glow-color);
            border-color: var(--glow-color);
        }

        .g-genbu { --glow-color: var(--genbu-color); }
        .g-suzaku { --glow-color: var(--suzaku-color); }
        .g-sirius { --glow-color: var(--sirius-color); }
        .g-kirin { --glow-color: var(--kirin-color); }

        .avatar {
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 10px var(--glow-color);
        }

        .main-stat {
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid #333;
        }

        /* --- åˆ—è¡¨ä¸èµ°åŠ¿å›¾æ ·å¼æ›´æ–° --- */
        .holdings-list {
            font-size: 0.7em;
            flex-grow: 1;
            overflow-y: auto;
            border-top: 1px dashed #444;
            padding-top: 5px;
            margin-top: 10px;
            padding-right: 5px;
        }

        .holding-item {
            background: rgba(0, 0, 0, 0.2);
            margin-bottom: 6px;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #444;
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr; /* åç§° | ä»·æ ¼/æ¶¨è·Œ | å›¾è¡¨ */
            grid-template-rows: auto auto;
            gap: 5px;
            align-items: center;
        }

        .holding-item.up { border-left-color: #ef4444; }
        .holding-item.down { border-left-color: #10b981; } /* éµå¾ªçº¢æ¶¨ç»¿è·Œä¹ æƒ¯ï¼Œå¦‚éœ€åè½¬è¯·äº’æ¢ */

        .h-name { font-weight: bold; color: #fff; }
        .h-code { color: #666; font-size: 0.9em; }
        
        .h-price-box {
            text-align: right;
            display: flex;
            flex-direction: column;
        }
        .h-price { color: #eee; font-weight: bold;}
        .h-change { font-size: 0.9em; }
        .text-red { color: #ef4444; }
        .text-green { color: #10b981; }

        /* è¿·ä½ èµ°åŠ¿å›¾ Canvas */
        .mini-chart-container {
            width: 100%;
            height: 40px;
            position: relative;
        }
        canvas.sparkline {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .holdings-list::-webkit-scrollbar { width: 5px; }
        .holdings-list::-webkit-scrollbar-track { background: #000; }
        .holdings-list::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }

        /* --- æ§åˆ¶å° --- */
        .controls-area {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            background: #1a1a2e;
            border: 1px solid #333;
            position: sticky;
            bottom: 0;
            z-index: 100;
        }

        button.engage-btn {
            background: #000;
            color: var(--terminal-green);
            border: 2px solid var(--terminal-green);
            padding: 15px 40px;
            font-family: 'Press Start 2P';
            font-size: 1.2em;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 4px 4px 0 var(--terminal-green);
            transition: transform 0.1s;
        }
        
        button.engage-btn:hover { background: #002200; }
        button.engage-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 var(--terminal-green); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .log-console {
            height: 150px;
            overflow-y: scroll;
            background: #000;
            border: 1px solid #333;
            color: #0f0;
            font-size: 0.8em;
            padding: 10px;
            width: 100%;
            margin-top: 10px;
        }
        
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 2px; }
        
        .update-timer {
            color: #666;
            font-size: 0.7em;
            text-align: center;
            margin-top: 5px;
        }

    </style>
</head>
<body>

    <div class="header">
        <h1>Quant Guardians <span style="font-size:0.5em; vertical-align:middle; color:#ef4444;">[LIVE]</span></h1>
        <div class="pixel-font" style="color: #666; font-size: 0.8em;">Real-time Strategy Monitor // å®ç›˜ç›‘æ§ç³»ç»Ÿ</div>
    </div>

    <div class="container">
        
        <!-- æŠ¤å«é˜ŸåŒºåŸŸ -->
        <div class="guardians-grid">
            
            <!-- 01. ç„æ­¦ -->
            <div class="guardian-card g-genbu" id="card-genbu">
                <div class="avatar">ğŸ›¡ï¸</div>
                <div class="pixel-font" style="color:var(--genbu-color); text-align:center;">GENBU</div>
                <div style="text-align:center; font-size:0.7em;">ä½æ³¢ç¨³å¥ (LowVol)</div>
                <div class="main-stat">
                    Rtn: <span id="rtn-genbu">Wait...</span>
                </div>
                <div class="stats-row" style="text-align:center; font-size:0.8em; color:#888;">
                    ä»“ä½: <span id="power-genbu">0%</span>
                </div>
                <div class="holdings-list" id="list-genbu"></div>
            </div>

            <!-- 02. æœ±é›€ -->
            <div class="guardian-card g-suzaku" id="card-suzaku">
                <div class="avatar">ğŸ”¥</div>
                <div class="pixel-font" style="color:var(--suzaku-color); text-align:center;">SUZAKU</div>
                <div style="text-align:center; font-size:0.7em;">å¤§æˆä¼˜é€‰ (DaCheng)</div>
                <div class="main-stat">
                    Rtn: <span id="rtn-suzaku">Wait...</span>
                </div>
                <div class="stats-row" style="text-align:center; font-size:0.8em; color:#888;">
                    ä»“ä½: <span id="power-suzaku">0%</span>
                </div>
                <div class="holdings-list" id="list-suzaku"></div>
            </div>

            <!-- 03. å¤©ç‹¼ -->
            <div class="guardian-card g-sirius" id="card-sirius">
                <div class="avatar">ğŸº</div>
                <div class="pixel-font" style="color:var(--sirius-color); text-align:center;">SIRIUS</div>
                <div style="text-align:center; font-size:0.7em;">èµ„é‡‘æµå…¥ (Inflow)</div>
                <div class="main-stat">
                    Rtn: <span id="rtn-sirius">Wait...</span>
                </div>
                <div class="stats-row" style="text-align:center; font-size:0.8em; color:#888;">
                    ä»“ä½: <span id="power-sirius">0%</span>
                </div>
                <div class="holdings-list" id="list-sirius"></div>
            </div>

            <!-- 04. éº’éºŸ -->
            <div class="guardian-card g-kirin" id="card-kirin">
                <div class="avatar">ğŸ¦„</div>
                <div class="pixel-font" style="color:var(--kirin-color); text-align:center;">KIRIN</div>
                <div style="text-align:center; font-size:0.7em;">å¤§æ™ºæ ¸å¿ƒ (DaZhi)</div>
                <div class="main-stat">
                    Rtn: <span id="rtn-kirin">Wait...</span>
                </div>
                <div class="stats-row" style="text-align:center; font-size:0.8em; color:#888;">
                    ä»“ä½: <span id="power-kirin">0%</span>
                </div>
                <div class="holdings-list" id="list-kirin"></div>
            </div>
        </div>

        <!-- æ“æ§åŒº -->
        <div class="controls-area">
            <div>
                <button id="engageBtn" class="engage-btn" onclick="startSystem()">[ CONNECT API ]</button>
                <div class="update-timer" id="updateTimer">Status: Offline</div>
            </div>
        </div>

        <div class="log-console" id="gameLog">
            <div class="log-entry">> System Initialized. Ready to connect to market data feed.</div>
        </div>

    </div>

    <!-- JS é€»è¾‘ -->
    <script>
        // --- é…ç½® ---
        const GITHUB_USER = 'digital-era';
        const GITHUB_REPO = 'AIPEQModel';
        const GITHUB_BRANCH = 'main';
        const API_BASE = 'https://aipeinvestmentagent.pages.dev/api/rtStockQueryProxy';

        const GUARDIAN_FILES = {
            genbu: 'ä½æ³¢ç¨³å¥æ¨¡å‹_New.json',
            suzaku: 'å¤§æˆæ¨¡å‹_New.json', 
            sirius: 'æµå…¥æ¨¡å‹_New.json',
            kirin: 'å¤§æ™ºæ¨¡å‹_New.json'
        };

        let gameState = {
            active: false,
            guardians: {
                genbu: { name: 'ç„æ­¦', holdings: [], power: 0 },
                suzaku: { name: 'æœ±é›€', holdings: [], power: 0 },
                sirius: { name: 'å¤©ç‹¼', holdings: [], power: 0 },
                kirin: { name: 'éº’éºŸ', holdings: [], power: 0 }
            }
        };

        const LOG_ELEMENT = document.getElementById('gameLog');

        function addLog(msg, color = '#0f0') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span style="color:#666">[${time}]</span> <span style="color:${color}">${msg}</span>`;
            LOG_ELEMENT.prepend(div);
        }

        // --- 1. åˆå§‹åŒ–ï¼šåŠ è½½é…ç½®æ–‡ä»¶ ---
        async function loadConfigs() {
            addLog("Loading Strategy Configurations...", "cyan");
            
            const promises = Object.keys(GUARDIAN_FILES).map(async (key) => {
                const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${GUARDIAN_FILES[key]}?t=${Date.now()}`;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("Fetch Error");
                    const json = await res.json();
                    const data = json.ç»“æœ || json;
                    
                    const portfolio = data.æœ€ä¼˜æŠ•èµ„ç»„åˆé…ç½®.é…ç½®è¯¦æƒ…;
                    const factor = parseFloat(data.é£æ§å› å­ä¿¡æ¯.ç»¼åˆå»ºè®®ä»“ä½å› å­);

                    // è§£ææŒä»“ï¼Œä¿å­˜ ä»£ç ã€æ˜¨æ”¶ä»· (RefPrice)ã€æƒé‡
                    gameState.guardians[key].power = factor;
                    gameState.guardians[key].holdings = portfolio.map(p => ({
                        name: p.åç§°,
                        code: p.ä»£ç , // å‡è®¾JSONä¸­æœ‰ä»£ç å­—æ®µï¼Œå¦‚ 600519
                        refPrice: parseFloat(p.æœ€è¿‘ä¸€æ—¥ä»·æ ¼), // æ˜¨æ”¶ä»·
                        weight: parseFloat(p["æœ€ä¼˜æƒé‡(%)"]) / 100,
                        
                        // å®æ—¶æ•°æ®å®¹å™¨
                        currentPrice: null,
                        history: [] // å­˜æ”¾åˆ†é’Ÿçº¿ä»·æ ¼
                    }));

                    document.getElementById(`power-${key}`).innerText = (factor * 100).toFixed(0) + "%";
                    renderHoldingsStructure(key); // æ¸²æŸ“ç©ºåˆ—è¡¨ç»“æ„

                } catch (e) {
                    addLog(`Error loading ${key}: ${e.message}`, "red");
                }
            });

            await Promise.all(promises);
            addLog("Configuration Loaded. Waiting for API Connection...", "lime");
        }

        // --- 2. æ¸²æŸ“åˆ—è¡¨éª¨æ¶ ---
        function renderHoldingsStructure(key) {
            const listEl = document.getElementById(`list-${key}`);
            listEl.innerHTML = '';
            
            gameState.guardians[key].holdings.forEach((stock, idx) => {
                const div = document.createElement('div');
                div.className = 'holding-item';
                div.id = `item-${key}-${idx}`;
                
                div.innerHTML = `
                    <div>
                        <div class="h-name">${stock.name}</div>
                        <div class="h-code">${stock.code}</div>
                    </div>
                    <div class="h-price-box" id="price-box-${key}-${idx}">
                        <span class="h-price">--</span>
                        <span class="h-change">--%</span>
                    </div>
                    <div class="mini-chart-container">
                        <canvas id="chart-${key}-${idx}" class="sparkline"></canvas>
                    </div>
                `;
                listEl.appendChild(div);
            });
        }

        // --- 3. æ ¸å¿ƒï¼šè·å–å¹¶å¤„ç†å®æ—¶æ•°æ® ---
        async function fetchRealTimeData() {
            addLog("Fetching real-time market data...", "#aaa");
            const updateTimeStr = new Date().toLocaleTimeString();
            document.getElementById('updateTimer').innerText = `Last Update: ${updateTimeStr} (Refreshing in 5m)`;

            // éå†æ‰€æœ‰æŠ¤å«é˜Ÿ
            for (let key in gameState.guardians) {
                const guardian = gameState.guardians[key];
                let guardianTotalRtn = 0;
                let activeWeight = 0;

                // å¹¶è¡Œè·å–è¯¥ç­–ç•¥ä¸‹æ‰€æœ‰è‚¡ç¥¨çš„æ•°æ®
                const stockPromises = guardian.holdings.map(async (stock, idx) => {
                    if (!stock.code) return;

                    try {
                        const res = await fetch(`${API_BASE}?code=${stock.code}&type=intraday`);
                        const data = await res.json();

                        if (Array.isArray(data) && data.length > 0) {
                            // 1. è·å–æœ€æ–°ä»·æ ¼ (æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ )
                            const lastPoint = data[data.length - 1];
                            stock.currentPrice = parseFloat(lastPoint.price);
                            
                            // 2. æå–å†å²ä»·æ ¼ç”¨äºç”»å›¾
                            stock.history = data.map(d => parseFloat(d.price));

                            // 3. è®¡ç®—ä¸ªè‚¡æ¶¨è·Œå¹… (ç›¸å¯¹äºæ˜¨æ”¶ refPrice)
                            const changePct = (stock.currentPrice - stock.refPrice) / stock.refPrice;
                            
                            // 4. ç´¯åŠ ç­–ç•¥æ”¶ç›Š (ä¸ªè‚¡æ¶¨å¹… * æƒé‡)
                            // æ³¨æ„ï¼šè¿™é‡Œçš„æ”¶ç›Šæ˜¯åŸºäºæŒä»“éƒ¨åˆ†çš„ã€‚
                            guardianTotalRtn += changePct * stock.weight;
                            activeWeight += stock.weight;

                            // 5. æ›´æ–°å•è¡Œ UI
                            updateStockUI(key, idx, stock, changePct);
                        }
                    } catch (e) {
                        console.error(`Failed to fetch ${stock.name}`, e);
                    }
                });

                await Promise.all(stockPromises);

                // 6. æ›´æ–°æŠ¤å«é˜Ÿå¤§å¡ç‰‡çš„æ•°æ®
                // ç­–ç•¥æ€»æ”¶ç›Š = æŒä»“éƒ¨åˆ†æ”¶ç›Š * ä»“ä½å› å­ (å‡è®¾ç°é‡‘éƒ¨åˆ†æ”¶ç›Šä¸º0)
                // æˆ–è€…ç®€å•å¤„ç†ï¼šä»…æ˜¾ç¤ºæŒä»“ç»„åˆçš„åŠ æƒå¹³å‡æ”¶ç›Š
                
                // è¿™é‡Œé‡‡ç”¨ï¼šæ˜¾ç¤ºå®é™…ç­–ç•¥æ”¶ç›Š (æŒä»“æ”¶ç›Š * ä»“ä½ + ç°é‡‘0)
                // å¦‚æœåªçœ‹é€‰è‚¡èƒ½åŠ›ï¼Œå¯ä»¥ä¸ä¹˜ factorã€‚è¿™é‡Œä¸ºäº†æ‹ŸçœŸï¼Œä¹˜ä»¥ä»“ä½ã€‚
                const finalRtn = guardianTotalRtn * guardian.power; 
                
                const rtnEl = document.getElementById(`rtn-${key}`);
                rtnEl.innerText = (finalRtn * 100).toFixed(2) + "%";
                rtnEl.style.color = finalRtn >= 0 ? '#ef4444' : '#10b981';
                
                // è¾¹æ¡†å‘å…‰åé¦ˆ
                const card = document.getElementById(`card-${key}`);
                if (finalRtn > 0) card.style.borderColor = getComputedStyle(card).getPropertyValue('--glow-color');
                else card.style.borderColor = "#444";
            }
            
            addLog("Market Data Updated.", "lime");
        }

        // --- 4. æ›´æ–°å•è¡Œè‚¡ç¥¨ UI & ç»˜åˆ¶ Sparkline ---
        function updateStockUI(guardianKey, idx, stock, changePct) {
            const priceBox = document.getElementById(`price-box-${guardianKey}-${idx}`);
            const itemDiv = document.getElementById(`item-${guardianKey}-${idx}`);
            const chartId = `chart-${guardianKey}-${idx}`;
            
            const pctStr = (changePct * 100).toFixed(2) + "%";
            const colorClass = changePct >= 0 ? 'text-red' : 'text-green';
            const borderColor = changePct >= 0 ? '#ef4444' : '#10b981';

            // æ›´æ–°æ–‡æœ¬
            priceBox.innerHTML = `
                <span class="h-price ${colorClass}">${stock.currentPrice.toFixed(2)}</span>
                <span class="h-change ${colorClass}">${changePct > 0 ? '+' : ''}${pctStr}</span>
            `;
            
            // æ›´æ–°è¾¹æ¡†
            itemDiv.style.borderLeftColor = borderColor;

            // ç»˜åˆ¶ Sparkline
            drawSparkline(chartId, stock.history, stock.refPrice, borderColor);
        }

        function drawSparkline(canvasId, data, refPrice, color) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            // è®¾ç½®ç”»å¸ƒåˆ†è¾¨ç‡
            const width = canvas.parentElement.offsetWidth;
            const height = canvas.parentElement.offsetHeight;
            canvas.width = width;
            canvas.height = height;

            if (data.length < 2) return;

            const min = Math.min(...data, refPrice) * 0.998;
            const max = Math.max(...data, refPrice) * 1.002;
            const range = max - min;

            ctx.clearRect(0, 0, width, height);
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;

            // ç»˜åˆ¶è™šçº¿ï¼ˆæ˜¨æ—¥æ”¶ç›˜ä»·ï¼‰
            const yRef = height - ((refPrice - min) / range) * height;
            ctx.beginPath();
            ctx.setLineDash([2, 2]);
            ctx.strokeStyle = "#555";
            ctx.lineWidth = 1;
            ctx.moveTo(0, yRef);
            ctx.lineTo(width, yRef);
            ctx.stroke();

            // ç»˜åˆ¶å®çº¿ï¼ˆä»Šæ—¥èµ°åŠ¿ï¼‰
            ctx.beginPath();
            ctx.setLineDash([]);
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            
            const step = width / (data.length - 1);
            
            data.forEach((price, i) => {
                const x = i * step;
                const y = height - ((price - min) / range) * height; // Yè½´ç¿»è½¬ï¼ŒCanvasåŸç‚¹åœ¨å·¦ä¸Š
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            
            ctx.stroke();
        }

        // --- 5. ç³»ç»Ÿæ§åˆ¶ ---
        async function startSystem() {
            if (gameState.active) return;
            
            const btn = document.getElementById('engageBtn');
            btn.disabled = true;
            btn.innerText = "INITIALIZING...";

            // 1. åŠ è½½é…ç½®
            await loadConfigs();

            // 2. é¦–æ¬¡è·å–æ•°æ®
            await fetchRealTimeData();

            // 3. è®¾ç½®å®šæ—¶å™¨ (5åˆ†é’Ÿ = 300000ms)
            setInterval(fetchRealTimeData, 300000);

            gameState.active = true;
            btn.innerText = "SYSTEM ONLINE";
            addLog("Auto-refresh enabled (Interval: 5min).", "yellow");
        }

    </script>
</body>
</html>
