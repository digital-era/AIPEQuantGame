<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈáèÂ≠êÊä§Âç´ÈòüÔºöÂõõÊñπÊàòÁ∫™ | Quant Guardians</title>
    <!-- ÂºïÂÖ• Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ÂºïÂÖ• SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- ÂºïÂÖ• Ali-OSS SDK -->
    <script src="https://gosspublic.alicdn.com/aliyun-oss-sdk-6.18.0.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Âü∫Á°ÄÊ†∑Âºè --- */
        :root {
            --bg-color: #050510;
            --panel-bg: #111122;
            --text-main: #e0e0e0;
            --genbu-color: #10B981;
            --suzaku-color: #EF4444;
            --sirius-color: #8B5CF6;
            --kirin-color: #3B82F6;
            --user-gold: #FFD700;
        }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Roboto Mono', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1, .pixel-font { font-family: 'Press Start 2P', cursive; text-transform: uppercase; }
        
        .header { 
            text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; 
            width: 100%; max-width: 1400px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .container { max-width: 1400px; width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 20px; }
        
        /* --- Âç°ÁâáÊ†∑Âºè --- */
        .guardian-card { background: var(--panel-bg); border: 2px solid #444; padding: 15px; border-radius: 4px; display: flex; flex-direction: column; transition: all 0.3s; box-shadow: 0 0 10px rgba(0,0,0,0.5); min-height: 800px; }
        .g-genbu { --glow-color: var(--genbu-color); }
        .g-suzaku { --glow-color: var(--suzaku-color); }
        .g-sirius { --glow-color: var(--sirius-color); }
        .g-kirin { --glow-color: var(--kirin-color); }
        
        .card-header { display: flex; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        .avatar { font-size: 2.5em; margin-right: 15px; text-shadow: 0 0 10px var(--glow-color); }
        .role-info h2 { margin: 0; font-size: 1.2em; color: var(--glow-color); }
        
        .main-stat-box { background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; text-align: center; margin-bottom: 10px; }
        .stat-group { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; }
        .stat-label { font-size: 0.6em; color: #aaa; text-transform: uppercase; }
        .stat-value { font-size: 1.2em; font-weight: bold; color: #fff; }
        
        .user-stat { color: var(--user-gold); text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
        .sub-stat { font-size: 0.7em; color: #fff; margin-top: 5px; border-top: 1px dashed #333; padding-top: 5px; font-weight: bold;}
        
        .list-header { font-size: 0.6em; color: #888; margin-top: 5px; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; }
        .holdings-list { flex-grow: 1; overflow-y: auto; border: 1px dashed #333; background: rgba(0,0,0,0.2); padding: 5px; height: 200px; margin-bottom: 10px; }
        .portfolio-list { height: 200px; border: 1px solid #444; background: #000; }

        /* --- ÂàóË°®È°π --- */
        .holding-item { 
            display: grid; grid-template-columns: 1.4fr 0.8fr 1fr; 
            background: #1a1a2e; margin-bottom: 4px; padding: 6px; 
            border-left: 3px solid #444; cursor: pointer; transition: background 0.2s; 
            align-items: center; user-select: none; 
        }
        .holding-item:hover { background: #252540; }
        .holding-item.selected { background: #303050; border-left-color: #fff; }
        .holding-item.is-cash { border-left-color: var(--user-gold); background: #1a1a10; }

        .h-info { display: flex; flex-direction: column; justify-content: center; }
        .h-name { font-weight: bold; font-size: 0.8em; color: #ddd; display: block; margin-bottom: 2px;} 
        .h-weight { color: #aaa; margin-right: 8px; }
        .user-weight-display { color: var(--user-gold); font-weight: bold; }
        .h-price-col { text-align: right; display: flex; flex-direction: column; justify-content: center; padding-right: 5px;}
        .h-price { font-size: 0.8em; font-weight: bold; }
        .h-pct { font-size: 0.65em; }
        .text-up { color: #EF4444; }
        .text-down { color: #10B981; }
        
        .mini-chart-container { position: relative; width: 100%; height: 30px; cursor: crosshair; transition: all 0.2s; }
        .mini-chart-container:hover { background: rgba(255,255,255,0.1); box-shadow: 0 0 10px rgba(255,255,255,0.1); }
        canvas.sparkline { width: 100%; height: 100%; }

        /* --- Âä®ÊÄÅËØ¶ÊÉÖÂºπÁ™óÊ†∑Âºè --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 9999; justify-content: center; align-items: center;
            backdrop-filter: blur(15px);
        }
        .modal-content {
            background: #0a0a1a; border: 2px solid #444; width: 92%; max-width: 1100px;
            padding: 30px; border-radius: 12px; position: relative;
            box-shadow: 0 0 80px rgba(0,0,0,1); transition: border-color 0.5s;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .close-btn { background: #222; border: 1px solid #555; color: #fff; font-family: 'Press Start 2P'; font-size: 10px; padding: 10px 20px; cursor: pointer; border-radius: 4px; }
        .close-btn:hover { border-color: #f00; color: #f00; background: #300; }
        .detail-chart-wrapper { height: 450px; width: 100%; position: relative; }

        /* --- System Controls --- */
        .commander-section { margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; }
        .cmd-row { margin-bottom: 8px; }
        .cmd-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .cmd-label { font-size: 0.6em; color: var(--glow-color); font-weight: bold; }
        .cmd-controls { display: flex; gap: 4px; width: 100%; align-items: center; }
        .cmd-input { background: #000; border: 1px solid #555; color: #fff; font-family: 'Roboto Mono'; padding: 4px; font-size: 0.7em; height: 26px; }
        .cmd-btn { cursor: pointer; font-family: 'Press Start 2P'; font-size: 0.5em; padding: 0 8px; height: 26px; white-space: nowrap; flex: 0 0 auto; border: 1px solid #555; background: #222; color: #fff;}
        .cmd-msg { height: 15px; font-size: 0.6em; margin-top: 2px; color: #ffff00; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;}
        .system-controls { margin-top: 10px; text-align: center; width: 100%; max-width: 800px; }
        .start-btn { background: #000; color: #0f0; border: 2px solid #0f0; padding: 15px 40px; font-family: 'Press Start 2P'; font-size: 1.2em; cursor: pointer; box-shadow: 0 0 10px #0f0; margin-bottom: 10px; }
        .log-box { background: #000; border: 1px solid #333; height: 100px; overflow-y: scroll; text-align: left; padding: 10px; font-size: 0.75em; color: #0f0; }
        .oss-btn { position: absolute; right: 0; top: 20px; background: #224; color: #fff; border: 1px solid #66a; padding: 8px 12px; cursor: pointer; font-family: 'Press Start 2P'; font-size: 10px; border-radius: 4px; display: flex; align-items: center; gap: 5px;}
        .oss-status { width: 6px; height: 6px; border-radius: 50%; background: #666; display: inline-block;}
        .oss-status.syncing { background: #ff0; animation: blink 1s infinite; }
        .oss-status.done { background: #0f0; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>Quant Guardians</h1>
        <div class="pixel-font" style="font-size: 0.7em; color: #666; margin-top:5px;">Real-time Battle System v2.0</div>
        <button class="oss-btn" onclick="syncToCloud()"><span class="oss-status" id="ossStatusDot"></span> SYNC CLOUD</button>
    </div>

    <!-- ÂÖ®Â±èËØ¶ÊÉÖÂ§ßÂõæÂºπÁ™ó -->
    <div id="chartModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <span id="modalTitle" class="pixel-font" style="font-size:1.2em; color:var(--user-gold);">STOCK</span>
                    <span id="modalCode" style="color:#888; margin-left:10px; font-family:'Roboto Mono';">(--)</span>
                </div>
                <button class="close-btn" onclick="closeModal()">[X] CLOSE</button>
            </div>
            <div class="detail-chart-wrapper">
                <canvas id="detailChartCanvas"></canvas>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Âç°ÁâáÂÆπÂô® -->
        <div class="guardian-card g-genbu" id="card-genbu">
            <div class="card-header"><div class="avatar">üõ°Ô∏è</div><div class="role-info"><h2 class="pixel-font">GENBU</h2></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-genbu">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-genbu">0.00%</span></div>
            </div>
            <div class="list-header">STRATEGY SUGGESTIONS</div>
            <div class="holdings-list" id="list-genbu"></div>
            <div class="commander-section">
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label">Buy:</span><span class="calc-res" id="calc-buy-genbu"></span></div><div class="cmd-controls"><input type="number" class="cmd-input" id="buy-price-genbu" oninput="calcQty('genbu', 'buy')"><input type="number" class="cmd-input" id="buy-weight-genbu" oninput="calcQty('genbu', 'buy')"><button class="cmd-btn" onclick="executeOrder('genbu', 'buy')">CONFIRM</button></div></div>
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label">Sell:</span><span class="calc-res" id="calc-sell-genbu"></span></div><div class="cmd-controls"><input type="number" class="cmd-input" id="sell-price-genbu" oninput="calcQty('genbu', 'sell')"><input type="number" class="cmd-input" id="sell-weight-genbu" oninput="calcQty('genbu', 'sell')"><button class="cmd-btn" onclick="executeOrder('genbu', 'sell')">CONFIRM</button></div></div>
                <div class="cmd-msg" id="msg-genbu"></div>
            </div>
            <div class="list-header">PORTFOLIO</div>
            <div class="holdings-list portfolio-list" id="portfolio-genbu"></div>
        </div>
        <!-- ÂÖ∂‰ªñÊä§Âç´ÈòüÁÆÄÂåñÁâàÔºàÁªìÊûÑÂêå‰∏äÔºâ -->
        <div class="guardian-card g-suzaku" id="card-suzaku">
            <div class="card-header"><div class="avatar">üî•</div><div class="role-info"><h2 class="pixel-font">SUZAKU</h2></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-suzaku">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-suzaku">0.00%</span></div>
            </div>
            <div class="list-header">STRATEGY SUGGESTIONS</div>
            <div class="holdings-list" id="list-suzaku"></div>
            <div class="commander-section">
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label">Buy:</span><span class="calc-res" id="calc-buy-suzaku"></span></div><div class="cmd-controls"><input type="number" class="cmd-input" id="buy-price-suzaku" oninput="calcQty('suzaku', 'buy')"><input type="number" class="cmd-input" id="buy-weight-suzaku" oninput="calcQty('suzaku', 'buy')"><button class="cmd-btn" onclick="executeOrder('suzaku', 'buy')">CONFIRM</button></div></div>
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label">Sell:</span><span class="calc-res" id="calc-sell-suzaku"></span></div><div class="cmd-controls"><input type="number" class="cmd-input" id="sell-price-suzaku" oninput="calcQty('suzaku', 'sell')"><input type="number" class="cmd-input" id="sell-weight-suzaku" oninput="calcQty('suzaku', 'sell')"><button class="cmd-btn" onclick="executeOrder('suzaku', 'sell')">CONFIRM</button></div></div>
                <div class="cmd-msg" id="msg-suzaku"></div>
            </div>
            <div class="list-header">PORTFOLIO</div>
            <div class="holdings-list portfolio-list" id="portfolio-suzaku"></div>
        </div>
        <div class="guardian-card g-sirius" id="card-sirius">
            <div class="card-header"><div class="avatar">üê∫</div><div class="role-info"><h2 class="pixel-font">SIRIUS</h2></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-sirius">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-sirius">0.00%</span></div>
            </div>
            <div class="list-header">STRATEGY SUGGESTIONS</div>
            <div class="holdings-list" id="list-sirius"></div>
            <div class="commander-section">
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label">Buy:</span><span class="calc-res" id="calc-buy-sirius"></span></div><div class="cmd-controls"><input type="number" class="cmd-input" id="buy-price-sirius" oninput="calcQty('sirius', 'buy')"><input type="number" class="cmd-input" id="buy-weight-sirius" oninput="calcQty('sirius', 'buy')"><button class="cmd-btn" onclick="executeOrder('sirius', 'buy')">CONFIRM</button></div></div>
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label">Sell:</span><span class="calc-res" id="calc-sell-sirius"></span></div><div class="cmd-controls"><input type="number" class="cmd-input" id="sell-price-sirius" oninput="calcQty('sirius', 'sell')"><input type="number" class="cmd-input" id="sell-weight-sirius" oninput="calcQty('sirius', 'sell')"><button class="cmd-btn" onclick="executeOrder('sirius', 'sell')">CONFIRM</button></div></div>
                <div class="cmd-msg" id="msg-sirius"></div>
            </div>
            <div class="list-header">PORTFOLIO</div>
            <div class="holdings-list portfolio-list" id="portfolio-sirius"></div>
        </div>
        <div class="guardian-card g-kirin" id="card-kirin">
            <div class="card-header"><div class="avatar">ü¶Ñ</div><div class="role-info"><h2 class="pixel-font">KIRIN</h2></div></div>
            <div class="main-stat-box">
                <div class="stat-group"><span class="stat-label">System Rtn:</span><span class="stat-value" id="rtn-kirin">--.--%</span></div>
                <div class="stat-group"><span class="stat-label" style="color:#ffd700;">User Rtn:</span><span class="stat-value user-stat" id="user-rtn-kirin">0.00%</span></div>
            </div>
            <div class="list-header">STRATEGY SUGGESTIONS</div>
            <div class="holdings-list" id="list-kirin"></div>
            <div class="commander-section">
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label">Buy:</span><span class="calc-res" id="calc-buy-kirin"></span></div><div class="cmd-controls"><input type="number" class="cmd-input" id="buy-price-kirin" oninput="calcQty('kirin', 'buy')"><input type="number" class="cmd-input" id="buy-weight-kirin" oninput="calcQty('kirin', 'buy')"><button class="cmd-btn" onclick="executeOrder('kirin', 'buy')">CONFIRM</button></div></div>
                <div class="cmd-row"><div class="cmd-top-row"><span class="cmd-label">Sell:</span><span class="calc-res" id="calc-sell-kirin"></span></div><div class="cmd-controls"><input type="number" class="cmd-input" id="sell-price-kirin" oninput="calcQty('kirin', 'sell')"><input type="number" class="cmd-input" id="sell-weight-kirin" oninput="calcQty('kirin', 'sell')"><button class="cmd-btn" onclick="executeOrder('kirin', 'sell')">CONFIRM</button></div></div>
                <div class="cmd-msg" id="msg-kirin"></div>
            </div>
            <div class="list-header">PORTFOLIO</div>
            <div class="holdings-list portfolio-list" id="portfolio-kirin"></div>
        </div>
    </div>

    <div class="system-controls"><button id="engageBtn" class="start-btn" onclick="initSystem()">[ ENGAGE SYSTEM ]</button><div class="log-box" id="systemLog"></div></div>

    <script>
        // ================= CONFIG =================
        const STS_API_URL = 'https://aiep-users.vercel.app/api/sts'; 
        const OSS_BUCKET = 'aiep-users'; 
        const OSS_REGION = 'oss-cn-hangzhou'; 
        const OSS_FILE_NAME = 'AIPEQuantGuardiansPortfolio.xlsx';
        const GITHUB_USER = 'digital-era';
        const GITHUB_REPO = 'AIPEQModel';
        const GITHUB_BRANCH = 'main';
        const REAL_API_URL = 'https://aipeinvestmentagent.pages.dev/api/rtStockQueryProxy';
        const SWEET_POINT_FILE = 'SweetPoint_New.json';

        const GUARDIAN_CONFIG = {
            genbu: { simpleName: "‰ΩéÊ≥¢", flowName: "‰ΩéÊ≥¢OR", file: '‰ΩéÊ≥¢Á®≥ÂÅ•Ê®°Âûã_New.json' },
            suzaku: { simpleName: "Â§ßÊàê", flowName: "Â§ßÊàêOR", file: 'Â§ßÊàêÊ®°Âûã_New.json' },
            sirius: { simpleName: "ÊµÅÂÖ•", flowName: "ÊµÅÂÖ•OR", file: 'ÊµÅÂÖ•Ê®°Âûã_New.json' },
            kirin: { simpleName: "Â§ßÊô∫", flowName: "Â§ßÊô∫OR", file: 'Â§ßÊô∫Ê®°Âûã_New.json' }
        };

        // ================= STATE =================
        let gameState = { active: false, guardians: { genbu: { strategy: [], portfolio: [], todayFlows: [], power: 0 }, suzaku: { strategy: [], portfolio: [], todayFlows: [], power: 0 }, sirius: { strategy: [], portfolio: [], todayFlows: [], power: 0 }, kirin: { strategy: [], portfolio: [], todayFlows: [], power: 0 } } };
        let memoryFlows = [], ossClient = null, detailChart = null, playbackTimer = null, priceCache = {};

        // ================= CORE FUNCTIONS =================
        function log(msg, color="#0f0") { const box = document.getElementById('systemLog'); const div = document.createElement('div'); div.innerHTML = `<span style="color:${color}">${msg}</span>`; box.prepend(div); }
        function getOpTime(c=false) { const n = new Date(); let h = n.getHours(), m = n.getMinutes(); if(c && (h>16||(h==16&&m>30))){ h=16; m=30; } return `${n.getFullYear()}${String(n.getMonth()+1).padStart(2,'0')}${String(n.getDate()).padStart(2,'0')}${String(h).padStart(2,'0')}${String(m).padStart(2,'0')}`; }

        // [‰ºòÂåñ] ÂºπÂá∫ËØ¶ÊÉÖÂ§ßÂõæÈÄªËæë - ‰ªéÂ∑¶ÂêëÂè≥ÁîüÈïø & È¢úËâ≤ÂêåÊ≠•
        function openDetailChart(item, color) {
            if (!item.history || item.history.length === 0) return;
            
            document.getElementById('modalTitle').innerText = item.name;
            document.getElementById('modalCode').innerText = `(${item.code})`;
            document.getElementById('chartModal').style.display = 'flex';
            document.querySelector('.modal-content').style.borderColor = color;

            const ctx = document.getElementById('detailChartCanvas').getContext('2d');
            if (detailChart) detailChart.destroy();
            if (playbackTimer) clearInterval(playbackTimer);

            const gradient = ctx.createLinearGradient(0, 0, 0, 450);
            gradient.addColorStop(0, color + '55'); // È°∂ÈÉ®ÂçäÈÄèÊòé
            gradient.addColorStop(1, color + '00'); // Â∫ïÈÉ®ÂÖ®ÈÄèÊòé

            // È¢ÑÂÖàÂª∫Á´ãÂ•ΩÂÆåÊï¥ÁöÑÊó∂Èó¥ËΩ¥ÈïøÂ∫¶ÔºåÈò≤Ê≠¢ÁîüÈïøÊó∂ÂùêÊ†áËΩ¥ÊäñÂä®
            const fullHistory = item.history;
            const labels = fullHistory.map((_, i) => i);

            detailChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels, 
                    datasets: [{
                        data: [], // ÂàùÂßã‰∏∫Á©∫
                        borderColor: color,
                        borderWidth: 3,
                        pointRadius: 0,
                        fill: true,
                        backgroundColor: gradient,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    animation: false, // Êàë‰ª¨ÈÄöËøáÂÆöÊó∂Âô®ÊâãÂä®ÊéßÂà∂
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                    scales: { 
                        x: { display: false }, 
                        y: { grid: { color: '#222' }, ticks: { color: '#888' } } 
                    }
                }
            });

            // ‰ªéÂ∑¶ÂêëÂè≥Âæ™ÁéØÊí≠ÊîæÈÄªËæë
            let step = 0;
            const totalSteps = fullHistory.length;

            playbackTimer = setInterval(() => {
                step++;
                if (step > totalSteps + 15) { // ÂÅúÁïô15Â∏ßÂÜçÈáçÁΩÆ
                    step = 0;
                }
                
                // ‰ªÖÂ°´ÂÖ•ÂΩìÂâçÊ≠•Êï∞‰πãÂâçÁöÑÊï∞ÊçÆ
                const currentDisplayData = fullHistory.slice(0, step);
                
                detailChart.data.datasets[0].data = currentDisplayData;
                detailChart.update('none'); // 'none' Ê®°ÂºèÊèê‰æõÊúÄÊµÅÁïÖÁöÑÈÄêÂ∏ßÊ∏≤Êüì
            }, 25); // Á∫¶40FPSÔºåÈùûÂ∏∏ÊµÅÁïÖ
        }

        function closeModal() {
            document.getElementById('chartModal').style.display = 'none';
            if (playbackTimer) clearInterval(playbackTimer);
        }

        async function initOSS() { if (ossClient) return true; try { const res = await fetch(STS_API_URL); const d = await res.json(); ossClient = new OSS({ region: OSS_REGION, accessKeyId: d.AccessKeyId, accessKeySecret: d.AccessKeySecret, stsToken: d.SecurityToken, bucket: OSS_BUCKET }); return true; } catch (e) { return false; } }

        async function loadStrategies() {
            const promises = Object.keys(GUARDIAN_CONFIG).map(async (key) => {
                const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${GUARDIAN_CONFIG[key].file}?t=${Date.now()}`;
                try {
                    const res = await fetch(url); const json = await res.json(); const data = json.ÁªìÊûú || json;
                    gameState.guardians[key].power = parseFloat(data.È£éÊéßÂõ†Â≠ê‰ø°ÊÅØ.ÁªºÂêàÂª∫ËÆÆ‰ªì‰ΩçÂõ†Â≠ê);
                    gameState.guardians[key].strategy = data.ÊúÄ‰ºòÊäïËµÑÁªÑÂêàÈÖçÁΩÆ.ÈÖçÁΩÆËØ¶ÊÉÖ.map(p => ({
                        name: p.ÂêçÁß∞, code: p.‰ª£Á†Å, refPrice: parseFloat(p.ÊúÄËøë‰∏ÄÊó•‰ª∑Ê†º),
                        weight: parseFloat(p["ÊúÄ‰ºòÊùÉÈáç(%)"]), currentPrice: null, history: [], isSweet: false
                    }));
                } catch (e) {}
            });
            await Promise.all(promises);
        }

        async function loadSweetPoints() {
            try {
                const res = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${SWEET_POINT_FILE}?t=${Date.now()}`);
                const json = await res.json(); const sweetCodes = new Set(json.map(item => item.‰ª£Á†Å));
                for (let key in gameState.guardians) {
                    gameState.guardians[key].strategy.forEach(s => { if (sweetCodes.has(s.code)) s.isSweet = true; });
                }
            } catch (e) {}
        }

        async function loadCloudPortfolio() {
            if (!await initOSS()) return;
            try {
                const result = await ossClient.get(OSS_FILE_NAME); const wb = XLSX.read(result.content, { type: 'array' });
                for (let key in GUARDIAN_CONFIG) {
                    const cfg = GUARDIAN_CONFIG[key], g = gameState.guardians[key];
                    if (wb.Sheets[cfg.simpleName]) {
                        const raw = XLSX.utils.sheet_to_json(wb.Sheets[cfg.simpleName]);
                        let maxD = 0; raw.forEach(r => { const t = String(r['‰øÆÊîπÊó∂Èó¥']||''); if(t.length>=8) maxD = Math.max(maxD, parseInt(t.substring(0,8))); });
                        raw.forEach(r => { if(String(r['‰øÆÊîπÊó∂Èó¥']||'').startsWith(String(maxD)) && parseFloat(r['ÈÖçÁΩÆÊØî‰æã (%)'])>0) g.portfolio.push({ code: String(r['ËÇ°Á•®‰ª£Á†Å']), name: r['ËÇ°Á•®ÂêçÁß∞'], weight: parseFloat(r['ÈÖçÁΩÆÊØî‰æã (%)']), currentPrice: null, history: [] }); });
                    }
                    updateCash(key);
                }
            } catch (e) {}
        }

        function updateCash(key) { const g = gameState.guardians[key]; g.portfolio = g.portfolio.filter(p => p.code !== '100000'); const sum = g.portfolio.reduce((s, p) => s + p.weight, 0); g.portfolio.push({ code: '100000', name: 'Áé∞Èáë', weight: Math.max(0, 100-sum), currentPrice: 1, history: [], isCash: true }); }

        async function updateMarketData() {
            for (let k in gameState.guardians) {
                const g = gameState.guardians[k]; let sysRtn = 0;
                for (let s of g.strategy) { await fetchPrice(s.code, s); if(s.currentPrice && s.refPrice) sysRtn += ((s.currentPrice-s.refPrice)/s.refPrice)*(s.weight/100); }
                document.getElementById(`rtn-${k}`).innerText = (sysRtn*100).toFixed(2) + "%";
                document.getElementById(`rtn-${k}`).className = sysRtn >= 0 ? "stat-value text-up" : "stat-value text-down";
                for (let p of g.portfolio) if(!p.isCash) await fetchPrice(p.code, p);
                renderLists(k);
            }
        }

        async function fetchPrice(c, o) { if(!c||c==='100000') return; try { const res = await fetch(`${REAL_API_URL}?code=${c}&type=intraday`); const d = await res.json(); if(d && d.length>0){ const cur = parseFloat(d[d.length-1].price), ref = parseFloat(d[0].price); if(o){ o.currentPrice = cur; o.history = d.map(x=>x.price); if(!o.refPrice) o.refPrice = ref; } priceCache[c] = { currentPrice: cur, refPrice: ref }; } } catch(e){} }

        function renderLists(key) {
            const g = gameState.guardians[key];
            [['list', g.strategy], ['portfolio', g.portfolio]].forEach(([id, data]) => {
                const el = document.getElementById(`${id}-${key}`); el.innerHTML = '';
                data.forEach((item, i) => {
                    const row = createRow(key, item, i, id);
                    if(id==='list') row.onclick=()=>selectStrategyItem(key,i);
                    else if(!item.isCash) row.onclick=()=>selectPortfolioItem(key,i);
                    el.appendChild(row);
                });
            });
        }

        function createRow(key, item, idx, type) {
            const div = document.createElement('div'); div.className = 'holding-item';
            if (!item.isCash) {
                const stockUrl = `https://aipeinvestmentagent.pages.dev/PotScoreFundAnalytics?stock=${encodeURIComponent(item.name)}`;
                div.ondblclick = (e) => { e.stopPropagation(); window.open(stockUrl, '_blank'); };
            }
            const activeColor = item.currentPrice >= item.refPrice ? '#EF4444' : '#10B981';
            const nameHtml = (item.isSweet ? "üç¨ " : "") + item.name;
            const pHtml = item.currentPrice ? `<span class="h-price" style="color:${activeColor}">${item.currentPrice.toFixed(2)}</span><span class="h-pct" style="color:${activeColor}">${(((item.currentPrice-item.refPrice)/item.refPrice)*100).toFixed(2)}%</span>` : '--';
            
            div.innerHTML = `<div class="h-info"><span class="h-name">${nameHtml}</span><div>[${item.weight.toFixed(2)}%]</div></div><div class="h-price-col">${pHtml}</div><div class="mini-chart-container" id="cont-${key}-${type}-${idx}"><canvas id="cvs-${key}-${type}-${idx}" class="sparkline"></canvas></div>`;
            
            setTimeout(() => {
                const cont = document.getElementById(`cont-${key}-${type}-${idx}`);
                if (cont) cont.onclick = (e) => { e.stopPropagation(); openDetailChart(item, activeColor); };
                if (item.history.length > 1) drawSpark(`cvs-${key}-${type}-${idx}`, item.history, item.refPrice, activeColor);
            }, 0);
            return div;
        }

        function drawSpark(id, data, base, color) { const cvs = document.getElementById(id); if(!cvs) return; const ctx = cvs.getContext('2d'), w = ctx.canvas.width = cvs.offsetWidth, h = ctx.canvas.height = cvs.offsetHeight; const min = Math.min(...data, base), max = Math.max(...data, base), r = max-min||1; ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath(); data.forEach((p, i) => { const x = (i/(data.length-1))*w, y = h-((p-min)/r)*h; i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y); }); ctx.stroke(); }

        function selectStrategyItem(k, i) { const item = gameState.guardians[k].strategy[i]; document.getElementById(`buy-price-${k}`).value = item.currentPrice||item.refPrice; document.getElementById(`buy-weight-${k}`).value = item.weight.toFixed(2); }
        function selectPortfolioItem(k, i) { const p = gameState.guardians[k].portfolio[i]; document.getElementById(`sell-price-${k}`).value = p.currentPrice||p.refPrice; document.getElementById(`sell-weight-${k}`).value = p.weight.toFixed(2); }
        function calcQty(k, t) { const p = parseFloat(document.getElementById(`${t}-price-${k}`).value), w = parseFloat(document.getElementById(`${t}-weight-${k}`).value); if(p>0&&w>0) document.getElementById(`calc-${t}-${k}`).innerText = `Qty: ${Math.floor((100000*(w/100))/p)}`; else document.getElementById(`calc-${t}-${k}`).innerText = ''; }

        async function initSystem() { if(gameState.active) return; const btn = document.getElementById('engageBtn'); btn.innerText = "INITIALIZING..."; await initOSS(); await Promise.all([loadStrategies(), loadSweetPoints()]); await loadCloudPortfolio(); await updateMarketData(); setInterval(updateMarketData, 60000); gameState.active=true; btn.innerText="SYSTEM ONLINE"; }
    </script>
</body>
</html>
